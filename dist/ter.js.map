{"version":3,"file":"ter.js","mappings":"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","sources":["webpack://ter/webpack/universalModuleDefinition","webpack://ter/./src/bodies/Bodies.js","webpack://ter/./src/bodies/Rectangle.js","webpack://ter/./src/core/Common.js","webpack://ter/./src/core/Game.js","webpack://ter/./src/core/Performance.js","webpack://ter/./src/core/Ticker.js","webpack://ter/./src/extra/BehaviorTree.js","webpack://ter/./src/extra/GameFunctions.js","webpack://ter/./src/geometry/Bezier.js","webpack://ter/./src/geometry/Bounds.js","webpack://ter/./src/geometry/Grid.js","webpack://ter/./src/geometry/vec.js","webpack://ter/./src/lib/poly-decomp.js","webpack://ter/./src/lib/simplexNoise.js","webpack://ter/./src/node/Node.js","webpack://ter/./src/node/World.js","webpack://ter/./src/physics/Engine.js","webpack://ter/./src/physics/RigidBody.js","webpack://ter/./src/render/Camera.js","webpack://ter/./src/render/DebugRender.js","webpack://ter/./src/render/PerformanceRender.js","webpack://ter/./src/render/PolygonRender.js","webpack://ter/./src/render/Render.js","webpack://ter/./src/render/RenderMethods.js","webpack://ter/./src/render/RenderTypes.js","webpack://ter/./src/render/Sprite.js","webpack://ter/./src/ter.js","webpack://ter/webpack/bootstrap","webpack://ter/webpack/startup"],"sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine(\"ter\", [], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"ter\"] = factory();\n\telse\n\t\troot[\"ter\"] = factory();\n})(self, () => {\nreturn ","const Bodies = module.exports;\r\nconst { isClass } = require(\"../core/Common.js\");\r\n\r\nBodies.RigidBody = require(\"../physics/RigidBody.js\");\r\nBodies.Rectangle = require(\"../bodies/Rectangle.js\");\r\n\r\nBodies.createBodyFactory = function(Engine) {\r\n\tlet factory = {};\r\n\tfor (let type in Bodies) {\r\n\t\tif (isClass(Bodies[type])) {\r\n\t\t\tfactory[type] = function(...args) {\r\n\t\t\t\treturn new Bodies[type](Engine, ...args);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn factory;\r\n}\r\n","const RigidBody = require(\"../physics/RigidBody.js\");\r\nconst vec = require(\"../geometry/vec.js\");\r\nconst PolygonRender = require(\"../render/PolygonRender.js\");\r\nconst Sprite = require(\"../render/Sprite.js\");\r\n\r\nmodule.exports = class Rectangle extends RigidBody {\r\n\tstatic createVertices(width, height) {\r\n\t\treturn [\r\n\t\t\tnew vec(-width/2,  height/2),\r\n\t\t\tnew vec( width/2,  height/2),\r\n\t\t\tnew vec( width/2, -height/2),\r\n\t\t\tnew vec(-width/2, -height/2),\r\n\t\t];\r\n\t}\r\n\tconstructor(Engine, width, height, position, options = {}) {\r\n\t\tsuper(Engine, Rectangle.createVertices(width, height), position, options);\r\n\r\n\t\tthis.width = width;\r\n\t\tthis.height = height;\r\n\t\tthis.type = \"rectangle\";\r\n\t}\r\n\taddPolygonRender(container, options) {\r\n\t\tlet render = new PolygonRender({\r\n\t\t\tcontainer: container,\r\n\t\t\tposition: new vec(this.position),\r\n\t\t\tvertices: this.vertices,\r\n\t\t\ttype: \"rectangle\",\r\n\t\t\twidth: this.width,\r\n\t\t\theight: this.height,\r\n\t\t\t\r\n\t\t\t...options\r\n\t\t});\r\n\t\tif (this.added) render.add();\r\n\t\tthis.addChild(render);\r\n\t\t\r\n\t\treturn this;\r\n\t}\r\n\taddSprite(container, options) {\r\n\t\tlet render = new Sprite({\r\n\t\t\tcontainer: container,\r\n\t\t\tposition: new vec(this.position),\r\n\t\t\twidth: this.width,\r\n\t\t\theight: this.height,\r\n\t\t\t\r\n\t\t\t...options\r\n\t\t});\r\n\t\tif (this.added) render.add();\r\n\t\tthis.addChild(render);\r\n\r\n\t\treturn this;\r\n\t}\r\n}\r\n","const vec = require(\"../geometry/vec.js\");\r\n\r\nlet Common = module.exports = {\r\n\tclamp: function(x, min, max) { // clamps x so that min <= x <= max\r\n\t\treturn Math.max(min, Math.min(x, max));\r\n\t},\r\n\tangleDiff: function(angle1, angle2) { // returns the signed difference between 2 angles\r\n\t\tfunction mod(a, b) {\r\n\t\t\treturn a - Math.floor(a / b) * b;\r\n\t\t}\r\n\t\treturn mod(angle1 - angle2 + Math.PI, Math.PI * 2) - Math.PI;\r\n\t},\r\n\tmodDiff: function(x, y, m = 1) { // returns the signed difference between 2 values with any modulo, ie 11 oclock is 2 hours from 1 oclock with m = 12\r\n\t\tfunction mod(a, b) {\r\n\t\t\treturn a - Math.floor(a / b) * b;\r\n\t\t}\r\n\t\treturn mod(x - y + m/2, m) - m/2;\r\n\t},\r\n\r\n\t/**\r\n\t * Pairs 2 positive integers, returning a unique number for each possible pairing using elegant pairing - http://szudzik.com/ElegantPairing.pdf\r\n\t * @param {Number} x - 1st number, must be positive integer\r\n\t * @param {Number} y - 2nd number, must be positive integer\r\n\t * @returns {Number} Unique number from those \r\n\t */\r\n\tpair: function(x, y) {\r\n\t\tif (x > y)\r\n\t\t\treturn x*x + x + y;\r\n\t\treturn y*y + x;\r\n\t},\r\n\t/**\r\n\t * Takes a paired number and returns the x/y values that created that number\r\n\t * @param {Number} n Paired number\r\n\t * @returns {vec} Pair of x/y that created that pair\r\n\t */\r\n\tunpair: function(n) {\r\n\t\tlet z = Math.floor(Math.sqrt(n));\r\n\t\tlet l = n - z * z;\r\n\t\treturn l < z ? new vec(l, z) : new vec(z, l - z);\r\n\t},\r\n\r\n\t/**\r\n\t * Pairs 2 positive integers, returning a unique number for each possible pairing using elegant pairing - http://szudzik.com/ElegantPairing.pdf\r\n\t * Returns the same value if x/y are switched\r\n\t * @param {Number} x - 1st number, must be positive integer\r\n\t * @param {Number} y - 2nd number, must be positive integer\r\n\t * @returns {Number} Unique number from those \r\n\t */\r\n\tpairCommon: function(x, y) { // Elegant pairing function, but gives the same result if x/y are switched\r\n\t\tif (x > y)\r\n\t\t\treturn x*x + x + y;\r\n\t\treturn y*y + y + x;\r\n\t},\r\n\r\n\t/**\r\n\t * Calculates the center of mass of a convex body. Uses algorithm from https://bell0bytes.eu/centroid-convex/\r\n\t * @param {Array} vertices - Array of `vec`s to find the center of \r\n\t * @returns \r\n\t */\r\n\tgetCenterOfMass(vertices) {\r\n\t\tlet centroid = new vec(0, 0);\r\n\t\tlet det = 0;\r\n\t\tlet tempDet = 0;\r\n\t\tlet numVertices = vertices.length;\r\n\r\n\t\tfor (let i = 0; i < vertices.length; i++) {\r\n\t\t\tlet curVert = vertices[i];\r\n\t\t\tlet nextVert = vertices[(i + 1) % numVertices];\r\n\r\n\t\t\ttempDet = curVert.x * nextVert.y - nextVert.x * curVert.y;\r\n\t\t\tdet += tempDet;\r\n\r\n\t\t\tcentroid.add2({ x: (curVert.x + nextVert.x) * tempDet, y: (curVert.y + nextVert.y) * tempDet });\r\n\t\t}\r\n\r\n\t\tcentroid.div2(3 * det);\r\n\r\n\t\treturn centroid;\r\n\t},\r\n\r\n\t/**\r\n\t * Parses a color into its base hex code and alpha. Supports hex, hex with alpha, rgb, and rgba\r\n\t * @param {String} originalColor - Color to be parsed\r\n\t * @returns {Array} Array of [hex code, alpha] of parsed color\r\n\t */\r\n\tparseColor: function(originalColor) {\r\n\t\tif (originalColor === \"transparent\") {\r\n\t\t\treturn [\"#000000\", 0];\r\n\t\t}\r\n\t\tlet color;\r\n\t\tlet alpha = 1;\r\n\r\n\t\tif (originalColor[0] === \"#\" && originalColor.length === 9) { // is a hex code with alpha\r\n\t\t\tcolor = originalColor.slice(0, 7);\r\n\t\t\talpha = parseInt(originalColor.slice(7), 16) / 256; // convert to decimel\r\n\t\t}\r\n\t\telse if (originalColor[0] === \"#\" && originalColor.length === 7) { // is a hex code w/0 alpha\r\n\t\t\tcolor = originalColor;\r\n\t\t\talpha = 1;\r\n\t\t}\r\n\t\telse if (originalColor.slice(0, 4) === \"rgb(\") { // rgb\r\n\t\t\tcolor = originalColor.slice(originalColor.indexOf(\"(\") + 1, originalColor.indexOf(\")\")).split(\",\");\r\n\t\t\tcolor = \"#\" + color.map(value => parseInt(value).toString(16).padStart(2, \"0\")).join(\"\");\r\n\t\t\talpha = 1;\r\n\t\t}\r\n\t\telse if (originalColor.slice(0, 5) === \"rgba(\") { // rgba\r\n\t\t\tcolor = originalColor.slice(originalColor.indexOf(\"(\") + 1, originalColor.indexOf(\")\")).split(\",\");\r\n\t\t\talpha = parseInt(color.pop()) / 255;\r\n\t\t\tcolor = \"#\" + color.map(value => parseInt(value).toString(16).padStart(2, \"0\")).join(\"\");\r\n\t\t}\r\n\t\treturn [color, alpha];\r\n\t},\r\n\r\n\t/**\r\n\t * Deep copies `objB` onto `objA` in place.\r\n\t * @param {Object} objA - First object\r\n\t * @param {Object} objB - 2nd object, copied onto `objA`\r\n\t * @param {Number} maxDepth - The maximum depth it can copy\r\n\t * @returns {void}\r\n\t */\r\n\tmerge: function(objA, objB, maxDepth = Infinity, hash = new WeakSet()) {\r\n\t\thash.add(objB);\r\n\r\n\t\tObject.keys(objB).forEach(option => {\r\n\t\t\tlet value = objB[option];\r\n\t\t\t\r\n\t\t\tif (Array.isArray(value)) {\r\n\t\t\t\tobjA[option] = [ ...value ];\r\n\t\t\t}\r\n\t\t\telse if (typeof value === \"object\" && value !== null) {\r\n\t\t\t\tif (maxDepth > 1) {\r\n\t\t\t\t\tif (hash.has(value)) { // Cyclic reference\r\n\t\t\t\t\t\tobjA[option] = value;\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (typeof objA[option] !== \"object\") {\r\n\t\t\t\t\t\tobjA[option] = {};\r\n\t\t\t\t\t}\r\n\t\t\t\t\tCommon.merge(objA[option], value, maxDepth - 1, hash);\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tobjA[option] = value;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tobjA[option] = value;\r\n\t\t\t}\r\n\t\t});\r\n\t},\r\n\t\r\n\t/**\r\n\t * Finds if a variable is a class in disguise\r\n\t * @param {*} obj - Variable to check\r\n\t * @returns {Boolean} If the variable is a class\r\n\t */\r\n\tisClass: function(obj) {\r\n\t\tconst isCtorClass = obj.constructor\r\n\t\t\t&& obj.constructor.toString().substring(0, 5) === 'class'\r\n\t\tif(obj.prototype === undefined) {\r\n\t\t\treturn isCtorClass;\r\n\t\t}\r\n\t\tconst isPrototypeCtorClass = obj.prototype.constructor \r\n\t\t\t&& obj.prototype.constructor.toString\r\n\t\t\t&& obj.prototype.constructor.toString().substring(0, 5) === 'class'\r\n\t\treturn isCtorClass || isPrototypeCtorClass;\r\n\t},\r\n\r\n\t/**\r\n\t * Checks if line `a1`->`a2` is intersecting line `b1`->`b2`, and at what point\r\n\t * @param {vec} a1 - Start of line 1\r\n\t * @param {vec} a2 - End of line 1\r\n\t * @param {vec} b1 - Start of line 2\r\n\t * @param {vec} b2 - End of line 2\r\n\t * @returns {vec} Point of intersection, or null if they don't intersect\r\n\t */\r\n\tlineIntersects: function(a1, a2, b1, b2) { // tells you if lines a1->a2 and b1->b2 are intersecting, and at what point\r\n\t\tif (a1.x === a2.x || a1.y === a2.y) {\r\n\t\t\ta1 = new vec(a1);\r\n\t\t}\r\n\t\tif (b1.x === b2.x || b1.y === b2.y) {\r\n\t\t\tb1 = new vec(b1);\r\n\t\t}\r\n\t\tif (a1.x === a2.x)\r\n\t\t\ta1.x += 0.00001;\r\n\t\tif (b1.x === b2.x)\r\n\t\t\tb1.x += 0.00001;\r\n\t\tif (a1.y === a2.y)\r\n\t\t\ta1.y += 0.00001;\r\n\t\tif (b1.y === b2.y)\r\n\t\t\tb1.y += 0.00001;\r\n\r\n\t\tlet d = (a1.x - a2.x) * (b1.y - b2.y) - (a1.y - a2.y) * (b1.x - b2.x);\r\n\t\tif (d === 0) return false;\r\n\r\n\t\tlet nx = (a1.x * a2.y - a1.y * a2.x) * (b1.x - b2.x) - (a1.x - a2.x) * (b1.x * b2.y - b1.y * b2.x);\r\n\t\tlet ny = (a1.x * a2.y - a1.y * a2.x) * (b1.y - b2.y) - (a1.y - a2.y) * (b1.x * b2.y - b1.y * b2.x);\r\n\r\n\t\tlet pt = new vec(nx / d, ny / d);\r\n\r\n\t\tlet withinX = pt.x > Math.min(a1.x, a2.x) && pt.x < Math.max(a1.x, a2.x) && pt.x > Math.min(b1.x, b2.x) && pt.x < Math.max(b1.x, b2.x);\r\n\t\tlet withinY = pt.y > Math.min(a1.y, a2.y) && pt.y < Math.max(a1.y, a2.y) && pt.y > Math.min(b1.y, b2.y) && pt.y < Math.max(b1.y, b2.y);\r\n\t\tif (withinX && withinY) {\r\n\t\t\treturn pt;\r\n\t\t}\r\n\t\telse {\r\n\t\t\treturn null;\r\n\t\t}\r\n\t},\r\n\r\n\t/**\r\n\t * Tests if line `a1`->`a2` is intersecting `body`\r\n\t * @param {vec} a1 - Start of line\r\n\t * @param {vec} a2 - End of line\r\n\t * @param {RigidBody} body - Body to test\r\n\t * @returns {Boolean} If the line is intersecting the body\r\n\t */\r\n\tlineIntersectsBody: function(a1, a2, body) { // tells you if line a1->a2 is intersecting with body, returns true/false\r\n\t\tif (body.children.length > 0) {\r\n\t\t\tfor (let child of body.children) {\r\n\t\t\t\tif (Common.lineIntersectsBody(a1, a2, child)) {\r\n\t\t\t\t\treturn true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tlet ray = a2.sub(a1);\r\n\t\tlet rayNormalized = ray.normalize();\r\n\t\tlet rayAxes = [ rayNormalized, rayNormalized.normal() ];\r\n\t\tlet rayVertices = [ a1, a2 ]; \r\n\r\n\t\tfunction SAT(verticesA, verticesB, axes) {\r\n\t\t\tfor (let axis of axes) {\r\n\t\t\t\tlet boundsA = { min: Infinity, max: -Infinity };\r\n\t\t\t\tlet boundsB = { min: Infinity, max: -Infinity };\r\n\t\t\t\tfor (let vertice of verticesA) {\r\n\t\t\t\t\tlet projected = vertice.dot(axis);\r\n\t\t\t\t\tif (projected < boundsA.min) {\r\n\t\t\t\t\t\tboundsA.minVertice\r\n\t\t\t\t\t}\r\n\t\t\t\t\tboundsA.min = Math.min(boundsA.min, projected);\r\n\t\t\t\t\tboundsA.max = Math.max(boundsA.max, projected);\r\n\t\t\t\t}\r\n\t\t\t\tfor (let vertice of verticesB) {\r\n\t\t\t\t\tlet projected = vertice.dot(axis);\r\n\t\t\t\t\tboundsB.min = Math.min(boundsB.min, projected);\r\n\t\t\t\t\tboundsB.max = Math.max(boundsB.max, projected);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (boundsA.min > boundsB.max || boundsA.max < boundsB.min) { // they are NOT colliding on this axis\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\t// SAT using ray axes and body axes\r\n\t\treturn SAT(rayVertices, body.vertices, rayAxes) && SAT(rayVertices, body.vertices, body.axes);\r\n\t},\r\n\r\n\t/**\r\n\t * Finds the static bodies around the ray from `start` to `end`. Useful for getting bodies when calling `Common.raycast` or `Common.raycastSimple`\r\n\t * @param {vec} start - Start of ray\r\n\t * @param {vec} end - End of ray\r\n\t * @param {World} World - World to get bodies from\r\n\t */\r\n\tgetRayNearbyStaticBodies(start, end, World) {\r\n\t\tlet grid = World.staticGrid;\r\n\t\tlet size = grid.gridSize;\r\n\t\tlet bounds = { min: start.min(end).div2(size).floor2(), max: start.max(end).div2(size).floor2() };\r\n\t\tbodies = new Set();\r\n\r\n\t\tfor (let x = bounds.min.x; x <= bounds.max.x; x++) {\r\n\t\t\tfor (let y = bounds.min.y; y <= bounds.max.y; y++) {\r\n\t\t\t\tlet n = grid.pair(new vec(x, y));\r\n\t\t\t\tlet node = grid.grid[n];\r\n\r\n\t\t\t\tif (node) {\r\n\t\t\t\t\tfor (let body of node) {\r\n\t\t\t\t\t\tif (!bodies.has(body)) {\r\n\t\t\t\t\t\t\tbodies.add(body);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\tgetRayNearbyDynamicBodies(start, end, World) {\r\n\t\tlet grid = World.dynamicGrid;\r\n\t\tlet size = grid.gridSize;\r\n\t\tlet bounds = { min: start.min(end).div2(size).floor2(), max: start.max(end).div2(size).floor2() };\r\n\t\tbodies = new Set();\r\n\r\n\t\tfor (let x = bounds.min.x; x <= bounds.max.x; x++) {\r\n\t\t\tfor (let y = bounds.min.y; y <= bounds.max.y; y++) {\r\n\t\t\t\tlet n = grid.pair(new vec(x, y));\r\n\t\t\t\tlet node = grid.grid[n];\r\n\r\n\t\t\t\tif (node) {\r\n\t\t\t\t\tfor (let body of node) {\r\n\t\t\t\t\t\tif (!bodies.has(body)) {\r\n\t\t\t\t\t\t\tbodies.add(body);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\t/**\r\n\t * \r\n\t * @param {vec} start - Start of ray\r\n\t * @param {vec} end - End of ray\r\n\t * @param {Array} bodies - (Optional) Array of bodies to test\r\n\t * @returns {Object} { collision: Boolean, distance: Number, point: vec, body: RigidBody, verticeIndex: Number }\r\n\t */\r\n\traycast: function(start, end, bodies) {\r\n\t\tlet lineIntersects = Common.lineIntersects;\r\n\t\tlet minDist = Infinity;\r\n\t\tlet minPt = null;\r\n\t\tlet minBody = null;\r\n\t\tlet minVert = -1;\r\n\r\n\t\tfor (let i = 0; i < bodies.length; i++) {\r\n\t\t\tlet body = bodies[i];\r\n\t\t\tlet { vertices } = body;\r\n\t\t\tlet len = vertices.length;\r\n\r\n\t\t\tfor (let i = 0; i < len; i++) {\r\n\t\t\t\tlet cur = vertices[i];\r\n\t\t\t\tlet next = vertices[(i + 1) % len];\r\n\r\n\t\t\t\tlet intersection = lineIntersects(start, end, cur, next);\r\n\t\t\t\tif (intersection) {\r\n\t\t\t\t\tlet dist = intersection.sub(start).length;\r\n\t\t\t\t\tif (dist < minDist) {\r\n\t\t\t\t\t\tminDist = dist;\r\n\t\t\t\t\t\tminPt = intersection;\r\n\t\t\t\t\t\tminBody = body;\r\n\t\t\t\t\t\tminVert = i;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn {\r\n\t\t\tcollision: minPt !== null,\r\n\t\t\tdistance: minDist,\r\n\t\t\tpoint: minPt,\r\n\t\t\tbody: minBody,\r\n\t\t\tverticeIndex: minVert,\r\n\t\t};\r\n\t},\r\n\traycastSimple: function(start, end, bodies) { // raycast that only tells you if there is a collision (usually faster), returns true/false\r\n\t\tlet lineIntersectsBody = Common.lineIntersectsBody;\r\n\r\n\t\tfor (let body of bodies) {\r\n\t\t\tlet intersection = lineIntersectsBody(start, end, body);\r\n\t\t\tif (intersection) {\r\n\t\t\t\treturn true;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn false;\r\n\t},\r\n\tboundCollision: function(boundsA, boundsB) { // checks if 2 bounds { min: vec, max: vec } are intersecting, returns true/false\r\n\t\treturn (boundsA.max.x >= boundsB.min.x && boundsA.min.x <= boundsB.max.x && \r\n\t\t\t\tboundsA.max.y >= boundsB.min.y && boundsA.min.y <= boundsB.max.y);\r\n\t},\r\n\tpointInBounds: function(point, bounds) { // checks if a point { x: x, y: y } is within bounds { min: vec, max: vec }, returns true/false\r\n\t\treturn (point.x >= bounds.min.x && point.x <= bounds.max.x && \r\n\t\t\t\tpoint.y >= bounds.min.y && point.y <= bounds.max.y);\r\n\t},\r\n\r\n\t/**\r\n\t * Deletes first instance of `value` from `array`\r\n\t * @param {Array} array Array item is deleted from\r\n\t * @param {*} value Value deleted from array\r\n\t */\r\n\tarrayDelete(array, value) {\r\n\t\tlet index = array.indexOf(value);\r\n\t\tif (index !== -1) {\r\n\t\t\tarray.splice(index, 1);\r\n\t\t}\r\n\t}\r\n}\r\n","const World = require(\"../node/World.js\");\r\nconst Render = require(\"../render/Render.js\");\r\nconst DebugRender = require(\"../render/DebugRender.js\");\r\nconst Engine = require(\"../physics/Engine.js\");\r\nconst Common = require(\"../core/Common.js\");\r\nconst PerformanceRender = require(\"../render/PerformanceRender.js\");\r\nconst Ticker = require(\"../core/Ticker.js\");\r\nconst Bodies = require(\"../bodies/Bodies.js\");\r\n\r\nmodule.exports = class Game {\r\n\tstatic defaultOptions = {\r\n\t\tWorld: World.defaultOptions,\r\n\t\tRender: Render.defaultOptions,\r\n\t\tEngine: Engine.defaultOptions,\r\n\t\tTicker: Ticker.defaultOptions,\r\n\t}\r\n\r\n\tconstructor(options = {}) {\r\n\t\tlet defaults = { ...Game.defaultOptions };\r\n\t\tCommon.merge(defaults, options, 2);\r\n\t\toptions = defaults;\r\n\r\n\t\tthis.World = new World(options.World);\r\n\t\tthis.Engine = new Engine(this.World, options.Engine);\r\n\t\tthis.Render = new Render(options.Render);\r\n\t\tthis.Ticker = new Ticker(this, options.Ticker);\r\n\t\tthis.Bodies = Bodies.createBodyFactory(this.Engine);\r\n\t}\r\n\tcreateDebugRender() {\r\n\t\tthis.DebugRender = new DebugRender(this);\r\n\r\n\t\tlet Performance = this.Engine.Performance;\r\n\t\tPerformance.render = new PerformanceRender(Performance, this.Render);\r\n\t\tPerformance.render.enabled = true;\r\n\t}\r\n}\r\n","const PerformanceRender = require(\"../render/PerformanceRender\");\r\n\r\nmodule.exports = class Performance {\r\n\tgetAvgs = true;\r\n\tlastUpdate = 0;\r\n\tfps = 60;\r\n\tdelta = 1;\r\n\tframe = 0;\r\n\r\n\thistory = {\r\n\t\tavgFps: 60,\r\n\t\tavgDelta: 1,\r\n\t\tfps: [],\r\n\t\tdelta: [],\r\n\t}\r\n\tengine = {\r\n\t\tdelta: 0,\r\n\t\tlastUpdate: 0,\r\n\t}\r\n\r\n\t/**\r\n\t * Creates a performance tracker\r\n\t * @param {Render} Render - Optional Render object to create a performance render\r\n\t */\r\n\tconstructor(Render = undefined) {\r\n\t\tif (Render) this.render = new PerformanceRender(this, Render);\r\n\t\tthis.lastUpdate = performance.now() / 1000;\r\n\t}\r\n\tupdate() {\r\n\t\tlet curTime = performance.now() / 1000;\r\n\t\tif (curTime - this.lastUpdate === 0) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis.delta = Math.min(5, curTime - this.lastUpdate);\r\n\t\tthis.fps = 1 / this.delta;\r\n\t\tthis.lastUpdate = curTime;\r\n\r\n\t\tthis.history.fps.push(this.fps);\r\n\t\tthis.history.delta.push(this.delta);\r\n\r\n\t\tif (this.history.fps.length > 200) {\r\n\t\t\tthis.history.fps.shift();\r\n\t\t\tthis.history.delta.shift();\r\n\t\t}\r\n\t\tlet fps = (() => {\r\n\t\t\tlet v = 0;\r\n\t\t\tfor (let i = 0; i < this.history.fps.length; i++) {\r\n\t\t\t\tv += this.history.fps[i];\r\n\t\t\t}\r\n\t\t\treturn v / this.history.fps.length;\r\n\t\t})();\r\n\t\tlet delta = (() => {\r\n\t\t\tlet v = 0;\r\n\t\t\tfor (let i = 0; i < this.history.delta.length; i++) {\r\n\t\t\t\tv += this.history.delta[i];\r\n\t\t\t}\r\n\t\t\treturn v / this.history.delta.length;\r\n\t\t})();\r\n\r\n\t\tthis.history.avgFps = fps;\r\n\t\tthis.history.avgDelta = delta;\r\n\t}\r\n};\r\n","const Common = require(\"../core/Common.js\");\r\n\r\nmodule.exports = class Ticker {\r\n\tstatic defaultOptions = {\r\n\t\tpauseOnFreeze: true,\r\n\t\tfreezeThreshold: 0.3,\r\n\t}\r\n\r\n\t/**\r\n\t * Creates a ticker that runs on `Game` every frame.\r\n\t * @param {Game} Game Game ticker should be run on\r\n\t * @param {Object} options Options object, see documentation for options\r\n\t */\r\n\tconstructor(Game, options = {}) {\r\n\t\tlet defaults = { ...Ticker.defaultOptions };\r\n\t\tCommon.merge(defaults, options, 1);\r\n\t\toptions = defaults;\r\n\t\t\r\n\t\tthis.Game = Game;\r\n\t\tthis.pauseOnFreeze   = options.pauseOnFreeze;\r\n\t\tthis.freezeThreshold = options.freezeThreshold;\r\n\r\n\t\tthis.tick = this.tick.bind(this);\r\n\t\twindow.addEventListener(\"load\", this.tick);\r\n\t}\r\n\ttick() {\r\n\t\tthis.trigger(\"beforeTick\");\r\n\r\n\t\tconst { Engine } = this.Game;\r\n\t\tconst { Performance } = Engine;\r\n\t\tif (this.pauseOnFreeze && Performance.fps / Math.max(1, Performance.history.avgFps) < this.freezeThreshold) {\r\n\t\t\tPerformance.update();\r\n\t\t}\r\n\t\telse {\r\n\t\t\tEngine.update();\r\n\t\t\t// animations.run();\r\n\t\t}\r\n\r\n\t\tthis.trigger(\"afterTick\");\r\n\t\trequestAnimationFrame(this.tick);\r\n\t}\r\n\t\r\n\t#events = {\r\n\t\tbeforeTick: [],\r\n\t\tafterTick: [],\r\n\t}\r\n\ton(event, callback) {\r\n\t\tif (this.#events[event]) {\r\n\t\t\tthis.#events[event].push(callback);\r\n\t\t}\r\n\t\telse {\r\n\t\t\tconsole.warn(event + \" is not a valid event\");\r\n\t\t}\r\n\t}\r\n\toff(event, callback) {\r\n\t\tevent = this.#events[event];\r\n\t\tif (event.includes(callback)) {\r\n\t\t\tevent.splice(event.indexOf(callback), 1);\r\n\t\t}\r\n\t}\r\n\ttrigger(event) {\r\n\t\t// Trigger each event\r\n\t\tif (this.#events[event]) {\r\n\t\t\tthis.#events[event].forEach(callback => {\r\n\t\t\t\tcallback();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n}\r\n","\"use strict\";\r\n\r\nclass BehaviorTree {\r\n\tstatic FAILURE = 0;\r\n\tstatic SUCCESS = 1;\r\n\t// RUNNING state not necessary in this implementation\r\n\tstatic globalTrees = {};\r\n\tstatic call(name, resolve, blackboard = {}) {\r\n\t\tlet tree = this.globalTrees[name];\r\n\t\tif (!tree) {\r\n\t\t\tthrow new Error(`No registered tree of name: ${ name }`);\r\n\t\t}\r\n\t\ttree.tick(blackboard).then(result => resolve(result));\r\n\t}\r\n\tstatic nodes = {};\r\n\tstatic parse(node) {\r\n\t\tlet nodeType;\r\n\t\tif (typeof node == \"string\") {\r\n\t\t\tif (!BehaviorTree.globalTrees[node]) {\r\n\t\t\t\tthrow new Error(\"No registered tree of name: \" + node);\r\n\t\t\t}\r\n\t\t\tnode = BehaviorTree.globalTrees[node];\r\n\t\t}\r\n\t\tlet tmp = {};\r\n\t\tCommon.merge(tmp, node);\r\n\t\tnode = tmp;\r\n\r\n\t\tnodeType = BehaviorTree.nodes[node.type ?? node.toString()];\r\n\t\tif (!nodeType) {\r\n\t\t\tthrow new Error(\"No node of type: \" + node.type + \", \" + node);\r\n\t\t}\r\n\t\t\r\n\t\tif (node.child) {\r\n\t\t\tnode.child = BehaviorTree.parse(node.child);\r\n\t\t}\r\n\t\tif (node.children) {\r\n\t\t\tfor (let i = 0; i < node.children.length; ++i) {\r\n\t\t\t\tnode.children[i] = BehaviorTree.parse(node.children[i]);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tlet nodeObject = new nodeType(node, node?.blackboard);\r\n\t\treturn nodeObject;\r\n\t}\r\n\tstatic registerType(_class) {\r\n\t\tthis.nodes[_class] = _class;\r\n\t}\r\n\tstatic registerTree(name, tree) {\r\n\t\tthis.globalTrees[name] = tree;\r\n\t}\r\n\tstatic toString() {\r\n\t\treturn \"BehaviorTree\";\r\n\t}\r\n\tstatic id = -1;\r\n\tblackboard = {};\r\n\thead = null;\r\n\tconstructor(tree, blackboard = {}) {\r\n\t\tthis.id = ++BehaviorTree.id;\r\n\t\tthis.toString = BehaviorTree.toString;\r\n\r\n\t\t// Create blackboard\r\n\t\tthis.blackboard = blackboard;\r\n\r\n\t\tif ((tree.type ?? tree.toString()) === \"BehaviorTree\") {\r\n\t\t\tthis.blackboard = tree.blackboard;\r\n\t\t\tthis.head = BehaviorTree.parse(tree.head);\r\n\t\t}\r\n\t\telse {\r\n\t\t\t// parse tree\r\n\t\t\tthis.head = BehaviorTree.parse(tree);\r\n\t\t}\r\n\t}\r\n\ttick(blackboard = this.blackboard) {\r\n\t\treturn this.head.tick(blackboard);\r\n\t}\r\n\tinterrupt(value = BehaviorTree.FAILURE) {\r\n\t\tthis.head.interrupt(value);\r\n\t}\r\n}\r\nBehaviorTree.registerType(BehaviorTree);\r\nmodule.exports.BehaviorTree = BehaviorTree;\r\n\r\n//\r\n// Composites\r\n//\r\nclass Composite { // Has 1+ children, processes them in a certain order each tick\r\n\tstatic toString() {\r\n\t\treturn \"Composite\";\r\n\t}\r\n\r\n\tconstructor({ children = [] }) {\r\n\t\tthis.id = ++BehaviorTree.id;\r\n\t\tthis.children = children;\r\n\t\tthis.toString = Composite.toString;\r\n\t}\r\n\tinterrupt(value = BehaviorTree.FAILURE) {\r\n\t\tfor (let child of this.children) {\r\n\t\t\tchild.interrupt(value);\r\n\t\t}\r\n\t\tif (this.resolve) {\r\n\t\t\tthis.hasInterrupt = true;\r\n\t\t\tthis.resolve(value);\r\n\t\t}\r\n\t}\r\n}\r\nBehaviorTree.registerType(Composite);\r\nmodule.exports.Composite = Composite;\r\n\r\nclass Sequence extends Composite { // AND, returns failure at first failure, success if no children fail\r\n\tstatic toString() {\r\n\t\treturn \"Sequence\";\r\n\t}\r\n\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t\tthis.toString = Sequence.toString;\r\n\t}\r\n\ttick(blackboard) {\r\n\t\tlet children = this.children;\r\n\t\tlet node = this;\r\n\t\treturn new Promise(resolve => {\r\n\t\t\tthis.resolve = resolve;\r\n\t\t\tlet i = 0;\r\n\t\t\tfunction next() {\r\n\t\t\t\tchildren[i].tick(blackboard).then(result => {\r\n\t\t\t\t\tif (node.hasInterrupt) {\r\n\t\t\t\t\t\tnode.hasInterrupt = false;\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (result == BehaviorTree.SUCCESS) {\r\n\t\t\t\t\t\tif (++i >= children.length) {\r\n\t\t\t\t\t\t\tresolve(BehaviorTree.SUCCESS);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\tnext();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tresolve(result);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tnext();\r\n\t\t});\r\n\t}\r\n}\r\nBehaviorTree.registerType(Sequence);\r\nmodule.exports.Sequence = Sequence;\r\n\r\nclass Selector extends Composite { // OR, returns success at first success / running, failure if all children fail\r\n\tstatic toString() {\r\n\t\treturn \"Selector\";\r\n\t}\r\n\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t\tthis.toString = Selector.toString;\r\n\t}\r\n\ttick(blackboard) {\r\n\t\tlet node = this;\r\n\t\tlet children = this.children;\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.resolve = resolve;\r\n\t\t\tlet i = 0;\r\n\t\t\tfunction next() {\r\n\t\t\t\tchildren[i].tick(blackboard).then(result => {\r\n\t\t\t\t\tif (node.hasInterrupt) {\r\n\t\t\t\t\t\tnode.hasInterrupt = false;\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (result == BehaviorTree.SUCCESS) {\r\n\t\t\t\t\t\tresolve(result);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tif (++i >= children.length) {\r\n\t\t\t\t\t\t\tresolve(BehaviorTree.FAILURE);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\telse {\r\n\t\t\t\t\t\t\tnext();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tnext();\r\n\t\t});\r\n\t}\r\n}\r\nBehaviorTree.registerType(Selector);\r\nmodule.exports.Selector = Selector;\r\n\r\n//\r\n// Decorators\r\n//\r\nclass Decorator { // Has 1 child, transforms result / repeats / terminates\r\n\tstatic toString() {\r\n\t\treturn \"Decorator\";\r\n\t}\r\n\r\n\tconstructor({ child }) {\r\n\t\tthis.id = ++BehaviorTree.id;\r\n\t\tthis.child = child;\r\n\t\tthis.toString = Decorator.toString;\r\n\t}\r\n\tinterrupt(value = BehaviorTree.FAILURE) {\r\n\t\tthis.child.interrupt(value);\r\n\t\t\r\n\t\tif (this.resolve) {\r\n\t\t\tthis.resolve(value);\r\n\t\t\tthis.hasInterrupt = true;\r\n\t\t}\r\n\t}\r\n}\r\nBehaviorTree.registerType(Decorator);\r\nmodule.exports.Decorator = Decorator;\r\n\r\nclass Inverter extends Decorator { // Inverts result, SUCCESS -> FAILURE, FAILURE -> SUCCESS\r\n\tstatic toString() {\r\n\t\treturn \"Inverter\";\r\n\t}\r\n\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t\tthis.toString = Inverter.toString;\r\n\t}\r\n\ttick(blackboard) {\r\n\t\tlet node = this;\r\n\t\treturn new Promise(resolve => {\r\n\t\t\tif (node.hasInterrupt) {\r\n\t\t\t\tnode.hasInterrupt = false;\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tthis.resolve = resolve;\r\n\t\t\tthis.child.tick(blackboard).then(result => {\r\n\t\t\t\tresolve(Number(!result));\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n}\r\nBehaviorTree.registerType(Inverter);\r\nmodule.exports.Inverter = Inverter;\r\n\r\nclass Succeeder extends Decorator { // Always returns SUCCESS\r\n\tstatic toString() {\r\n\t\treturn \"Succeeder\";\r\n\t}\r\n\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t\tthis.toString = Succeeder.toString;\r\n\t}\r\n\ttick(blackboard) {\r\n\t\tlet child = this.child;\r\n\t\tlet node = this;\r\n\t\treturn new Promise(resolve => {\r\n\t\t\tthis.resolve = resolve;\r\n\t\t\tchild.tick(blackboard).then(result => {\r\n\t\t\t\tif (node.hasInterrupt) {\r\n\t\t\t\t\tnode.hasInterrupt = false;\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tresolve(BehaviorTree.SUCCESS);\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n}\r\nBehaviorTree.registerType(Succeeder);\r\nmodule.exports.Succeeder = Succeeder;\r\n\r\nclass Repeat extends Decorator { // Repeats child `count` times\r\n\tstatic toString() {\r\n\t\treturn \"Repeat\";\r\n\t}\r\n\r\n\tcount = 3;\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t\tthis.toString = Repeat.toString;\r\n\t\tthis.count = options.count ?? 3;\r\n\t}\r\n\ttick(blackboard) {\r\n\t\tlet node = this;\r\n\t\tlet curCount = 0;\r\n\t\tlet maxCount = this.count;\r\n\t\tlet child = this.child;\r\n\t\treturn new Promise(resolve => {\r\n\t\t\tthis.resolve = resolve;\r\n\t\t\tfunction next() {\r\n\t\t\t\tchild.tick(blackboard).then(result => {\r\n\t\t\t\t\tif (node.hasInterrupt) {\r\n\t\t\t\t\t\tnode.hasInterrupt = false;\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (++curCount >= maxCount) {\r\n\t\t\t\t\t\tresolve(BehaviorTree.SUCCESS);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tnext();\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tnext();\r\n\t\t});\r\n\t}\r\n}\r\nBehaviorTree.registerType(Repeat);\r\nmodule.exports.Repeat = Repeat;\r\n\r\nclass RepeatUntilFail extends Decorator { // Repeats child `count` times (default is Infinity), or until a child returns FAILURE; always returns SUCCESS\r\n\tstatic toString() {\r\n\t\treturn \"RepeatUntilFail\";\r\n\t}\r\n\tcount = Infinity;\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t\tthis.toString = RepeatUntilFail.toString;\r\n\t\tthis.count = options.count ?? Infinity;\r\n\t}\r\n\ttick(blackboard) {\r\n\t\tlet curCount = 0;\r\n\t\tlet maxCount = this.count;\r\n\t\tlet child = this.child;\r\n\t\tlet node = this;\r\n\t\treturn new Promise(resolve => {\r\n\t\t\tthis.resolve = resolve;\r\n\t\t\tfunction next() {\r\n\t\t\t\tchild.tick(blackboard).then(result => {\r\n\t\t\t\t\tif (node.hasInterrupt) {\r\n\t\t\t\t\t\tnode.hasInterrupt = false;\r\n\t\t\t\t\t\treturn;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (result == BehaviorTree.FAILURE) {\r\n\t\t\t\t\t\tresolve(BehaviorTree.SUCCESS);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if (++curCount >= maxCount) {\r\n\t\t\t\t\t\tresolve(BehaviorTree.SUCCESS);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tnext();\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tnext();\r\n\t\t});\r\n\t}\r\n}\r\nBehaviorTree.registerType(RepeatUntilFail);\r\nmodule.exports.RepeatUntilFail = RepeatUntilFail;\r\n\r\n//\r\n// Leaf\r\n//\r\nclass Leaf { // Logic of the tree; calls `callback` every tick, which is the actual tree code\r\n\tstatic toString() {\r\n\t\treturn \"Leaf\";\r\n\t}\r\n\tconstructor({ callback }) {\r\n\t\tthis.id = ++BehaviorTree.id;\r\n\t\tthis.callback = callback;\r\n\t\tthis.toString = Leaf.toString;\r\n\t}\r\n\ttick(blackboard) {\r\n\t\treturn new Promise(resolve => {\r\n\t\t\tthis.resolve = resolve;\r\n\t\t\tthis.callback(resolve, blackboard);\r\n\t\t});\r\n\t}\r\n\tinterrupt(value = BehaviorTree.FAILURE) {\r\n\t\tif (this.resolve) {\r\n\t\t\tthis.resolve(value);\r\n\t\t}\r\n\t}\r\n}\r\nBehaviorTree.registerType(Leaf);\r\nmodule.exports.Leaf = Leaf;\r\n","const vec = require(\"../geometry/vec.js\");\r\n\r\nmodule.exports = {\r\n\t// returns an array of index(es) that make up edges of voronoi region. 2 points if it's between 2 vertices, 1 point if it's between axes, 0 points if it's inside body\r\n\tgetVoronoiRegion: function(body, point) { \r\n\t\tlet { vertices } = body;\r\n\t\tlet length = vertices.length;\r\n\t\tfor (let i = 0; i < length; i++) {\r\n\t\t\tlet vertice = vertices[i];\r\n\t\t\tlet nextVertice = vertices[(i + 1) % length];\r\n\t\t\tlet vertToNext = nextVertice.sub(vertice);\r\n\t\t\tlet axis = vertToNext.normalize();\r\n\t\t\tlet normal = axis.normal();\r\n\t\t\tlet vertToPoint = point.sub(vertice);\r\n\r\n\r\n\t\t\tlet outside = vertToPoint.dot(normal) >= -10; // theoretically should be 0, but a bit of penetration is allowed in simulation\r\n\t\t\tlet vpDotAxis = vertToPoint.dot(axis);\r\n\t\t\tlet within = vpDotAxis >= 0 && vpDotAxis <= vertToNext.length;\r\n\r\n\t\t\tif (outside && within) {\r\n\t\t\t\treturn [i, (i + 1) % length];\r\n\t\t\t}\r\n\t\t\telse { // check if between axis and lastAxis\r\n\t\t\t\tlet lastVertice = vertices[(i - 1 + length) % length];\r\n\t\t\t\tlet lastAxis = lastVertice.sub(vertice).normalize();\r\n\t\t\t\tif (vertToPoint.dot(lastAxis) < 0 && vpDotAxis < 0) {\r\n\t\t\t\t\treturn [i];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn [];\r\n\t},\r\n\tclosestPointBetweenBodies: function(bodyA, bodyB) { // returns the closest point on bodyB from the vertices of bodyA\r\n\t\t// should technically be run 2x for (bodyA, bodyB) and (bodyB, bodyA) to find the actual closest points\r\n\t\tlet verticesA = bodyA.vertices;\r\n\t\tlet verticesB = bodyB.vertices;\r\n\t\tlet point = null;\r\n\t\tlet minDistance = Infinity;\r\n\t\tfor (let i = 0; i < verticesA.length; i++) {\r\n\t\t\tlet verticeA = verticesA[i];\r\n\t\t\tlet region = getVoronoiRegion(bodyB, verticeA);\r\n\r\n\t\t\tif (region.length > 0) {\r\n\t\t\t\tlet projected;\r\n\r\n\t\t\t\tif (region.length === 1) {\r\n\t\t\t\t\tprojected = new vec(verticesB[region[0]]);\r\n\t\t\t\t}\r\n\t\t\t\telse if (region.length === 2) {\r\n\t\t\t\t\tlet pointBA = verticesB[region[0]];\r\n\t\t\t\t\tlet pointBB = verticesB[region[1]];\r\n\t\t\t\t\tlet axis = pointBB.sub(pointBA).normalize();\r\n\t\t\t\t\tprojected = axis.mult(axis.dot(verticeA.sub(pointBA))).add(pointBA);\t\r\n\t\t\t\t}\r\n\r\n\t\t\t\tlet distance = projected.sub(verticeA).length;\r\n\t\t\t\tif (distance < minDistance) {\r\n\t\t\t\t\tminDistance = distance;\r\n\t\t\t\t\tpoint = projected;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn point;\r\n\t},\r\n\tclosestEdgeBetweenBodies: function(bodyA, bodyB) { // returns the closest point and its normal (point and normal are only on bodyB)\r\n\t\tlet verticesA = bodyA.vertices;\r\n\t\tlet verticesB = bodyB.vertices;\r\n\t\tlet point = null;\r\n\t\tlet normal = new vec(1, 0);\r\n\t\tlet minDistance = Infinity;\r\n\t\tfor (let i = 0; i < verticesA.length; i++) {\r\n\t\t\tlet verticeA = verticesA[i];\r\n\t\t\tlet region = getVoronoiRegion(bodyB, verticeA);\r\n\r\n\t\t\tif (region.length > 0) {\r\n\t\t\t\tlet projected;\r\n\t\t\t\tlet curNormal;\r\n\r\n\t\t\t\tif (region.length === 1) {\r\n\t\t\t\t\tprojected = new vec(verticesB[region[0]]);\r\n\t\t\t\t\tlet prev = verticesB[(region[0] - 1 + verticesB.length) % verticesB.length];\r\n\t\t\t\t\tlet next = verticesB[(region[0] + 1) % verticesB.length];\r\n\t\t\t\t\tlet axisA = projected.sub(prev).normalize();\r\n\t\t\t\t\tlet axisB = next.sub(projected).normalize();\r\n\t\t\t\t\tcurNormal = axisA.add(axisB).normalize();\r\n\t\t\t\t}\r\n\t\t\t\telse if (region.length === 2) {\r\n\t\t\t\t\tlet pointBA = verticesB[region[0]];\r\n\t\t\t\t\tlet pointBB = verticesB[region[1]];\r\n\t\t\t\t\tlet axis = pointBB.sub(pointBA).normalize();\r\n\t\t\t\t\tprojected = axis.mult(axis.dot(verticeA.sub(pointBA))).add(pointBA);\r\n\t\t\t\t\tcurNormal = axis;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tlet distance = projected.sub(verticeA).length;\r\n\t\t\t\tif (distance < minDistance) {\r\n\t\t\t\t\tminDistance = distance;\r\n\t\t\t\t\tpoint = projected;\r\n\t\t\t\t\tnormal = curNormal.normal();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn {\r\n\t\t\tpoint: point,\r\n\t\t\tnormal: normal,\r\n\t\t};\r\n\t},\r\n\r\n\tcreateGradient: function(startPosition, endPosition, colorStops = [[\"#ff0000ff\", 0], [\"#ff000000\", 1]]) {\r\n\t\tlet gradient = ctx.createLinearGradient(startPosition.x, startPosition.y, endPosition.x, endPosition.y);\r\n\t\tfor (let colorStop of colorStops) {\r\n\t\t\tgradient.addColorStop(colorStop[1], colorStop[0]);\r\n\t\t}\r\n\t\treturn gradient;\r\n\t},\r\n\tcreateRadialGradient: function(position, radius, colorStops = [[\"#ff0000ff\", 0], [\"#ff000000\", 1]]) {\r\n\t\tlet gradient = ctx.createRadialGradient(position.x, position.y, 0, position.x, position.y, radius);\r\n\t\tfor (let colorStop of colorStops) {\r\n\t\t\tgradient.addColorStop(colorStop[1], colorStop[0]);\r\n\t\t}\r\n\t\treturn gradient;\r\n\t},\r\n\r\n\tcreateElement: function(type, properties) {\r\n\t\tlet elem = document.createElement(type);\r\n\r\n\t\tfunction addProperties(elem, properties) {\r\n\t\t\tObject.keys(properties).forEach(property => {\r\n\t\t\t\tif (typeof properties[property] === \"object\" && !Array.isArray(property) && !(properties[property] instanceof Element)) {\r\n\t\t\t\t\taddProperties(elem[property], properties[property]);\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tif (property === \"class\") {\r\n\t\t\t\t\t\tlet classes = typeof properties[property] === \"string\" ? properties[property].split(\" \") : properties[property];\r\n\t\t\t\t\t\tfor (let className of classes) {\r\n\t\t\t\t\t\t\telem.classList.add(className);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if (property === \"parent\") {\r\n\t\t\t\t\t\tproperties[property].appendChild(elem);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\telem[property] = properties[property];\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\taddProperties(elem, properties);\r\n\r\n\t\treturn elem;\r\n\t},\r\n\tgaussianRandom: function(mean = 0, stdev = 1, random = Math.random) { // Standard Normal distribution using Box-Muller transform https://stackoverflow.com/a/36481059\r\n\t\tlet u = 1 - random();\r\n\t\tlet v = random();\r\n\t\tlet z = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);\r\n\t\treturn z * stdev + mean;\r\n\t},\r\n\tcreateSeededRandom: function(seed) { // Returns function that generates numbers between [0, 1). Adaptation of https://stackoverflow.com/a/19301306\r\n\t\tvar mask = 0xffffffff;\r\n\t\tvar m_w = (123456789 + seed) & mask;\r\n\t\tvar m_z = (987654321 - seed) & mask;\r\n\t\t\r\n\t\treturn function() {\r\n\t\t\tm_z = (36969 * (m_z & 65535) + (m_z >> 16)) & mask;\r\n\t\t\tm_w = (18000 * (m_w & 65535) + (m_w >> 16)) & mask;\r\n\t\t\tvar result = ((m_z << 16) + (m_w & 65535)) >>> 0;\r\n\t\t\tresult /= 4294967296;\r\n\t\t\treturn result;\r\n\t\t}\r\n\t},\r\n\tsetCSSVariable: function(varName, value) {\r\n\t\troot.style.setProperty(`--${varName}`, value);\r\n\t},\r\n\r\n\tboundedRandom: function([min, max]) {\r\n\t\treturn Math.random() * (max - min) + min;\r\n\t},\r\n\tboundedRandomPoint: function(bounds) {\r\n\t\treturn new vec(boundedRandom([bounds.min.x, bounds.max.x]), boundedRandom([bounds.min.y, bounds.max.y]));\r\n\t},\r\n\tgetMovementDirections: function(direction, threshold = 0.5) {\r\n\t\tdirection = direction.normalize();\r\n\r\n\t\tlet directionNames = {};\r\n\t\tif (direction.x > threshold) {\r\n\t\t\tdirectionNames.right = true;\r\n\t\t}\r\n\t\telse if (direction.x < -threshold) {\r\n\t\t\tdirectionNames.left = true;\r\n\t\t}\r\n\t\tif (direction.y > threshold) {\r\n\t\t\tdirectionNames.down = true;\r\n\t\t}\r\n\t\telse if (direction.y < -threshold) {\r\n\t\t\tdirectionNames.up = true;\r\n\t\t}\r\n\t\treturn directionNames;\r\n\t},\r\n\tsetMovementDirections: function(controls, directions) {\r\n\t\tfor (let controlName of Object.keys(directions)) {\r\n\t\t\tcontrols[controlName] = directions[controlName];\r\n\t\t}\r\n\t},\r\n\tcreateTilingArea: function(areaBody, sprite) { // REMOVE and replace with its own render class\r\n\t\tlet texture = PIXI.Texture.from(sprite);\r\n\t\tlet { angle, position } = areaBody;\r\n\t\tareaBody.setAngle(0);\r\n\t\tlet size = areaBody.bounds.max.sub(areaBody.bounds.min);\r\n\t\tlet tiling = new PIXI.TilingSprite(texture, size.x, size.y);\r\n\t\ttiling.zIndex = -1;\r\n\t\tmainWorld.addChild(tiling);\r\n\r\n\t\tlet spritePos = size.mult(-0.5);\r\n\t\tlet curPosition = position.add(spritePos.rotate(angle));\r\n\t\ttiling.rotation = angle;\r\n\t\ttiling.position.set(curPosition.x, curPosition.y);\r\n\t\ttiling.spritePos = spritePos;\r\n\r\n\t\ttiling.delete = function() {\r\n\t\t\tmainWorld.removeChild(tiling);\r\n\t\t\ttiling.destroy();\r\n\t\t}\r\n\r\n\t\tareaBody.setAngle(angle);\r\n\r\n\t\treturn tiling;\r\n\t},\r\n}\r\n","\"use strict\";\r\n\r\nmodule.exports = class Bezier {\r\n\tconstructor(pt1, cp1, cp2, pt2) { // start, control 1, control 2, end\r\n\t\t// https://javascript.info/bezier-curve\r\n\t\t// P = ((1−t)^3 * P1) + (3(1−t)^2 * t * P2) + (3(1−t) * t^2 * P3) + (t^3 * P4)\r\n\t\t// arc length = ∫a^b √[1 + (dy/dx)^2] dx\r\n\t\t// arc length = ∫a^b\r\n\r\n\t\tif (pt1.a && pt1.b) {\r\n\t\t\tthis.a = new vec(pt1.a);\r\n\t\t\tthis.b = new vec(pt1.b);\r\n\t\t\tthis.c = new vec(pt1.c);\r\n\t\t\tthis.d = new vec(pt1.d);\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis.a = new vec(pt1);\r\n\t\t\tthis.b = new vec(cp1);\r\n\t\t\tthis.c = new vec(cp2);\r\n\t\t\tthis.d = new vec(pt2);\r\n\t\t}\r\n\r\n\t\tthis.length = this.getLength();\r\n\t}\r\n\tgetAtT(t) {\r\n\t\tlet x = (this.a.x * (1 - t)**3) + (3*this.b.x * t * (1 - t)**2) + (3*this.c.x * (1 - t) * t**2) + (this.d.x * t**3);\r\n\t\tlet y = (this.a.y * (1 - t)**3) + (3*this.b.y * t * (1 - t)**2) + (3*this.c.y * (1 - t) * t**2) + (this.d.y * t**3);\r\n\r\n\t\treturn new vec(x, y);\r\n\t}\r\n\tgetLength(dt = 0.01) {\r\n\t\tlet lastPt = this.getAtT(0);\r\n\t\tlet len = 0;\r\n\t\tfor (let t = dt; t <= 1; t += dt) {\r\n\t\t\tlet pt = this.getAtT(t);\r\n\t\t\tlen += pt.sub(lastPt).length;\r\n\t\t\tlastPt = pt;\r\n\t\t}\r\n\t\tlen += this.getAtT(1).sub(lastPt).length;\r\n\r\n\t\treturn len;\r\n\t}\r\n\tget(d) {\r\n\t\treturn this.getAtT(d / this.length);\r\n\t}\r\n\tgetDxAtT(t) { // 1st derivative\r\n\t\tlet x = 3 * ((this.d.x - 3*this.c.x + 3*this.b.x - this.a.x) * t ** 2 + (2*this.c.x - 4*this.b.x + 2*this.a.x) * t + this.b.x - this.a.x);\r\n\t\tlet y = 3 * ((this.d.y - 3*this.c.y + 3*this.b.y - this.a.y) * t ** 2 + (2*this.c.y - 4*this.b.y + 2*this.a.y) * t + this.b.y - this.a.y);\r\n\r\n\t\treturn new vec(x, y);\r\n\t}\r\n\tgetDx(d) {\r\n\t\treturn this.getDxAtT(d / this.length);\r\n\t}\r\n\tgetDx2AtT(t) { // 2nd derivative\r\n\t\tlet x = 6 * ((this.d.x - 3*this.c.x + 3*this.b.x - this.a.x) * t + this.c.x - 2*this.b.x + this.a.x);\r\n\t\tlet y = 6 * ((this.d.y - 3*this.c.y + 3*this.b.y - this.a.y) * t + this.c.y - 2*this.b.y + this.a.y);\r\n\r\n\t\treturn new vec(x, y);\r\n\t}\r\n\tgetDx2(d) {\r\n\t\treturn this.getDx2AtT(d / this.length);\r\n\t}\r\n\r\n\trender() {\r\n\t\tctx.beginPath();\r\n\t\tfor (let t = 0; t < this.length; t += 10) {\r\n\t\t\tlet pt = this.get(t);\r\n\r\n\t\t\tif (t === 0) {\r\n\t\t\t\tctx.moveTo(pt.x, pt.y);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tctx.lineTo(pt.x, pt.y);\r\n\t\t\t}\r\n\t\t}\r\n\t\tctx.strokeStyle = \"#ff0000\";\r\n\t\tctx.lineWidth = 1 / camera.scale;\r\n\t\tctx.stroke();\r\n\t}\r\n\trenderDx() {\r\n\t\tctx.strokeStyle = \"#000000\";\r\n\t\tctx.lineWidth = 1 / camera.scale;\r\n\r\n\r\n\t\tfor (let t = 10; t < this.length; t += 10) {\r\n\t\t\tlet pt = this.get(t);\r\n\t\t\tlet lastPt = this.get(t - 10);\r\n\r\n\t\t\tctx.lineWidth = this.getDx(t).length ** 2 * 0.0001 / camera.scale;\r\n\r\n\t\t\tctx.beginPath();\r\n\t\t\tctx.moveTo(lastPt.x, lastPt.y);\r\n\t\t\tctx.lineTo(pt.x, pt.y);\r\n\t\t\tctx.stroke();\r\n\r\n\t\t}\r\n\t}\r\n\ttoObject() {\r\n\t\treturn {\r\n\t\t\ta: this.a.toObject(),\r\n\t\t\tb: this.b.toObject(),\r\n\t\t\tc: this.c.toObject(),\r\n\t\t\td: this.d.toObject(),\r\n\t\t};\r\n\t}\r\n}\r\n","const vec = require(\"../geometry/vec\");\r\n\r\nmodule.exports = class Bounds {\r\n\tmin = new vec(0, 0);\r\n\tmax = new vec(0, 0);\r\n\tconstructor(min, max) {\r\n\t\tif (Array.isArray(min)) { // min is an array of vecs\r\n\t\t\tthis.update(min);\r\n\t\t}\r\n\t\telse if (min.min && min.max) { // min is a bounds object\r\n\t\t\tthis.min.set(min.min);\r\n\t\t\tthis.max.set(min.max);\r\n\t\t}\r\n\t\telse { // min and max are vectors\r\n\t\t\tthis.min.set(min);\r\n\t\t\tthis.max.set(max);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Updates the bounds based on an array vertices\r\n\t * @param {Array} - Array of vertices \r\n\t */\r\n\tupdate(vertices) {\r\n\t\tlet minX = Infinity, minY = Infinity;\r\n\t\tlet maxX = -Infinity, maxY = -Infinity;\r\n\t\r\n\t\tfor (let i = 0; i < vertices.length; i++) {\r\n\t\t\tlet v = vertices[i];\r\n\t\r\n\t\t\tif (v.x < minX) minX = v.x;\r\n\t\t\tif (v.x > maxX) maxX = v.x;\r\n\t\t\tif (v.y < minY) minY = v.y;\r\n\t\t\tif (v.y > maxY) maxY = v.y;\r\n\t\t}\r\n\t\r\n\t\tthis.min.x = minX;\r\n\t\tthis.min.y = minY;\r\n\t\tthis.max.x = maxX;\r\n\t\tthis.max.y = maxY;\r\n\t}\r\n\r\n\t/**\r\n\t * Creates a random point within the bounds\r\n\t * @returns {vec} Random point within bounds\r\n\t */\r\n\trandomPoint() {\r\n\r\n\t}\r\n}\r\n","\"use strict\";\r\n\r\nconst { arrayDelete } = require(\"../core/Common.js\");\r\n\r\nmodule.exports = class Grid {\r\n\tstatic id = 0;\r\n\tgrid = {};\r\n\tgridIds = new Set();\r\n\tgridSize = 2000;\r\n\tconstructor(size = 2000) {\r\n\t\tthis.gridSize = size;\r\n\t\tthis.id = Grid.id++;\r\n\t}\r\n\tpair = function(pos) {\r\n\t\tlet x = pos.x >= 0 ? pos.x * 2 : pos.x * -2 - 1;\r\n\t\tlet y = pos.y >= 0 ? pos.y * 2 : pos.y * -2 - 1;\r\n\t\treturn (x >= y) ? (x * x + x + y) : (y * y + x);\r\n\t}\r\n\tunpair = function(n) {\r\n\t\tlet sqrtz = Math.floor(Math.sqrt(n));\r\n\t\tlet sqz = sqrtz * sqrtz;\r\n\t\tlet result1 = ((n - sqz) >= sqrtz) ? new vec(sqrtz, n - sqz - sqrtz) : new vec(n - sqz, sqrtz);\r\n\t\tlet x = result1.x % 2 === 0 ? result1.x / 2 : (result1.x + 1) / -2;\r\n\t\tlet y = result1.y % 2 === 0 ? result1.y / 2 : (result1.y + 1) / -2;\r\n\t\treturn new vec(x, y);\r\n\t}\r\n\tgetBounds = function(body) {\r\n\t\tlet size = this.gridSize;\r\n\t\tif (typeof body.bounds === \"object\") {\r\n\t\t\treturn {\r\n\t\t\t\tmin: body.bounds.min.div(size).floor2(),\r\n\t\t\t\tmax: body.bounds.max.div(size).floor2(),\r\n\t\t\t}\r\n\t\t}\r\n\t\telse if (body.x !== undefined && body.y !== undefined) {\r\n\t\t\tlet x = Math.floor(body.x / size);\r\n\t\t\tlet y = Math.floor(body.y / size);\r\n\t\t\treturn {\r\n\t\t\t\tmin: new vec(x, y),\r\n\t\t\t\tmax: new vec(x, y),\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tgetBucketIds = function(bounds) {\r\n\t\tlet ids = [];\r\n\t\tfor (let x = bounds.min.x; x <= bounds.max.x; x++) {\r\n\t\t\tfor (let y = bounds.min.y; y <= bounds.max.y; y++) {\r\n\t\t\t\tlet n = this.pair(new vec(x, y));\r\n\r\n\t\t\t\tif (this.grid[n]) {\r\n\t\t\t\t\tids.push(n);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn ids;\r\n\t}\r\n\r\n\taddBody = function(body) {\r\n\t\tlet bounds = this.getBounds(body);\r\n\r\n\t\tif (!body._Grids) body._Grids = {};\r\n\t\tif (!body._Grids[this.id]) body._Grids[this.id] = [];\r\n\r\n\t\tfor (let x = bounds.min.x; x <= bounds.max.x; x++) {\r\n\t\t\tfor (let y = bounds.min.y; y <= bounds.max.y; y++) {\r\n\t\t\t\tlet n = this.pair(new vec(x, y));\r\n\r\n\t\t\t\tbody._Grids[this.id].push(n);\r\n\t\t\t\tif (!this.grid[n]) {\r\n\t\t\t\t\tthis.grid[n] = [];\r\n\t\t\t\t\tthis.gridIds.add(n);\r\n\t\t\t\t}\r\n\t\t\t\tthis.grid[n].push(body);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tremoveBody = function(body) {\r\n\t\tfor (let n of body._Grids[this.id]) {\r\n\t\t\tlet node = this.grid[n];\r\n\t\t\tif (node) {\r\n\t\t\t\tarrayDelete(node, body);\r\n\t\t\t\tif (node.length === 0) {\r\n\t\t\t\t\tdelete this.grid[n];\r\n\t\t\t\t\tthis.gridIds.delete(n);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\taddPoint = function(point) {\r\n\t\tif (!point._Grids) point._Grids = {};\r\n\t\tif (!point._Grids[this.id]) point._Grids[this.id] = [];\r\n\r\n\t\tlet position = point.x ? point : point.position;\r\n\t\tlet bucketPos = position.div(this.gridSize).floor2();\r\n\t\tlet n = this.pair(bucketPos);\r\n\t\tpoint._Grids[this.id].push(n);\r\n\t\tif (!this.grid[n]) {\r\n\t\t\tthis.grid[n] = [];\r\n\t\t\tthis.gridIds.add(n);\r\n\t\t}\r\n\t\tthis.grid[n].push(point);\r\n\t}\r\n\tremovePoint = function(point) {\r\n\t\tif (!point._Grids) console.log(point._Grids);\r\n\t\tfor (let n of point._Grids[this.id]) {\r\n\t\t\tlet node = this.grid[n];\r\n\t\t\tif (node) {\r\n\t\t\t\tarrayDelete(node, point);\r\n\t\t\t\tif (node.length === 0) {\r\n\t\t\t\t\tdelete this.grid[n];\r\n\t\t\t\t\tthis.gridIds.delete(n);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tupdateBody = function(body) {\r\n\t\tlet curNodes = body._Grids[this.id];\r\n\t\tlet oldNodes = new Set(curNodes);\r\n\t\tlet bounds = this.getBounds(body);\r\n\r\n\t\tfor (let x = bounds.min.x; x <= bounds.max.x; x++) {\r\n\t\t\tfor (let y = bounds.min.y; y <= bounds.max.y; y++) {\r\n\t\t\t\tlet n = this.pair(new vec(x, y));\r\n\r\n\t\t\t\tif (!oldNodes.has(n)) {\r\n\t\t\t\t\tcurNodes.push(n);\r\n\t\t\t\t\tif (!this.grid[n]) {\r\n\t\t\t\t\t\tthis.grid[n] = [];\r\n\t\t\t\t\t\tthis.gridIds.add(n);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.grid[n].push(body);\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\toldNodes.delete(n);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (let n of oldNodes) {\r\n\t\t\tlet node = this.grid[n];\r\n\t\t\tarrayDelete(curNodes, n);\r\n\t\t\tif (!node) continue;\r\n\t\t\tarrayDelete(node, body);\r\n\t\t\tif (node.length === 0) {\r\n\t\t\t\tdelete this.grid[n];\r\n\t\t\t\tthis.gridIds.delete(n);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n","module.exports = class vec {\r\n\tconstructor(x, y) {\r\n\t\tif (typeof x === \"object\") {\r\n\t\t\tif (Array.isArray(x)) {\r\n\t\t\t\tthis.x = x[0];\r\n\t\t\t\tthis.y = x[1];\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tthis.x = x.x;\r\n\t\t\t\tthis.y = x.y;\r\n\t\t\t}\r\n\t\t}\r\n\t\telse if (typeof x === \"number\" && y === undefined) {\r\n\t\t\tthis.x = Math.cos(x);\r\n\t\t\tthis.y = Math.sin(x);\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis.x = x;\r\n\t\t\tthis.y = y;\r\n\t\t}\r\n\r\n\t\treturn this;\r\n\t}\r\n\tadd(vec2) {\r\n\t\tif (typeof vec2 === \"number\") {\r\n\t\t\treturn new vec(this.x + vec2, this.y + vec2);\r\n\t\t}\r\n\t\telse {\r\n\t\t\treturn new vec(this.x + vec2.x, this.y + vec2.y);\r\n\t\t}\r\n\t}\r\n\tsub(vec2) {\r\n\t\tif (typeof vec2 === \"number\") {\r\n\t\t\treturn new vec(this.x - vec2, this.y - vec2);\r\n\t\t}\r\n\t\telse {\r\n\t\t\treturn new vec(this.x - vec2.x, this.y - vec2.y);\r\n\t\t}\r\n\t}\r\n\tmult(vec2) {\r\n\t\tif (typeof vec2 === \"number\") {\r\n\t\t\treturn new vec(this.x * vec2, this.y * vec2);\r\n\t\t}\r\n\t\telse {\r\n\t\t\treturn new vec(this.x * vec2.x, this.y * vec2.y);\r\n\t\t}\r\n\t}\r\n\tdiv(vec2) {\r\n\t\tif (typeof vec2 === \"number\") {\r\n\t\t\treturn new vec(this.x / vec2, this.y / vec2);\r\n\t\t}\r\n\t\telse {\r\n\t\t\treturn new vec(this.x / vec2.x, this.y / vec2.y);\r\n\t\t}\r\n\t}\r\n\tadd2(vec2) {\r\n\t\tif (typeof vec2 === \"number\") {\r\n\t\t\tthis.x += vec2;\r\n\t\t\tthis.y += vec2;\r\n\t\t\treturn this;\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis.x += vec2.x;\r\n\t\t\tthis.y += vec2.y;\r\n\t\t\treturn this;\r\n\t\t}\r\n\t}\r\n\tsub2(vec2) {\r\n\t\tif (typeof vec2 === \"number\") {\r\n\t\t\tthis.x -= vec2;\r\n\t\t\tthis.y -= vec2;\r\n\t\t\treturn this;\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis.x -= vec2.x;\r\n\t\t\tthis.y -= vec2.y;\r\n\t\t\treturn this;\r\n\t\t}\r\n\t}\r\n\tmult2(vec2) {\r\n\t\tif (typeof vec2 === \"number\") {\r\n\t\t\tthis.x *= vec2;\r\n\t\t\tthis.y *= vec2;\r\n\t\t\treturn this;\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis.x *= vec2.x;\r\n\t\t\tthis.y *= vec2.y;\r\n\t\t\treturn this;\r\n\t\t}\r\n\t}\r\n\tdiv2(vec2) {\r\n\t\tif (typeof vec2 === \"number\") {\r\n\t\t\tthis.x /= vec2;\r\n\t\t\tthis.y /= vec2;\r\n\t\t\treturn this;\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis.x /= vec2.x;\r\n\t\t\tthis.y /= vec2.y;\r\n\t\t\treturn this;\r\n\t\t}\r\n\t}\r\n\tpow(vec2) {\r\n\t\tif (typeof vec2 === \"number\") {\r\n\t\t\treturn new vec(this.x ** vec2, this.y ** vec2);\r\n\t\t}\r\n\t\telse {\r\n\t\t\treturn new vec(this.x ** vec2.x, this.y ** vec2.y);\r\n\t\t}\r\n\t}\r\n\tpow2(vec2) {\r\n\t\tif (typeof vec2 === \"number\") {\r\n\t\t\tthis.x = this.x ** vec2;\r\n\t\t\tthis.y = this.y ** vec2;\r\n\t\t\treturn this;\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis.x = this.x ** vec2.x;\r\n\t\t\tthis.y = this.y ** vec2.y;\r\n\t\t\treturn this;\r\n\t\t}\r\n\t}\r\n\tsign() {\r\n\t\treturn new vec(Math.sign(this.x), Math.sign(this.y));\r\n\t}\r\n\tsign2() {\r\n\t\tthis.x = Math.sign(this.x);\r\n\t\tthis.y = Math.sign(this.y);\r\n\t\treturn this;\r\n\t}\r\n\tmod(vec2) {\r\n\t\tif (typeof vec2 === \"number\")\r\n\t\t\treturn new vec(this.x % vec2, this.y % vec2);\r\n\t\treturn new vec(this.x % vec2.x, this.y % vec2.y);\r\n\t}\r\n\tmod2(vec2) {\r\n\t\tif (typeof vec2 === \"number\") {\r\n\t\t\tthis.x %= vec2;\r\n\t\t\tthis.y %= vec2;\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis.x %= vec2.x;\r\n\t\t\tthis.y %= vec2.y;\r\n\t\t}\r\n\t\treturn this;\r\n\t}\r\n\tdot(vec2) {\r\n\t\treturn this.x * vec2.x + this.y * vec2.y;\r\n\t}\r\n\tcross(vec2) {\r\n\t\tif (typeof vec2 === \"number\") {\r\n\t\t\treturn new vec(-vec2 * this.y, vec2 * this.x);\r\n\t\t}\r\n\t\telse {\r\n\t\t\treturn this.x * vec2.y - this.y * vec2.x;\r\n\t\t}\r\n\t}\r\n\tavg(vec2, weight = 0.5) {\r\n\t\tlet weight2 = 1 - weight;\r\n\t\treturn new vec(this.x * weight + vec2.x * weight2, this.y * weight + vec2.y * weight2);\r\n\t}\r\n\tget length() {\r\n\t\treturn Math.sqrt(this.x * this.x + this.y * this.y);\r\n\t}\r\n\tset length(len) {\r\n\t\tlet scale = len / this.length;\r\n\t\tthis.x *= scale;\r\n\t\tthis.y *= scale;\r\n\r\n\t\treturn this;\r\n\t}\r\n\tget angle() {\r\n\t\treturn Math.atan2(this.y, this.x);\r\n\t}\r\n\tget area() {\r\n\t\treturn this.x * this.y;\r\n\t}\r\n\tmanhattan(vec2) {\r\n\t\treturn Math.abs(vec2.x - this.x) + Math.abs(vec2.y - this.y);\r\n\t}\r\n\tabs() {\r\n\t\treturn new vec(Math.abs(this.x), Math.abs(this.y));\r\n\t}\r\n\tabs2() {\r\n\t\tthis.x = Math.abs(this.x);\r\n\t\tthis.y = Math.abs(this.y);\r\n\t\treturn this;\r\n\t}\r\n\treflect(vec2) { // vec2 must be normalized\r\n\t\t// Vect2 = Vect1 - 2 * WallN * (WallN DOT Vect1)\r\n\t\tlet v2 = vec2.normal();\r\n\t\treturn this.sub(v2.mult(v2.dot(this) * 2));\r\n\t}\r\n\treflect2(vec2) { // vec2 must be normalized\r\n\t\tlet v2 = vec2.normal();\r\n\t\treturn this.sub2(v2.mult(v2.dot(this) * 2));\r\n\t}\r\n\trotate(angle) {\r\n\t\treturn new vec(Math.cos(angle) * this.x - Math.sin(angle) * this.y, Math.sin(angle) * this.x + Math.cos(angle) * this.y);\r\n\t}\r\n\trotate2(angle) {\r\n\t\tlet x = Math.cos(angle) * this.x - Math.sin(angle) * this.y;\r\n\t\tthis.y = Math.sin(angle) * this.x + Math.cos(angle) * this.y;\r\n\t\tthis.x = x;\r\n\t\treturn this;\r\n\t}\r\n\tproject(vec2, bound = false) { // projects this vector onto the other one\r\n\t\tlet d1 = this.dot(vec2);\r\n\t\tlet d2 = vec2.x * vec2.x + vec2.y * vec2.y;\r\n\r\n\t\tif (bound) {\r\n\t\t\td1 = Math.max(0, Math.min(d2, d1));\r\n\t\t}\r\n\r\n\t\treturn new vec(d1 * vec2.x / d2, d1 * vec2.y / d2);\r\n\t}\r\n\tproject2(vec2, bound = false) { // projects this vector onto the other one\r\n\t\tlet d1 = this.dot(vec2);\r\n\t\tlet d2 = vec2.x * vec2.x + vec2.y * vec2.y;\r\n\r\n\t\tif (bound) {\r\n\t\t\td1 = Math.max(0, Math.min(d2, d1));\r\n\t\t}\r\n\r\n\t\tthis.x = d1 * vec2.x / d2;\r\n\t\tthis.y = d1 * vec2.y / d2;\r\n\r\n\t\treturn this;\r\n\t}\r\n\tnormalize() {\r\n\t\tlet len = this.length;\r\n\t\tif (len === 0) return new vec(this);\r\n\t\treturn new vec(this.x / len, this.y / len);\r\n\t}\r\n\tnormalize2() {\r\n\t\tlet len = this.length;\r\n\t\tif (len === 0) return this;\r\n\t\tthis.x /= len;\r\n\t\tthis.y /= len;\r\n\t\treturn this;\r\n\t}\r\n\tnormal() { // left hand normal\r\n\t\treturn new vec(this.y, -this.x);\r\n\t}\r\n\tnormal2() { // left hand normal\r\n\t\tlet y = this.y;\r\n\t\tthis.y = -this.x;\r\n\t\tthis.x = y;\r\n\t\treturn this;\r\n\t}\r\n\tfloor() {\r\n\t\treturn new vec(Math.floor(this.x), Math.floor(this.y));\r\n\t}\r\n\tfloor2() {\r\n\t\tthis.x = Math.floor(this.x);\r\n\t\tthis.y = Math.floor(this.y);\r\n\t\treturn this;\r\n\t}\r\n\tceil() {\r\n\t\treturn new vec(Math.ceil(this.x), Math.ceil(this.y));\r\n\t}\r\n\tceil2() {\r\n\t\tthis.x = Math.ceil(this.x);\r\n\t\tthis.y = Math.ceil(this.y);\r\n\t\treturn this;\r\n\t}\r\n\tround() {\r\n\t\treturn new vec(Math.round(this.x), Math.round(this.y));\r\n\t}\r\n\tround2() {\r\n\t\tthis.x = Math.round(this.x);\r\n\t\tthis.y = Math.round(this.y);\r\n\t\treturn this;\r\n\t}\r\n\tmin(vec2) {\r\n\t\treturn new vec(Math.min(vec2.x, this.x), Math.min(vec2.y, this.y));\r\n\t}\r\n\tmin2(vec2) {\r\n\t\tthis.x = Math.min(this.x, vec2.x);\r\n\t\tthis.y = Math.min(this.y, vec2.y);\r\n\t\treturn this;\r\n\t}\r\n\tmax(vec2) {\r\n\t\treturn new vec(Math.max(vec2.x, this.x), Math.max(vec2.y, this.y));\r\n\t}\r\n\tmax2(vec2) {\r\n\t\tthis.x = Math.max(this.x, vec2.x);\r\n\t\tthis.y = Math.max(this.y, vec2.y);\r\n\t\treturn this;\r\n\t}\r\n\tclamp(min, max) {\r\n\t\treturn new vec(Math.max(min.x, Math.min(max.x, this.x)), Math.max(min.y, Math.min(max.y, this.y)));\r\n\t}\r\n\tclamp2(min, max) {\r\n\t\tthis.x = Math.max(min.x, Math.min(max.x, this.x));\r\n\t\tthis.y = Math.max(min.y, Math.min(max.y, this.y));\r\n\t\treturn this;\r\n\t}\r\n\tequals(vec2) {\r\n\t\treturn this.x === vec2.x && this.y === vec2.y;\r\n\t}\r\n\tset(vec2) {\r\n\t\tthis.x = vec2.x;\r\n\t\tthis.y = vec2.y;\r\n\t\treturn this;\r\n\t}\r\n\ttoString() {\r\n\t\treturn `{ x: ${ this.x }, y: ${ this.y } }`;\r\n\t}\r\n\ttoStringInt() {\r\n\t\treturn `{ x: ${ Math.round(this.x) }, y: ${ Math.round(this.y) } }`;\r\n\t}\r\n\ttoObject() {\r\n\t\treturn { x: this.x, y: this.y };\r\n\t}\r\n\ttoArray() {\r\n\t\treturn [this.x, this.y];\r\n\t}\r\n\tisNaN() {\r\n\t\treturn isNaN(this.x) || isNaN(this.y);\r\n\t}\r\n}\r\n","/*\r\nThe MIT License (MIT)\r\n\r\nCopyright (c) 2013 Stefan Hedman\r\n\r\nPermission is hereby granted, free of charge, to any person obtaining a copy of\r\nthis software and associated documentation files (the \"Software\"), to deal in\r\nthe Software without restriction, including without limitation the rights to\r\nuse, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of\r\nthe Software, and to permit persons to whom the Software is furnished to do so,\r\nsubject to the following conditions:\r\n\r\nThe above copyright notice and this permission notice shall be included in all\r\ncopies or substantial portions of the Software.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\r\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS\r\nFOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR\r\nCOPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER\r\nIN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN\r\nCONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\r\n*/\r\n\r\nmodule.exports = {\r\n    decomp: polygonDecomp,\r\n    quickDecomp: polygonQuickDecomp,\r\n    isSimple: polygonIsSimple,\r\n    removeCollinearPoints: polygonRemoveCollinearPoints,\r\n    removeDuplicatePoints: polygonRemoveDuplicatePoints,\r\n    makeCCW: polygonMakeCCW\r\n};\r\n\r\n/**\r\n * Compute the intersection between two lines.\r\n * @static\r\n * @method lineInt\r\n * @param  {Array}  l1          Line vector 1\r\n * @param  {Array}  l2          Line vector 2\r\n * @param  {Number} precision   Precision to use when checking if the lines are parallel\r\n * @return {Array}              The intersection point.\r\n */\r\nfunction lineInt(l1,l2,precision){\r\n    precision = precision || 0;\r\n    var i = [0,0]; // point\r\n    var a1, b1, c1, a2, b2, c2, det; // scalars\r\n    a1 = l1[1][1] - l1[0][1];\r\n    b1 = l1[0][0] - l1[1][0];\r\n    c1 = a1 * l1[0][0] + b1 * l1[0][1];\r\n    a2 = l2[1][1] - l2[0][1];\r\n    b2 = l2[0][0] - l2[1][0];\r\n    c2 = a2 * l2[0][0] + b2 * l2[0][1];\r\n    det = a1 * b2 - a2*b1;\r\n    if (!scalar_eq(det, 0, precision)) { // lines are not parallel\r\n        i[0] = (b2 * c1 - b1 * c2) / det;\r\n        i[1] = (a1 * c2 - a2 * c1) / det;\r\n    }\r\n    return i;\r\n}\r\n\r\n/**\r\n * Checks if two line segments intersects.\r\n * @method segmentsIntersect\r\n * @param {Array} p1 The start vertex of the first line segment.\r\n * @param {Array} p2 The end vertex of the first line segment.\r\n * @param {Array} q1 The start vertex of the second line segment.\r\n * @param {Array} q2 The end vertex of the second line segment.\r\n * @return {Boolean} True if the two line segments intersect\r\n */\r\nfunction lineSegmentsIntersect(p1, p2, q1, q2){\r\n\tvar dx = p2[0] - p1[0];\r\n\tvar dy = p2[1] - p1[1];\r\n\tvar da = q2[0] - q1[0];\r\n\tvar db = q2[1] - q1[1];\r\n\r\n\t// segments are parallel\r\n\tif((da*dy - db*dx) === 0){\r\n\t\treturn false;\r\n\t}\r\n\r\n\tvar s = (dx * (q1[1] - p1[1]) + dy * (p1[0] - q1[0])) / (da * dy - db * dx);\r\n\tvar t = (da * (p1[1] - q1[1]) + db * (q1[0] - p1[0])) / (db * dx - da * dy);\r\n\r\n\treturn (s>=0 && s<=1 && t>=0 && t<=1);\r\n}\r\n\r\n/**\r\n * Get the area of a triangle spanned by the three given points. Note that the area will be negative if the points are not given in counter-clockwise order.\r\n * @static\r\n * @method area\r\n * @param  {Array} a\r\n * @param  {Array} b\r\n * @param  {Array} c\r\n * @return {Number}\r\n */\r\nfunction triangleArea(a,b,c){\r\n    return (((b[0] - a[0])*(c[1] - a[1]))-((c[0] - a[0])*(b[1] - a[1])));\r\n}\r\n\r\nfunction isLeft(a,b,c){\r\n    return triangleArea(a,b,c) > 0;\r\n}\r\n\r\nfunction isLeftOn(a,b,c) {\r\n    return triangleArea(a, b, c) >= 0;\r\n}\r\n\r\nfunction isRight(a,b,c) {\r\n    return triangleArea(a, b, c) < 0;\r\n}\r\n\r\nfunction isRightOn(a,b,c) {\r\n    return triangleArea(a, b, c) <= 0;\r\n}\r\n\r\nvar tmpPoint1 = [],\r\n    tmpPoint2 = [];\r\n\r\n/**\r\n * Check if three points are collinear\r\n * @method collinear\r\n * @param  {Array} a\r\n * @param  {Array} b\r\n * @param  {Array} c\r\n * @param  {Number} [thresholdAngle=0] Threshold angle to use when comparing the vectors. The function will return true if the angle between the resulting vectors is less than this value. Use zero for max precision.\r\n * @return {Boolean}\r\n */\r\nfunction collinear(a,b,c,thresholdAngle) {\r\n    if(!thresholdAngle){\r\n        return triangleArea(a, b, c) === 0;\r\n    } else {\r\n        var ab = tmpPoint1,\r\n            bc = tmpPoint2;\r\n\r\n        ab[0] = b[0]-a[0];\r\n        ab[1] = b[1]-a[1];\r\n        bc[0] = c[0]-b[0];\r\n        bc[1] = c[1]-b[1];\r\n\r\n        var dot = ab[0]*bc[0] + ab[1]*bc[1],\r\n            magA = Math.sqrt(ab[0]*ab[0] + ab[1]*ab[1]),\r\n            magB = Math.sqrt(bc[0]*bc[0] + bc[1]*bc[1]),\r\n            angle = Math.acos(dot/(magA*magB));\r\n        return angle < thresholdAngle;\r\n    }\r\n}\r\n\r\nfunction sqdist(a,b){\r\n    var dx = b[0] - a[0];\r\n    var dy = b[1] - a[1];\r\n    return dx * dx + dy * dy;\r\n}\r\n\r\n/**\r\n * Get a vertex at position i. It does not matter if i is out of bounds, this function will just cycle.\r\n * @method at\r\n * @param  {Number} i\r\n * @return {Array}\r\n */\r\nfunction polygonAt(polygon, i){\r\n    var s = polygon.length;\r\n    return polygon[i < 0 ? i % s + s : i % s];\r\n}\r\n\r\n/**\r\n * Clear the polygon data\r\n * @method clear\r\n * @return {Array}\r\n */\r\nfunction polygonClear(polygon){\r\n    polygon.length = 0;\r\n}\r\n\r\n/**\r\n * Append points \"from\" to \"to\"-1 from an other polygon \"poly\" onto this one.\r\n * @method append\r\n * @param {Polygon} poly The polygon to get points from.\r\n * @param {Number}  from The vertex index in \"poly\".\r\n * @param {Number}  to The end vertex index in \"poly\". Note that this vertex is NOT included when appending.\r\n * @return {Array}\r\n */\r\nfunction polygonAppend(polygon, poly, from, to){\r\n    for(var i=from; i<to; i++){\r\n        polygon.push(poly[i]);\r\n    }\r\n}\r\n\r\n/**\r\n * Make sure that the polygon vertices are ordered counter-clockwise.\r\n * @method makeCCW\r\n */\r\nfunction polygonMakeCCW(polygon){\r\n    var br = 0,\r\n        v = polygon;\r\n\r\n    // find bottom right point\r\n    for (var i = 1; i < polygon.length; ++i) {\r\n        if (v[i][1] < v[br][1] || (v[i][1] === v[br][1] && v[i][0] > v[br][0])) {\r\n            br = i;\r\n        }\r\n    }\r\n\r\n    // reverse poly if clockwise\r\n    if (!isLeft(polygonAt(polygon, br - 1), polygonAt(polygon, br), polygonAt(polygon, br + 1))) {\r\n        polygonReverse(polygon);\r\n        return true;\r\n    } else {\r\n        return false;\r\n    }\r\n}\r\n\r\n/**\r\n * Reverse the vertices in the polygon\r\n * @method reverse\r\n */\r\nfunction polygonReverse(polygon){\r\n    var tmp = [];\r\n    var N = polygon.length;\r\n    for(var i=0; i!==N; i++){\r\n        tmp.push(polygon.pop());\r\n    }\r\n    for(var i=0; i!==N; i++){\r\n\t\tpolygon[i] = tmp[i];\r\n    }\r\n}\r\n\r\n/**\r\n * Check if a point in the polygon is a reflex point\r\n * @method isReflex\r\n * @param  {Number}  i\r\n * @return {Boolean}\r\n */\r\nfunction polygonIsReflex(polygon, i){\r\n    return isRight(polygonAt(polygon, i - 1), polygonAt(polygon, i), polygonAt(polygon, i + 1));\r\n}\r\n\r\nvar tmpLine1=[],\r\n    tmpLine2=[];\r\n\r\n/**\r\n * Check if two vertices in the polygon can see each other\r\n * @method canSee\r\n * @param  {Number} a Vertex index 1\r\n * @param  {Number} b Vertex index 2\r\n * @return {Boolean}\r\n */\r\nfunction polygonCanSee(polygon, a,b) {\r\n    var p, dist, l1=tmpLine1, l2=tmpLine2;\r\n\r\n    if (isLeftOn(polygonAt(polygon, a + 1), polygonAt(polygon, a), polygonAt(polygon, b)) && isRightOn(polygonAt(polygon, a - 1), polygonAt(polygon, a), polygonAt(polygon, b))) {\r\n        return false;\r\n    }\r\n    dist = sqdist(polygonAt(polygon, a), polygonAt(polygon, b));\r\n    for (var i = 0; i !== polygon.length; ++i) { // for each edge\r\n        if ((i + 1) % polygon.length === a || i === a){ // ignore incident edges\r\n            continue;\r\n        }\r\n        if (isLeftOn(polygonAt(polygon, a), polygonAt(polygon, b), polygonAt(polygon, i + 1)) && isRightOn(polygonAt(polygon, a), polygonAt(polygon, b), polygonAt(polygon, i))) { // if diag intersects an edge\r\n            l1[0] = polygonAt(polygon, a);\r\n            l1[1] = polygonAt(polygon, b);\r\n            l2[0] = polygonAt(polygon, i);\r\n            l2[1] = polygonAt(polygon, i + 1);\r\n            p = lineInt(l1,l2);\r\n            if (sqdist(polygonAt(polygon, a), p) < dist) { // if edge is blocking visibility to b\r\n                return false;\r\n            }\r\n        }\r\n    }\r\n\r\n    return true;\r\n}\r\n\r\n/**\r\n * Check if two vertices in the polygon can see each other\r\n * @method canSee2\r\n * @param  {Number} a Vertex index 1\r\n * @param  {Number} b Vertex index 2\r\n * @return {Boolean}\r\n */\r\nfunction polygonCanSee2(polygon, a,b) {\r\n    // for each edge\r\n    for (var i = 0; i !== polygon.length; ++i) {\r\n        // ignore incident edges\r\n        if (i === a || i === b || (i + 1) % polygon.length === a || (i + 1) % polygon.length === b){\r\n            continue;\r\n        }\r\n        if( lineSegmentsIntersect(polygonAt(polygon, a), polygonAt(polygon, b), polygonAt(polygon, i), polygonAt(polygon, i+1)) ){\r\n            return false;\r\n        }\r\n    }\r\n    return true;\r\n}\r\n\r\n/**\r\n * Copy the polygon from vertex i to vertex j.\r\n * @method copy\r\n * @param  {Number} i\r\n * @param  {Number} j\r\n * @param  {Polygon} [targetPoly]   Optional target polygon to save in.\r\n * @return {Polygon}                The resulting copy.\r\n */\r\nfunction polygonCopy(polygon, i,j,targetPoly){\r\n    var p = targetPoly || [];\r\n    polygonClear(p);\r\n    if (i < j) {\r\n        // Insert all vertices from i to j\r\n        for(var k=i; k<=j; k++){\r\n            p.push(polygon[k]);\r\n        }\r\n\r\n    } else {\r\n\r\n        // Insert vertices 0 to j\r\n        for(var k=0; k<=j; k++){\r\n            p.push(polygon[k]);\r\n        }\r\n\r\n        // Insert vertices i to end\r\n        for(var k=i; k<polygon.length; k++){\r\n            p.push(polygon[k]);\r\n        }\r\n    }\r\n\r\n    return p;\r\n}\r\n\r\n/**\r\n * Decomposes the polygon into convex pieces. Returns a list of edges [[p1,p2],[p2,p3],...] that cuts the polygon.\r\n * Note that this algorithm has complexity O(N^4) and will be very slow for polygons with many vertices.\r\n * @method getCutEdges\r\n * @return {Array}\r\n */\r\nfunction polygonGetCutEdges(polygon) {\r\n    var min=[], tmp1=[], tmp2=[], tmpPoly = [];\r\n    var nDiags = Number.MAX_VALUE;\r\n\r\n    for (var i = 0; i < polygon.length; ++i) {\r\n        if (polygonIsReflex(polygon, i)) {\r\n            for (var j = 0; j < polygon.length; ++j) {\r\n                if (polygonCanSee(polygon, i, j)) {\r\n                    tmp1 = polygonGetCutEdges(polygonCopy(polygon, i, j, tmpPoly));\r\n                    tmp2 = polygonGetCutEdges(polygonCopy(polygon, j, i, tmpPoly));\r\n\r\n                    for(var k=0; k<tmp2.length; k++){\r\n                        tmp1.push(tmp2[k]);\r\n                    }\r\n\r\n                    if (tmp1.length < nDiags) {\r\n                        min = tmp1;\r\n                        nDiags = tmp1.length;\r\n                        min.push([polygonAt(polygon, i), polygonAt(polygon, j)]);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    return min;\r\n}\r\n\r\n/**\r\n * Decomposes the polygon into one or more convex sub-Polygons.\r\n * @method decomp\r\n * @return {Array} An array or Polygon objects.\r\n */\r\nfunction polygonDecomp(polygon){\r\n    var edges = polygonGetCutEdges(polygon);\r\n    if(edges.length > 0){\r\n        return polygonSlice(polygon, edges);\r\n    } else {\r\n        return [polygon];\r\n    }\r\n}\r\n\r\n/**\r\n * Slices the polygon given one or more cut edges. If given one, this function will return two polygons (false on failure). If many, an array of polygons.\r\n * @method slice\r\n * @param {Array} cutEdges A list of edges, as returned by .getCutEdges()\r\n * @return {Array}\r\n */\r\nfunction polygonSlice(polygon, cutEdges){\r\n    if(cutEdges.length === 0){\r\n\t\treturn [polygon];\r\n    }\r\n    if(cutEdges instanceof Array && cutEdges.length && cutEdges[0] instanceof Array && cutEdges[0].length===2 && cutEdges[0][0] instanceof Array){\r\n\r\n        var polys = [polygon];\r\n\r\n        for(var i=0; i<cutEdges.length; i++){\r\n            var cutEdge = cutEdges[i];\r\n            // Cut all polys\r\n            for(var j=0; j<polys.length; j++){\r\n                var poly = polys[j];\r\n                var result = polygonSlice(poly, cutEdge);\r\n                if(result){\r\n                    // Found poly! Cut and quit\r\n                    polys.splice(j,1);\r\n                    polys.push(result[0],result[1]);\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n\r\n        return polys;\r\n    } else {\r\n\r\n        // Was given one edge\r\n        var cutEdge = cutEdges;\r\n        var i = polygon.indexOf(cutEdge[0]);\r\n        var j = polygon.indexOf(cutEdge[1]);\r\n\r\n        if(i !== -1 && j !== -1){\r\n            return [polygonCopy(polygon, i,j),\r\n                    polygonCopy(polygon, j,i)];\r\n        } else {\r\n            return false;\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Checks that the line segments of this polygon do not intersect each other.\r\n * @method isSimple\r\n * @param  {Array} path An array of vertices e.g. [[0,0],[0,1],...]\r\n * @return {Boolean}\r\n * @todo Should it check all segments with all others?\r\n */\r\nfunction polygonIsSimple(polygon){\r\n    var path = polygon, i;\r\n    // Check\r\n    for(i=0; i<path.length-1; i++){\r\n        for(var j=0; j<i-1; j++){\r\n            if(lineSegmentsIntersect(path[i], path[i+1], path[j], path[j+1] )){\r\n                return false;\r\n            }\r\n        }\r\n    }\r\n\r\n    // Check the segment between the last and the first point to all others\r\n    for(i=1; i<path.length-2; i++){\r\n        if(lineSegmentsIntersect(path[0], path[path.length-1], path[i], path[i+1] )){\r\n            return false;\r\n        }\r\n    }\r\n\r\n    return true;\r\n}\r\n\r\nfunction getIntersectionPoint(p1, p2, q1, q2, delta){\r\n\tdelta = delta || 0;\r\n\tvar a1 = p2[1] - p1[1];\r\n\tvar b1 = p1[0] - p2[0];\r\n\tvar c1 = (a1 * p1[0]) + (b1 * p1[1]);\r\n\tvar a2 = q2[1] - q1[1];\r\n\tvar b2 = q1[0] - q2[0];\r\n\tvar c2 = (a2 * q1[0]) + (b2 * q1[1]);\r\n\tvar det = (a1 * b2) - (a2 * b1);\r\n\r\n\tif(!scalar_eq(det,0,delta)){\r\n\t\treturn [((b2 * c1) - (b1 * c2)) / det, ((a1 * c2) - (a2 * c1)) / det];\r\n\t} else {\r\n\t\treturn [0,0];\r\n    }\r\n}\r\n\r\n/**\r\n * Quickly decompose the Polygon into convex sub-polygons.\r\n * @method quickDecomp\r\n * @param  {Array} result\r\n * @param  {Array} [reflexVertices]\r\n * @param  {Array} [steinerPoints]\r\n * @param  {Number} [delta]\r\n * @param  {Number} [maxlevel]\r\n * @param  {Number} [level]\r\n * @return {Array}\r\n */\r\nfunction polygonQuickDecomp(polygon, result,reflexVertices,steinerPoints,delta,maxlevel,level){\r\n    maxlevel = maxlevel || 100;\r\n    level = level || 0;\r\n    delta = delta || 25;\r\n    result = typeof(result)!==\"undefined\" ? result : [];\r\n    reflexVertices = reflexVertices || [];\r\n    steinerPoints = steinerPoints || [];\r\n\r\n    var upperInt=[0,0], lowerInt=[0,0], p=[0,0]; // Points\r\n    var upperDist=0, lowerDist=0, d=0, closestDist=0; // scalars\r\n    var upperIndex=0, lowerIndex=0, closestIndex=0; // Integers\r\n    var lowerPoly=[], upperPoly=[]; // polygons\r\n    var poly = polygon,\r\n        v = polygon;\r\n\r\n    if(v.length < 3){\r\n\t\treturn result;\r\n    }\r\n\r\n    level++;\r\n    if(level > maxlevel){\r\n        console.warn(\"quickDecomp: max level (\"+maxlevel+\") reached.\");\r\n        return result;\r\n    }\r\n\r\n    for (var i = 0; i < polygon.length; ++i) {\r\n        if (polygonIsReflex(poly, i)) {\r\n            reflexVertices.push(poly[i]);\r\n            upperDist = lowerDist = Number.MAX_VALUE;\r\n\r\n\r\n            for (var j = 0; j < polygon.length; ++j) {\r\n                if (isLeft(polygonAt(poly, i - 1), polygonAt(poly, i), polygonAt(poly, j)) && isRightOn(polygonAt(poly, i - 1), polygonAt(poly, i), polygonAt(poly, j - 1))) { // if line intersects with an edge\r\n                    p = getIntersectionPoint(polygonAt(poly, i - 1), polygonAt(poly, i), polygonAt(poly, j), polygonAt(poly, j - 1)); // find the point of intersection\r\n                    if (isRight(polygonAt(poly, i + 1), polygonAt(poly, i), p)) { // make sure it's inside the poly\r\n                        d = sqdist(poly[i], p);\r\n                        if (d < lowerDist) { // keep only the closest intersection\r\n                            lowerDist = d;\r\n                            lowerInt = p;\r\n                            lowerIndex = j;\r\n                        }\r\n                    }\r\n                }\r\n                if (isLeft(polygonAt(poly, i + 1), polygonAt(poly, i), polygonAt(poly, j + 1)) && isRightOn(polygonAt(poly, i + 1), polygonAt(poly, i), polygonAt(poly, j))) {\r\n                    p = getIntersectionPoint(polygonAt(poly, i + 1), polygonAt(poly, i), polygonAt(poly, j), polygonAt(poly, j + 1));\r\n                    if (isLeft(polygonAt(poly, i - 1), polygonAt(poly, i), p)) {\r\n                        d = sqdist(poly[i], p);\r\n                        if (d < upperDist) {\r\n                            upperDist = d;\r\n                            upperInt = p;\r\n                            upperIndex = j;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            // if there are no vertices to connect to, choose a point in the middle\r\n            if (lowerIndex === (upperIndex + 1) % polygon.length) {\r\n                //console.log(\"Case 1: Vertex(\"+i+\"), lowerIndex(\"+lowerIndex+\"), upperIndex(\"+upperIndex+\"), poly.size(\"+polygon.length+\")\");\r\n                p[0] = (lowerInt[0] + upperInt[0]) / 2;\r\n                p[1] = (lowerInt[1] + upperInt[1]) / 2;\r\n                steinerPoints.push(p);\r\n\r\n                if (i < upperIndex) {\r\n                    //lowerPoly.insert(lowerPoly.end(), poly.begin() + i, poly.begin() + upperIndex + 1);\r\n                    polygonAppend(lowerPoly, poly, i, upperIndex+1);\r\n                    lowerPoly.push(p);\r\n                    upperPoly.push(p);\r\n                    if (lowerIndex !== 0){\r\n                        //upperPoly.insert(upperPoly.end(), poly.begin() + lowerIndex, poly.end());\r\n                        polygonAppend(upperPoly, poly,lowerIndex,poly.length);\r\n                    }\r\n                    //upperPoly.insert(upperPoly.end(), poly.begin(), poly.begin() + i + 1);\r\n                    polygonAppend(upperPoly, poly,0,i+1);\r\n                } else {\r\n                    if (i !== 0){\r\n                        //lowerPoly.insert(lowerPoly.end(), poly.begin() + i, poly.end());\r\n                        polygonAppend(lowerPoly, poly,i,poly.length);\r\n                    }\r\n                    //lowerPoly.insert(lowerPoly.end(), poly.begin(), poly.begin() + upperIndex + 1);\r\n                    polygonAppend(lowerPoly, poly,0,upperIndex+1);\r\n                    lowerPoly.push(p);\r\n                    upperPoly.push(p);\r\n                    //upperPoly.insert(upperPoly.end(), poly.begin() + lowerIndex, poly.begin() + i + 1);\r\n                    polygonAppend(upperPoly, poly,lowerIndex,i+1);\r\n                }\r\n            } else {\r\n                // connect to the closest point within the triangle\r\n                //console.log(\"Case 2: Vertex(\"+i+\"), closestIndex(\"+closestIndex+\"), poly.size(\"+polygon.length+\")\\n\");\r\n\r\n                if (lowerIndex > upperIndex) {\r\n                    upperIndex += polygon.length;\r\n                }\r\n                closestDist = Number.MAX_VALUE;\r\n\r\n                if(upperIndex < lowerIndex){\r\n                    return result;\r\n                }\r\n\r\n                for (var j = lowerIndex; j <= upperIndex; ++j) {\r\n                    if (\r\n                        isLeftOn(polygonAt(poly, i - 1), polygonAt(poly, i), polygonAt(poly, j)) &&\r\n                        isRightOn(polygonAt(poly, i + 1), polygonAt(poly, i), polygonAt(poly, j))\r\n                    ) {\r\n                        d = sqdist(polygonAt(poly, i), polygonAt(poly, j));\r\n                        if (d < closestDist && polygonCanSee2(poly, i, j)) {\r\n                            closestDist = d;\r\n                            closestIndex = j % polygon.length;\r\n                        }\r\n                    }\r\n                }\r\n\r\n                if (i < closestIndex) {\r\n                    polygonAppend(lowerPoly, poly,i,closestIndex+1);\r\n                    if (closestIndex !== 0){\r\n                        polygonAppend(upperPoly, poly,closestIndex,v.length);\r\n                    }\r\n                    polygonAppend(upperPoly, poly,0,i+1);\r\n                } else {\r\n                    if (i !== 0){\r\n                        polygonAppend(lowerPoly, poly,i,v.length);\r\n                    }\r\n                    polygonAppend(lowerPoly, poly,0,closestIndex+1);\r\n                    polygonAppend(upperPoly, poly,closestIndex,i+1);\r\n                }\r\n            }\r\n\r\n            // solve smallest poly first\r\n            if (lowerPoly.length < upperPoly.length) {\r\n                polygonQuickDecomp(lowerPoly,result,reflexVertices,steinerPoints,delta,maxlevel,level);\r\n                polygonQuickDecomp(upperPoly,result,reflexVertices,steinerPoints,delta,maxlevel,level);\r\n            } else {\r\n                polygonQuickDecomp(upperPoly,result,reflexVertices,steinerPoints,delta,maxlevel,level);\r\n                polygonQuickDecomp(lowerPoly,result,reflexVertices,steinerPoints,delta,maxlevel,level);\r\n            }\r\n\r\n            return result;\r\n        }\r\n    }\r\n    result.push(polygon);\r\n\r\n    return result;\r\n}\r\n\r\n/**\r\n * Remove collinear points in the polygon.\r\n * @method removeCollinearPoints\r\n * @param  {Number} [precision] The threshold angle to use when determining whether two edges are collinear. Use zero for finest precision.\r\n * @return {Number}           The number of points removed\r\n */\r\nfunction polygonRemoveCollinearPoints(polygon, precision){\r\n    var num = 0;\r\n    for(var i=polygon.length-1; polygon.length>3 && i>=0; --i){\r\n        if(collinear(polygonAt(polygon, i-1),polygonAt(polygon, i),polygonAt(polygon, i+1),precision)){\r\n            // Remove the middle point\r\n            polygon.splice(i%polygon.length,1);\r\n            num++;\r\n        }\r\n    }\r\n    return num;\r\n}\r\n\r\n/**\r\n * Remove duplicate points in the polygon.\r\n * @method removeDuplicatePoints\r\n * @param  {Number} [precision] The threshold to use when determining whether two points are the same. Use zero for best precision.\r\n */\r\nfunction polygonRemoveDuplicatePoints(polygon, precision){\r\n    for(var i=polygon.length-1; i>=1; --i){\r\n        var pi = polygon[i];\r\n        for(var j=i-1; j>=0; --j){\r\n            if(points_eq(pi, polygon[j], precision)){\r\n                polygon.splice(i,1);\r\n                continue;\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Check if two scalars are equal\r\n * @static\r\n * @method eq\r\n * @param  {Number} a\r\n * @param  {Number} b\r\n * @param  {Number} [precision]\r\n * @return {Boolean}\r\n */\r\nfunction scalar_eq(a,b,precision){\r\n    precision = precision || 0;\r\n    return Math.abs(a-b) <= precision;\r\n}\r\n\r\n/**\r\n * Check if two points are equal\r\n * @static\r\n * @method points_eq\r\n * @param  {Array} a\r\n * @param  {Array} b\r\n * @param  {Number} [precision]\r\n * @return {Boolean}\r\n */\r\nfunction points_eq(a,b,precision){\r\n    return scalar_eq(a[0],b[0],precision) && scalar_eq(a[1],b[1],precision);\r\n}\r\n","/*\r\n * https://github.com/josephg/noisejs\r\n * A speed-improved perlin and simplex noise algorithms for 2D.\r\n *\r\n * Based on example code by Stefan Gustavson (stegu@itn.liu.se).\r\n * Optimisations by Peter Eastman (peastman@drizzle.stanford.edu).\r\n * Better rank ordering method by Stefan Gustavson in 2012.\r\n * Converted to Javascript by Joseph Gentle.\r\n *\r\n * Version 2012-03-09\r\n *\r\n * This code was placed in the public domain by its original author,\r\n * Stefan Gustavson. You may use it as you see fit, but\r\n * attribution is appreciated.\r\n *\r\n */\r\n\r\n(function(global){\r\n\tvar module = global.noise = {};\r\n  \r\n\tfunction Grad(x, y, z) {\r\n\t  this.x = x; this.y = y; this.z = z;\r\n\t}\r\n\t\r\n\tGrad.prototype.dot2 = function(x, y) {\r\n\t  return this.x*x + this.y*y;\r\n\t};\r\n  \r\n\tGrad.prototype.dot3 = function(x, y, z) {\r\n\t  return this.x*x + this.y*y + this.z*z;\r\n\t};\r\n  \r\n\tvar grad3 = [new Grad(1,1,0),new Grad(-1,1,0),new Grad(1,-1,0),new Grad(-1,-1,0),\r\n\t\t\t\t new Grad(1,0,1),new Grad(-1,0,1),new Grad(1,0,-1),new Grad(-1,0,-1),\r\n\t\t\t\t new Grad(0,1,1),new Grad(0,-1,1),new Grad(0,1,-1),new Grad(0,-1,-1)];\r\n  \r\n\tvar p = [151,160,137,91,90,15,\r\n\t131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,\r\n\t190, 6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,\r\n\t88,237,149,56,87,174,20,125,136,171,168, 68,175,74,165,71,134,139,48,27,166,\r\n\t77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,\r\n\t102,143,54, 65,25,63,161, 1,216,80,73,209,76,132,187,208, 89,18,169,200,196,\r\n\t135,130,116,188,159,86,164,100,109,198,173,186, 3,64,52,217,226,250,124,123,\r\n\t5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,\r\n\t223,183,170,213,119,248,152, 2,44,154,163, 70,221,153,101,155,167, 43,172,9,\r\n\t129,22,39,253, 19,98,108,110,79,113,224,232,178,185, 112,104,218,246,97,228,\r\n\t251,34,242,193,238,210,144,12,191,179,162,241, 81,51,145,235,249,14,239,107,\r\n\t49,192,214, 31,181,199,106,157,184, 84,204,176,115,121,50,45,127, 4,150,254,\r\n\t138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180];\r\n\t// To remove the need for index wrapping, double the permutation table length\r\n\tvar perm = new Array(512);\r\n\tvar gradP = new Array(512);\r\n  \r\n\t// This isn't a very good seeding function, but it works ok. It supports 2^16\r\n\t// different seed values. Write something better if you need more seeds.\r\n\tmodule.seed = function(seed) {\r\n\t  if(seed > 0 && seed < 1) {\r\n\t\t// Scale the seed out\r\n\t\tseed *= 65536;\r\n\t  }\r\n  \r\n\t  seed = Math.floor(seed);\r\n\t  if(seed < 256) {\r\n\t\tseed |= seed << 8;\r\n\t  }\r\n  \r\n\t  for(var i = 0; i < 256; i++) {\r\n\t\tvar v;\r\n\t\tif (i & 1) {\r\n\t\t  v = p[i] ^ (seed & 255);\r\n\t\t} else {\r\n\t\t  v = p[i] ^ ((seed>>8) & 255);\r\n\t\t}\r\n  \r\n\t\tperm[i] = perm[i + 256] = v;\r\n\t\tgradP[i] = gradP[i + 256] = grad3[v % 12];\r\n\t  }\r\n\t};\r\n  \r\n\tmodule.seed(0);\r\n  \r\n\t/*\r\n\tfor(var i=0; i<256; i++) {\r\n\t  perm[i] = perm[i + 256] = p[i];\r\n\t  gradP[i] = gradP[i + 256] = grad3[perm[i] % 12];\r\n\t}*/\r\n  \r\n\t// Skewing and unskewing factors for 2, 3, and 4 dimensions\r\n\tvar F2 = 0.5*(Math.sqrt(3)-1);\r\n\tvar G2 = (3-Math.sqrt(3))/6;\r\n  \r\n\tvar F3 = 1/3;\r\n\tvar G3 = 1/6;\r\n  \r\n\t// 2D simplex noise\r\n\tmodule.simplex2 = function(xin, yin) {\r\n\t  var n0, n1, n2; // Noise contributions from the three corners\r\n\t  // Skew the input space to determine which simplex cell we're in\r\n\t  var s = (xin+yin)*F2; // Hairy factor for 2D\r\n\t  var i = Math.floor(xin+s);\r\n\t  var j = Math.floor(yin+s);\r\n\t  var t = (i+j)*G2;\r\n\t  var x0 = xin-i+t; // The x,y distances from the cell origin, unskewed.\r\n\t  var y0 = yin-j+t;\r\n\t  // For the 2D case, the simplex shape is an equilateral triangle.\r\n\t  // Determine which simplex we are in.\r\n\t  var i1, j1; // Offsets for second (middle) corner of simplex in (i,j) coords\r\n\t  if(x0>y0) { // lower triangle, XY order: (0,0)->(1,0)->(1,1)\r\n\t\ti1=1; j1=0;\r\n\t  } else {    // upper triangle, YX order: (0,0)->(0,1)->(1,1)\r\n\t\ti1=0; j1=1;\r\n\t  }\r\n\t  // A step of (1,0) in (i,j) means a step of (1-c,-c) in (x,y), and\r\n\t  // a step of (0,1) in (i,j) means a step of (-c,1-c) in (x,y), where\r\n\t  // c = (3-sqrt(3))/6\r\n\t  var x1 = x0 - i1 + G2; // Offsets for middle corner in (x,y) unskewed coords\r\n\t  var y1 = y0 - j1 + G2;\r\n\t  var x2 = x0 - 1 + 2 * G2; // Offsets for last corner in (x,y) unskewed coords\r\n\t  var y2 = y0 - 1 + 2 * G2;\r\n\t  // Work out the hashed gradient indices of the three simplex corners\r\n\t  i &= 255;\r\n\t  j &= 255;\r\n\t  var gi0 = gradP[i+perm[j]];\r\n\t  var gi1 = gradP[i+i1+perm[j+j1]];\r\n\t  var gi2 = gradP[i+1+perm[j+1]];\r\n\t  // Calculate the contribution from the three corners\r\n\t  var t0 = 0.5 - x0*x0-y0*y0;\r\n\t  if(t0<0) {\r\n\t\tn0 = 0;\r\n\t  } else {\r\n\t\tt0 *= t0;\r\n\t\tn0 = t0 * t0 * gi0.dot2(x0, y0);  // (x,y) of grad3 used for 2D gradient\r\n\t  }\r\n\t  var t1 = 0.5 - x1*x1-y1*y1;\r\n\t  if(t1<0) {\r\n\t\tn1 = 0;\r\n\t  } else {\r\n\t\tt1 *= t1;\r\n\t\tn1 = t1 * t1 * gi1.dot2(x1, y1);\r\n\t  }\r\n\t  var t2 = 0.5 - x2*x2-y2*y2;\r\n\t  if(t2<0) {\r\n\t\tn2 = 0;\r\n\t  } else {\r\n\t\tt2 *= t2;\r\n\t\tn2 = t2 * t2 * gi2.dot2(x2, y2);\r\n\t  }\r\n\t  // Add contributions from each corner to get the final noise value.\r\n\t  // The result is scaled to return values in the interval [-1,1].\r\n\t  return 70 * (n0 + n1 + n2);\r\n\t};\r\n  \r\n\t// 3D simplex noise\r\n\tmodule.simplex3 = function(xin, yin, zin) {\r\n\t  var n0, n1, n2, n3; // Noise contributions from the four corners\r\n  \r\n\t  // Skew the input space to determine which simplex cell we're in\r\n\t  var s = (xin+yin+zin)*F3; // Hairy factor for 2D\r\n\t  var i = Math.floor(xin+s);\r\n\t  var j = Math.floor(yin+s);\r\n\t  var k = Math.floor(zin+s);\r\n  \r\n\t  var t = (i+j+k)*G3;\r\n\t  var x0 = xin-i+t; // The x,y distances from the cell origin, unskewed.\r\n\t  var y0 = yin-j+t;\r\n\t  var z0 = zin-k+t;\r\n  \r\n\t  // For the 3D case, the simplex shape is a slightly irregular tetrahedron.\r\n\t  // Determine which simplex we are in.\r\n\t  var i1, j1, k1; // Offsets for second corner of simplex in (i,j,k) coords\r\n\t  var i2, j2, k2; // Offsets for third corner of simplex in (i,j,k) coords\r\n\t  if(x0 >= y0) {\r\n\t\tif(y0 >= z0)      { i1=1; j1=0; k1=0; i2=1; j2=1; k2=0; }\r\n\t\telse if(x0 >= z0) { i1=1; j1=0; k1=0; i2=1; j2=0; k2=1; }\r\n\t\telse              { i1=0; j1=0; k1=1; i2=1; j2=0; k2=1; }\r\n\t  } else {\r\n\t\tif(y0 < z0)      { i1=0; j1=0; k1=1; i2=0; j2=1; k2=1; }\r\n\t\telse if(x0 < z0) { i1=0; j1=1; k1=0; i2=0; j2=1; k2=1; }\r\n\t\telse             { i1=0; j1=1; k1=0; i2=1; j2=1; k2=0; }\r\n\t  }\r\n\t  // A step of (1,0,0) in (i,j,k) means a step of (1-c,-c,-c) in (x,y,z),\r\n\t  // a step of (0,1,0) in (i,j,k) means a step of (-c,1-c,-c) in (x,y,z), and\r\n\t  // a step of (0,0,1) in (i,j,k) means a step of (-c,-c,1-c) in (x,y,z), where\r\n\t  // c = 1/6.\r\n\t  var x1 = x0 - i1 + G3; // Offsets for second corner\r\n\t  var y1 = y0 - j1 + G3;\r\n\t  var z1 = z0 - k1 + G3;\r\n  \r\n\t  var x2 = x0 - i2 + 2 * G3; // Offsets for third corner\r\n\t  var y2 = y0 - j2 + 2 * G3;\r\n\t  var z2 = z0 - k2 + 2 * G3;\r\n  \r\n\t  var x3 = x0 - 1 + 3 * G3; // Offsets for fourth corner\r\n\t  var y3 = y0 - 1 + 3 * G3;\r\n\t  var z3 = z0 - 1 + 3 * G3;\r\n  \r\n\t  // Work out the hashed gradient indices of the four simplex corners\r\n\t  i &= 255;\r\n\t  j &= 255;\r\n\t  k &= 255;\r\n\t  var gi0 = gradP[i+   perm[j+   perm[k   ]]];\r\n\t  var gi1 = gradP[i+i1+perm[j+j1+perm[k+k1]]];\r\n\t  var gi2 = gradP[i+i2+perm[j+j2+perm[k+k2]]];\r\n\t  var gi3 = gradP[i+ 1+perm[j+ 1+perm[k+ 1]]];\r\n  \r\n\t  // Calculate the contribution from the four corners\r\n\t  var t0 = 0.6 - x0*x0 - y0*y0 - z0*z0;\r\n\t  if(t0<0) {\r\n\t\tn0 = 0;\r\n\t  } else {\r\n\t\tt0 *= t0;\r\n\t\tn0 = t0 * t0 * gi0.dot3(x0, y0, z0);  // (x,y) of grad3 used for 2D gradient\r\n\t  }\r\n\t  var t1 = 0.6 - x1*x1 - y1*y1 - z1*z1;\r\n\t  if(t1<0) {\r\n\t\tn1 = 0;\r\n\t  } else {\r\n\t\tt1 *= t1;\r\n\t\tn1 = t1 * t1 * gi1.dot3(x1, y1, z1);\r\n\t  }\r\n\t  var t2 = 0.6 - x2*x2 - y2*y2 - z2*z2;\r\n\t  if(t2<0) {\r\n\t\tn2 = 0;\r\n\t  } else {\r\n\t\tt2 *= t2;\r\n\t\tn2 = t2 * t2 * gi2.dot3(x2, y2, z2);\r\n\t  }\r\n\t  var t3 = 0.6 - x3*x3 - y3*y3 - z3*z3;\r\n\t  if(t3<0) {\r\n\t\tn3 = 0;\r\n\t  } else {\r\n\t\tt3 *= t3;\r\n\t\tn3 = t3 * t3 * gi3.dot3(x3, y3, z3);\r\n\t  }\r\n\t  // Add contributions from each corner to get the final noise value.\r\n\t  // The result is scaled to return values in the interval [-1,1].\r\n\t  return 32 * (n0 + n1 + n2 + n3);\r\n  \r\n\t};\r\n  \r\n\t// ##### Perlin noise stuff\r\n  \r\n\tfunction fade(t) {\r\n\t  return t*t*t*(t*(t*6-15)+10);\r\n\t}\r\n  \r\n\tfunction lerp(a, b, t) {\r\n\t  return (1-t)*a + t*b;\r\n\t}\r\n  \r\n\t// 2D Perlin Noise\r\n\tmodule.perlin2 = function(x, y) {\r\n\t  // Find unit grid cell containing point\r\n\t  var X = Math.floor(x), Y = Math.floor(y);\r\n\t  // Get relative xy coordinates of point within that cell\r\n\t  x = x - X; y = y - Y;\r\n\t  // Wrap the integer cells at 255 (smaller integer period can be introduced here)\r\n\t  X = X & 255; Y = Y & 255;\r\n  \r\n\t  // Calculate noise contributions from each of the four corners\r\n\t  var n00 = gradP[X+perm[Y]].dot2(x, y);\r\n\t  var n01 = gradP[X+perm[Y+1]].dot2(x, y-1);\r\n\t  var n10 = gradP[X+1+perm[Y]].dot2(x-1, y);\r\n\t  var n11 = gradP[X+1+perm[Y+1]].dot2(x-1, y-1);\r\n  \r\n\t  // Compute the fade curve value for x\r\n\t  var u = fade(x);\r\n  \r\n\t  // Interpolate the four results\r\n\t  return lerp(\r\n\t\t  lerp(n00, n10, u),\r\n\t\t  lerp(n01, n11, u),\r\n\t\t fade(y));\r\n\t};\r\n  \r\n\t// 3D Perlin Noise\r\n\tmodule.perlin3 = function(x, y, z) {\r\n\t  // Find unit grid cell containing point\r\n\t  var X = Math.floor(x), Y = Math.floor(y), Z = Math.floor(z);\r\n\t  // Get relative xyz coordinates of point within that cell\r\n\t  x = x - X; y = y - Y; z = z - Z;\r\n\t  // Wrap the integer cells at 255 (smaller integer period can be introduced here)\r\n\t  X = X & 255; Y = Y & 255; Z = Z & 255;\r\n  \r\n\t  // Calculate noise contributions from each of the eight corners\r\n\t  var n000 = gradP[X+  perm[Y+  perm[Z  ]]].dot3(x,   y,     z);\r\n\t  var n001 = gradP[X+  perm[Y+  perm[Z+1]]].dot3(x,   y,   z-1);\r\n\t  var n010 = gradP[X+  perm[Y+1+perm[Z  ]]].dot3(x,   y-1,   z);\r\n\t  var n011 = gradP[X+  perm[Y+1+perm[Z+1]]].dot3(x,   y-1, z-1);\r\n\t  var n100 = gradP[X+1+perm[Y+  perm[Z  ]]].dot3(x-1,   y,   z);\r\n\t  var n101 = gradP[X+1+perm[Y+  perm[Z+1]]].dot3(x-1,   y, z-1);\r\n\t  var n110 = gradP[X+1+perm[Y+1+perm[Z  ]]].dot3(x-1, y-1,   z);\r\n\t  var n111 = gradP[X+1+perm[Y+1+perm[Z+1]]].dot3(x-1, y-1, z-1);\r\n  \r\n\t  // Compute the fade curve value for x, y, z\r\n\t  var u = fade(x);\r\n\t  var v = fade(y);\r\n\t  var w = fade(z);\r\n  \r\n\t  // Interpolate\r\n\t  return lerp(\r\n\t\t  lerp(\r\n\t\t\tlerp(n000, n100, u),\r\n\t\t\tlerp(n001, n101, u), w),\r\n\t\t  lerp(\r\n\t\t\tlerp(n010, n110, u),\r\n\t\t\tlerp(n011, n111, u), w),\r\n\t\t v);\r\n\t};\r\n  \r\n  })(this);","\"use strict\";\r\n\r\nconst vec = require(\"../geometry/vec.js\");\r\n\r\nmodule.exports = class Node {\r\n\tstatic id = 0;\r\n\t/**\r\n\t * Generates a unique id for nodes\r\n\t * @returns {Number} A unique integer id\r\n\t */\r\n\tstatic getUniqueId() {\r\n\t\treturn ++Node.id;\r\n\t}\r\n\r\n\tposition = new vec(0, 0);\r\n\tangle = 0;\r\n\tchildren = new Set();\r\n\tadded = false;\r\n\r\n\t/**\r\n\t * Creates a Node\r\n\t */\r\n\tconstructor() {\r\n\t\tthis.id = Node.getUniqueId();\r\n\t}\r\n\r\n\t/**\r\n\t * Sets this node's position to `position`\r\n\t * @example\r\n\t * node.setPosition(new vec(100, 100)); // Sets node's position to (100, 100) \r\n\t * @param {vec} position - Position the node should be set to\r\n\t */\r\n\tsetPosition(position) {\r\n\t\tlet delta = position.sub(this.position);\r\n\t\tthis.translate(delta);\r\n\t}\r\n\t/**\r\n\t * Shifts this node's position by `positionDelta`\r\n\t * @param {vec} positionDelta - Amount to shift the position\r\n\t */\r\n\ttranslate(positionDelta) {\r\n\t\tthis.position.add2(positionDelta);\r\n\t\tfor (let child of this.children) {\r\n\t\t\tchild.translate(delta);\r\n\t\t}\r\n\t}\r\n\t\r\n\t/**\r\n\t * Sets the node's angle to `angle`\r\n\t * @param {Number} angle - Angle body should be in radians\r\n\t * @example\r\n\t * node.setAngle(Math.PI); // Sets node's angle to Pi radians, or 180 degrees \r\n\t * @returns {void}\r\n\t */\r\n\tsetAngle(angle) {\r\n\t\tif (isNaN(angle)) return;\r\n\t\tif (angle !== this.angle) {\r\n\t\t\tlet delta = Common.angleDiff(angle, this.angle);\r\n\t\t\tthis.translateAngle(delta);\r\n\t\t}\r\n\t}\r\n\t\r\n\t/**\r\n\t * Rotates the body by `angle`- Relative\r\n\t * @param {Number} angle - The amount the body should be rotated, in radians\r\n\t * @param {Boolean} silent - If the body's angle should be affected\r\n\t * @returns {void}\r\n\t */\r\n\ttranslateAngle(angle) {\r\n\t\tif (isNaN(angle)) return;\r\n\r\n\t\tthis.angle += angle;\r\n\r\n\t\tfor (let child of this.children) {\r\n\t\t\tchild.translateAngle?.(angle);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Adds this node and its children\r\n\t * @returns {void}\r\n\t */\r\n\tadd() {\r\n\t\tif (!this.added) {\r\n\t\t\tthis.trigger(\"add\");\r\n\t\t\tthis.added = true;\r\n\r\n\t\t\tfor (let child of this.children) {\r\n\t\t\t\tchild.add();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t/**\r\n\t * Removes this node and its children\r\n\t * @returns {void}\r\n\t */\r\n\tdelete() {\r\n\t\tif (this.added) {\r\n\t\t\tthis.trigger(\"delete\");\r\n\t\t\tthis.added = false;\r\n\t\r\n\t\t\tfor (let child of this.children) {\r\n\t\t\t\tchild.delete();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Adds all `children` to this node's children\r\n\t * @param {...Node} children - The child nodes to be added\r\n\t */\r\n\taddChild(...children) {\r\n\t\tfor (let child of children) {\r\n\t\t\tthis.children.add(child);\r\n\t\t}\r\n\t}\r\n\t/**\r\n\t * Removes all `children` from this node's children\r\n\t * @param {...Node} children - The child nodes to be removed\r\n\t */\r\n\tremoveChild(...children) {\r\n\t\tfor (let child of children) {\r\n\t\t\tthis.children.delete(child);\r\n\t\t}\r\n\t}\r\n\r\n\t\r\n\t#events = {\r\n\t\tdelete: [],\r\n\t\tadd: [],\r\n\t}\r\n\ton(event, callback) {\r\n\t\tif (this.#events[event]) {\r\n\t\t\tthis.#events[event].push(callback);\r\n\t\t}\r\n\t\telse {\r\n\t\t\tconsole.warn(event + \" is not a valid event\");\r\n\t\t}\r\n\t}\r\n\toff(event, callback) {\r\n\t\tevent = this.#events[event];\r\n\t\tif (event.includes(callback)) {\r\n\t\t\tevent.splice(event.indexOf(callback), 1);\r\n\t\t}\r\n\t}\r\n\ttrigger(event) {\r\n\t\t// Trigger each event\r\n\t\tif (this.#events[event]) {\r\n\t\t\tthis.#events[event].forEach(callback => {\r\n\t\t\t\tcallback();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n}\r\n","const Node = require(\"../node/Node.js\");\r\nconst Common = require(\"../core/Common.js\")\r\nconst Grid = require(\"../geometry/Grid.js\");\r\nconst vec = require(\"../geometry/vec.js\");\r\nconst RigidBody = require(\"../physics/RigidBody.js\");\r\n\r\nmodule.exports = class World extends Node {\r\n\tstatic defaultOptions = {\r\n\t\tgravity: new vec(0, 500),\r\n\t\tgridSize: 500,\r\n\t}\r\n\t\r\n\tgravity = new vec(0, 0);\r\n\ttimescale = 1;\r\n\ttime = 0;\r\n\r\n\tbodies = new Set();\r\n\tconstraints = new Set();\r\n\tpairs = {};\r\n\r\n\tdynamicGrid;\r\n\tstaticGrid;\r\n\t\r\n\tglobalPoints = [];\r\n\tglobalVectors = [];\r\n\t\r\n\tconstructor(options = {}) {\r\n\t\tsuper();\r\n\t\tlet defaults = { ...World.defaultOptions };\r\n\t\tCommon.merge(defaults, options, 1);\r\n\t\toptions = defaults;\r\n\r\n\t\tlet { gravity, gridSize } = options;\r\n\t\tthis.gravity = new vec(gravity);\r\n\t\tthis.dynamicGrid = new Grid(gridSize);\r\n\t\tthis.staticGrid = new Grid(gridSize);\r\n\t}\r\n\r\n\tcanCollide(filterA, filterB) {\r\n\t\tlet { layer: layerA, mask: maskA } = filterA;\r\n\t\tlet { layer: layerB, mask: maskB } = filterB;\r\n\r\n\t\tlet canA = (maskA & layerB) !== 0;\r\n\t\tlet canB = (maskB & layerA) !== 0;\r\n\r\n\t\treturn canA || canB;\r\n\t}\r\n\t#getPairs(bodies) {\r\n\t\tlet pairs = [];\r\n\t\tlet canCollide = this.canCollide;\r\n\r\n\t\tfor (let i = 0; i < bodies.length - 1; i++) {\r\n\t\t\tlet bodyA = bodies[i];\r\n\t\t\tif (!bodyA.added) {\r\n\t\t\t\tif (bodyA.isStatic) {\r\n\t\t\t\t\tthis.staticGrid.removeBody(bodyA);\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tthis.dynamicGrid.removeBody(bodyA);\r\n\t\t\t\t}\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\tif (!bodyA.hasCollisions)\r\n\t\t\t\tcontinue;\r\n\t\t\t\r\n\t\t\tfor (let j = i + 1; j < bodies.length; j++) {\r\n\t\t\t\t// Do AABB collision test\r\n\t\t\t\tlet bodyB = bodies[j];\r\n\r\n\t\t\t\tif (!bodyB.added) {\r\n\t\t\t\t\tif (bodyB.isStatic) {\r\n\t\t\t\t\t\tthis.staticGrid.removeBody(bodyB);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tthis.dynamicGrid.removeBody(bodyB);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t}\r\n\t\t\t\tif (!bodyB.hasCollisions || bodyA.parent && bodyA.parent === bodyB.parent)\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\tif (!canCollide(bodyA.collisionFilter, bodyB.collisionFilter))\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\t\r\n\r\n\t\t\t\tconst boundsA = bodyA.bounds;\r\n\t\t\t\tconst boundsB = bodyB.bounds;\r\n\r\n\t\t\t\tif (boundsA.min.x <= boundsB.max.x &&\r\n\t\t\t\t\tboundsA.max.x >= boundsB.min.x &&\r\n\t\t\t\t\tboundsA.min.y <= boundsB.max.y &&\r\n\t\t\t\t\tboundsA.max.y >= boundsB.min.y) {\r\n\t\t\t\t\tpairs.push([ bodyA, bodyB ]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn pairs;\r\n\t}\r\n\tget collisionPairs() {\r\n\t\tlet canCollide = this.canCollide;\r\n\t\tlet dynamicGrid = this.dynamicGrid;\r\n\t\tlet staticGrid = this.staticGrid;\r\n\t\tlet pair = Common.pairCommon;\r\n\t\tlet pairIds = new Set();\r\n\t\tlet pairs = [];\r\n\r\n\t\tlet dynamicBuckets = dynamicGrid.grid;\r\n\t\tlet staticBuckets = staticGrid.grid;\r\n\t\tlet bucketIds = dynamicGrid.gridIds;\r\n\r\n\t\tfor (let id of bucketIds) {\r\n\t\t\tlet curDynamicBucket = dynamicBuckets[id];\r\n\t\t\tlet curStaticBucket = staticBuckets[id];\r\n\t\t\tlet curPairs = this.#getPairs(curDynamicBucket); // pair dynamic bodies\r\n\r\n\t\t\t// add static bodies\r\n\t\t\tif (curStaticBucket) {\r\n\t\t\t\tfor (let j = 0; j < curDynamicBucket.length; j++) {\r\n\t\t\t\t\tlet bodyA = curDynamicBucket[j];\r\n\t\t\t\t\tif (!bodyA.hasCollisions)\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\tfor (let k = 0; k < curStaticBucket.length; k++) {\r\n\t\t\t\t\t\tlet bodyB = curStaticBucket[k];\r\n\r\n\t\t\t\t\t\tif (!bodyB.hasCollisions || bodyA.isStatic && bodyB.isStatic || bodyA.parent && bodyA.parent === bodyB.parent)\r\n\t\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t\tif (!canCollide(bodyA.collisionFilter, bodyB.collisionFilter))\r\n\t\t\t\t\t\t\tcontinue;\r\n\t\r\n\t\r\n\t\t\t\t\t\tconst boundsA = bodyA.bounds;\r\n\t\t\t\t\t\tconst boundsB = bodyB.bounds;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tif (boundsA.min.x <= boundsB.max.x &&\r\n\t\t\t\t\t\t\tboundsA.max.x >= boundsB.min.x &&\r\n\t\t\t\t\t\t\tboundsA.min.y <= boundsB.max.y &&\r\n\t\t\t\t\t\t\tboundsA.max.y >= boundsB.min.y) {\r\n\t\t\t\t\t\t\tcurPairs.push([ bodyA, bodyB ]);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tfor (let j = 0; j < curPairs.length; j++) {\r\n\t\t\t\tlet curPair = curPairs[j];\r\n\t\t\t\tlet n = pair(curPair[0].id, curPair[1].id);\r\n\t\t\t\tif (!pairIds.has(n)) {\r\n\t\t\t\t\tpairIds.add(n);\r\n\t\t\t\t\tpairs.push(curPair);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn pairs;\r\n\t}\r\n\r\n\taddChild(...children) {\r\n\t\tsuper.addChild(...children);\r\n\r\n\t\tfor (let child of children) {\r\n\t\t\t// Add to engine\r\n\t\t\tif (child instanceof RigidBody) {\r\n\t\t\t\tthis.bodies.add(child);\r\n\t\t\t}\r\n\r\n\t\t\t// Add to grids\r\n\t\t\tif (child.isStatic) {\r\n\t\t\t\tthis.staticGrid.addBody(child);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tthis.dynamicGrid.addBody(child);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tremoveChild(...children) {\r\n\t\tsuper.removeChild(...children);\r\n\r\n\t\tfor (let child of children) {\r\n\t\t\t// Add to engine\r\n\t\t\tif (child instanceof RigidBody) {\r\n\t\t\t\tthis.bodies.delete(child);\r\n\t\t\t}\r\n\r\n\t\t\t// Remove from grids\r\n\t\t\tif (child._Grids) {\r\n\t\t\t\tif (child._Grids[this.staticGrid.id]) {\r\n\t\t\t\t\tthis.staticGrid.removeBody(child);\r\n\t\t\t\t}\r\n\t\t\t\tif (child._Grids[this.dynamicGrid.id]) {\r\n\t\t\t\t\tthis.dynamicGrid.removeBody(child);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n","const vec = require(\"../geometry/vec.js\");\r\nconst Common = require(\"../core/Common.js\");\r\nconst Performance = require(\"../core/Performance.js\");\r\nconst RigidBody = require(\"./RigidBody.js\");\r\n\r\nmodule.exports = class Engine {\r\n\tstatic defaultOptions = {\r\n\t\tdelta: 1,\r\n\t\tsubsteps: 5,\r\n\t\tvelocityIterations: 1,\r\n\t\tpositionIterations: 5,\r\n\t\tconstraintIterations: 1,\r\n\t\tmaxShare: 1,\r\n\t}\r\n\r\n\tdelta = 1;\r\n\tsubsteps = 5;\r\n\tvelocityIterations = 1;\r\n\tpositionIterations = 5;\r\n\tconstraintIterations = 1;\r\n\tmaxShare = 1;\r\n\r\n\t/**\r\n\t * \r\n\t * @param {World} World - The world the physics engine should run on\r\n\t * @param {Object} options - Options for the engine, see documentation for possible options\r\n\t */\r\n\tconstructor(World, options = {}) {\r\n\t\tlet defaults = { ...Engine.defaultOptions };\r\n\t\tCommon.merge(defaults, options, 1);\r\n\t\toptions = defaults;\r\n\t\t\r\n\t\t// Shallow copy options\r\n\t\tlet mutableProperties = [`substeps`, `velocityIterations`, `positionIterations`, `constraintIterations`, `maxShare`];\r\n\t\tfor (let propertyName of mutableProperties) {\r\n\t\t\tif (options[propertyName] != undefined && typeof this[propertyName] != \"function\") {\r\n\t\t\t\tthis[propertyName] = options[propertyName];\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.World = World;\r\n\t\tthis.Performance = new Performance();\r\n\t}\r\n\r\n\t/**\r\n\t * Ticks the engine one frame\r\n\t * @param {Number} delta - (Optional) Engine tick duration, in seconds\r\n\t */\r\n\tupdate = function(delta) {\r\n\t\tconst { World, Performance, substeps } = this;\r\n\t\tconst { bodies } = World;\r\n\r\n\t\t// Get delta\r\n\t\tif (delta === undefined) {\r\n\t\t\tdelta = Performance.delta * World.timescale;\r\n\t\t}\r\n\t\tWorld.time += delta;\r\n\t\tdelta /= substeps;\r\n\t\tthis.delta = delta;\r\n\r\n\t\t// Get timing\r\n\t\tPerformance.update();\r\n\r\n\t\tfor (let step = 0; step < substeps; step++) {\r\n\t\t\tPerformance.frame++;\r\n\t\t\t\r\n\t\t\t// Update positions / angles\r\n\t\t\tfor (let body of bodies) {\r\n\t\t\t\tbody._update(delta);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t// Find collisions\r\n\t\t\tWorld.globalVectors = [];\r\n\t\t\tWorld.globalPoints = [];\r\n\t\t\t\r\n\t\t\tconst pairs = World.collisionPairs;\r\n\t\t\tfor (let i = 0; i < pairs.length; i++) {\r\n\t\t\t\tlet bodyA = pairs[i][0];\r\n\t\t\t\tlet bodyB = pairs[i][1];\t\r\n\t\t\t\tif (this.collides(bodyA, bodyB)) {\r\n\t\t\t\t\tthis.createPair(bodyA, bodyB);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// Apply forces\r\n\t\t\tfor (let body of bodies) {\r\n\t\t\t\tbody._preUpdate(delta);\r\n\t\t\t}\r\n\r\n\t\t\t// Solve for velocities\r\n\t\t\tfor (let i = 0; i < this.velocityIterations; i++) {\r\n\t\t\t\tthis.solveVelocity(delta);\r\n\t\t\t}\r\n\t\t\tfor (let i = 0; i < this.positionIterations; i++) {\r\n\t\t\t\tthis.solvePositions();\r\n\t\t\t}\r\n\t\t\tthis.solveConstraints(delta);\r\n\t\t}\r\n\r\n\t\tthis.delta = delta * substeps;\r\n\t}\r\n\r\n\t/**\r\n\t * Checks if `bodyA` and `bodyB` are colliding\r\n\t * @param {RigidBody} bodyA - 1st body to check\r\n\t * @param {RigidBody} bodyB - 2nd body to check\r\n\t * @returns {Boolean} If the bodies are colliding\r\n\t */\r\n\tcollides(bodyA, bodyB) {\r\n\t\tif (bodyA.isStatic && bodyB.isStatic) return false;\r\n\r\n\t\tlet collision = true;\r\n\r\n\t\tfunction getAllSupports(body, direction) {\r\n\t\t\tlet vertices = body.vertices;\r\n\t\t\tlet maxDist = -Infinity;\r\n\t\t\tlet minDist = Infinity;\r\n\t\t\t// let maxVert, minVert;\r\n\r\n\t\t\tfor (let i = 0; i < vertices.length; i++) {\r\n\t\t\t\tlet dist = direction.dot(vertices[i]);\r\n\r\n\t\t\t\tif (dist > maxDist) {\r\n\t\t\t\t\tmaxDist = dist;\r\n\t\t\t\t\t// maxVert = i;\r\n\t\t\t\t}\r\n\t\t\t\tif (dist < minDist) {\r\n\t\t\t\t\tminDist = dist;\r\n\t\t\t\t\t// minVert = i;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\treturn { max: maxDist, min: minDist };\r\n\t\t}\r\n\r\n\t\t// - find if colliding with SAT\r\n\t\t// ~ reuse last separation axis\r\n\t\tif (bodyA._lastSeparations[bodyB.id]) {\r\n\t\t\tlet axis = bodyA._lastSeparations[bodyB.id];\r\n\t\t\tlet supportsA = getAllSupports(bodyA, axis);\r\n\t\t\tlet supportsB = getAllSupports(bodyB, axis);\r\n\t\t\tlet overlap = Math.min(supportsA.max - supportsB.min, supportsB.max - supportsA.min);\r\n\r\n\t\t\tif (overlap < 0) {\r\n\t\t\t\tcollision = false;\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tdelete bodyA._lastSeparations[bodyB.id];\r\n\t\t\t\tdelete bodyB._lastSeparations[bodyA.id];\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (collision) { // last separation didn't work - try all axes\r\n\t\t\t// ~ bodyA axes\r\n\t\t\tfor (let j = 0; j < bodyA._axes.length; j++) {\r\n\t\t\t\tlet axis = bodyA._axes[j];\r\n\t\t\t\tlet supportsA = getAllSupports(bodyA, axis);\r\n\t\t\t\tlet supportsB = getAllSupports(bodyB, axis);\r\n\t\t\t\tlet overlap = Math.min(supportsA.max - supportsB.min, supportsB.max - supportsA.min);\r\n\r\n\t\t\t\tif (overlap < 0) {\r\n\t\t\t\t\tcollision = false;\r\n\t\t\t\t\tbodyA._lastSeparations[bodyB.id] = axis;\r\n\t\t\t\t\tbodyB._lastSeparations[bodyA.id] = axis;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t// ~ bodyB axes\r\n\t\t\tfor (let j = 0; j < bodyB._axes.length; j++) {\r\n\t\t\t\tlet axis = bodyB._axes[j];\r\n\t\t\t\tlet supportsA = getAllSupports(bodyB, axis);\r\n\t\t\t\tlet supportsB = getAllSupports(bodyA, axis);\r\n\t\t\t\tlet overlap = Math.min(supportsA.max - supportsB.min, supportsB.max - supportsA.min);\r\n\t\t\t\t\r\n\t\t\t\tif (overlap < 0) {\r\n\t\t\t\t\tcollision = false;\r\n\t\t\t\t\tbodyA._lastSeparations[bodyB.id] = axis;\r\n\t\t\t\t\tbodyB._lastSeparations[bodyA.id] = axis;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn collision;\r\n\t}\r\n\r\n\t/**\r\n\t * Creates a collision pair between `bodyA` and `bodyB`\r\n\t * @param {RigidBody} bodyA - 1st body to pair\r\n\t * @param {RigidBody} bodyB - 2nd body to pair\r\n\t */\r\n\tcreatePair(bodyA, bodyB) {\r\n\t\tconst { World, Performance } = this;\r\n\t\tlet minDepth = Infinity;\r\n\t\tlet normal;\r\n\t\tlet normalPoint;\r\n\t\tlet contactBody;\r\n\t\tlet normalBody;\r\n\t\tlet contacts = [];\r\n\t\tlet numContacts = 0;\r\n\r\n\t\t// - get collision normal by finding point/edge pair with minimum depth\r\n\t\tfunction findNormal(bodyA, bodyB) {\r\n\t\t\tlet vertices = bodyA.vertices;\r\n\t\t\tfor (let i = 0; i < vertices.length; i++) {\r\n\t\t\t\tlet curVertice = vertices[i];\r\n\t\t\t\tlet nextVertice = vertices[(i + 1) % vertices.length];\r\n\t\t\t\tlet curNormal = curVertice.sub(nextVertice).normal().normalize();\r\n\t\t\t\tlet support = bodyB._getSupport(curNormal, curVertice);\r\n\r\n\t\t\t\tif (bodyB.containsPoint(curVertice)) {\r\n\t\t\t\t\tcontacts.push({ vertice: curVertice, body: bodyA });\r\n\t\t\t\t\tnumContacts++;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (support[1] < minDepth) {\r\n\t\t\t\t\tminDepth = support[1];\r\n\t\t\t\t\tnormal = curNormal.mult(-1);\r\n\t\t\t\t\tnormalPoint = curVertice.avg(nextVertice);\r\n\r\n\t\t\t\t\tnormalBody = bodyB;\r\n\t\t\t\t\tcontactBody = bodyA;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfindNormal(bodyA, bodyB);\r\n\t\tfindNormal(bodyB, bodyA);\r\n\r\n\t\tif (contacts.length === 0) {\r\n\t\t\tcontacts.push({ vertice: new vec(bodyA.position), body: bodyA });\r\n\t\t}\r\n\r\n\t\tnormal.mult2(-1);\r\n\t\tWorld.globalVectors.push({ position: normalPoint, vector: new vec(normal) });\r\n\t\tWorld.globalPoints.push(...contacts.map(v => v.vertice));\r\n\r\n\t\tlet pairId = Common.pairCommon(bodyA.id, bodyB.id);\r\n\t\tlet pair = {\r\n\t\t\tbodyA: contactBody,\r\n\t\t\tbodyB: normalBody,\r\n\t\t\tdepth: minDepth,\r\n\t\t\tpenetration: normal.mult(minDepth),\r\n\t\t\tcontacts: contacts,\r\n\t\t\ttotalContacts: numContacts,\r\n\t\t\tnormal: normal,\r\n\t\t\ttangent: normal.normal(),\r\n\r\n\t\t\tid: pairId,\r\n\t\t\tframe: Performance.frame,\r\n\t\t\tstart: World.time,\r\n\t\t}\r\n\r\n\t\tif (World.pairs[pairId]) { // Collision happened last frame, so it's active\r\n\t\t\tpair.start = World.pairs[pairId].start;\r\n\t\t\tbodyA.trigger(\"collisionActive\", pair);\r\n\t\t\tbodyB.trigger(\"collisionActive\", pair);\r\n\r\n\t\t\tbodyA.trigger(\"bodyInside\", bodyB);\r\n\t\t\tbodyB.trigger(\"bodyInside\", bodyA);\r\n\t\t}\r\n\t\telse { // No collision between these bodies last frame, so collision just started\r\n\t\t\tbodyA.trigger(\"collisionStart\", pair);\r\n\t\t\tbodyB.trigger(\"collisionStart\", pair);\r\n\r\n\t\t\tbodyA.trigger(\"bodyEnter\", bodyB);\r\n\t\t\tbodyB.trigger(\"bodyEnter\", bodyA);\r\n\t\t\t\r\n\t\t\tbodyA.pairs.push(pairId);\r\n\t\t\tbodyB.pairs.push(pairId);\r\n\t\t}\r\n\r\n\t\tWorld.pairs[pairId] = pair;\r\n\t}\r\n\r\n\t/**\r\n\t * Deletes the collision pair\r\n\t * @param {collisionPair} pair - The pair to delete\r\n\t * @returns {Boolean} If pair was successfully removed, meaning they are no longer colliding\r\n\t */\r\n\tcleansePair(pair) {\r\n\t\tconst { Performance, World } = this;\r\n\t\tif (pair.frame < Performance.frame) {\r\n\t\t\tlet { bodyA, bodyB } = pair;\r\n\r\n\t\t\t// Remove pair\r\n\t\t\tbodyA.pairs.splice(bodyA.pairs.indexOf(pair.id), 1);\r\n\t\t\tbodyB.pairs.splice(bodyB.pairs.indexOf(pair.id), 1);\r\n\t\t\tdelete World.pairs[pair.id];\r\n\r\n\t\t\t// Trigger collisionEnd event\r\n\t\t\tbodyA.trigger(\"collisionEnd\", pair);\r\n\t\t\tbodyB.trigger(\"collisionEnd\", pair);\r\n\r\n\t\t\tbodyA.trigger(\"bodyExit\", bodyB);\r\n\t\t\tbodyB.trigger(\"bodyExit\", bodyA);\r\n\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\r\n\t/**\r\n\t * Solves new velocities for bodies based on their collision pairs\r\n\t */\r\n\tsolveVelocity = function() {\r\n\t\tlet { pairs } = this.World;\r\n\t\t\r\n\t\tfor (let i in pairs) {\r\n\t\t\tlet pair = pairs[i];\r\n\t\t\tif (!pair || this.cleansePair(pair)) continue;\r\n\r\n\t\t\tlet { bodyA, bodyB, normal, tangent, contacts } = pair;\r\n\t\t\tlet numContacts = contacts.length;\r\n\t\t\tif (numContacts === 0) continue;\r\n\r\n\t\t\twhile (bodyA.parent instanceof RigidBody && bodyA.parent !== bodyA) {\r\n\t\t\t\tbodyA = bodyA.parent;\r\n\t\t\t}\r\n\t\t\twhile (bodyB.parent instanceof RigidBody && bodyB.parent !== bodyB) {\r\n\t\t\t\tbodyB = bodyB.parent;\r\n\t\t\t}\r\n\t\t\tif (bodyA.isSensor || bodyB.isSensor) continue;\r\n\r\n\t\t\tconst restitution = 1 + Math.max(bodyA.restitution, bodyB.restitution);\r\n\t\t\tconst relVel = bodyB.velocity.sub(bodyA.velocity);\r\n\t\t\tconst friction = Math.max(bodyA.friction, bodyB.friction);\r\n\t\t\tconst slop = Math.max(bodyA._slop, bodyB._slop);\r\n\r\n\t\t\tif (relVel.dot(normal) < 0) {\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tlet impulse = new vec(0, 0);\r\n\t\t\tlet angImpulseA = 0;\r\n\t\t\tlet angImpulseB = 0;\r\n\r\n\t\t\tlet totalMass = bodyA.mass + bodyB.mass;\r\n\t\t\tlet shareA = (bodyB.mass / totalMass) || 0;\r\n\t\t\tlet shareB = (bodyA.mass / totalMass) || 0;\r\n\t\t\tlet maxShare = this.maxShare;\r\n\t\t\tshareA = Math.min(maxShare, shareA);\r\n\t\t\tshareB = Math.min(maxShare, shareB);\r\n\t\t\tif (bodyA.isStatic) shareB = 1;\r\n\t\t\tif (bodyB.isStatic) shareA = 1;\r\n\r\n\t\t\tfor (let c = 0; c < numContacts; c++) {\r\n\t\t\t\tconst { vertice } = contacts[c];\r\n\r\n\t\t\t\tconst offsetA = vertice.sub(bodyA.position);\r\n\t\t\t\tconst offsetB = vertice.sub(bodyB.position);\r\n\t\t\t\tconst vpA = bodyA.velocity.add(offsetA.normal().mult(-bodyA.angularVelocity));\r\n\t\t\t\tconst vpB = bodyB.velocity.add(offsetB.normal().mult(-bodyB.angularVelocity));\r\n\t\t\t\tvar relativeVelocity = vpA.sub(vpB);\r\n\t\t\t\tconst normalVelocity = relativeVelocity.abs().sub(slop).mult(relativeVelocity.sign()).dot(normal);\r\n\t\t\t\tconst tangentVelocity = relativeVelocity.dot(tangent);\r\n\r\n\t\t\t\tif (normalVelocity > 0) continue;\r\n\t\t\t\tif (c == 1) {\r\n\t\t\t\t\tconsole.log(vpB);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tlet oAcN = offsetA.cross(normal);\r\n\t\t\t\tlet oBcN = offsetB.cross(normal);\r\n\t\t\t\tlet share = 1 / (contacts.length * (bodyA._inverseMass + bodyB._inverseMass + bodyA._inverseInertia * oAcN * oAcN + bodyB._inverseInertia * oBcN * oBcN));\r\n\t\t\t\t\r\n\t\t\t\tconst normalImpulse = restitution * normalVelocity * share;\r\n\t\t\t\tconst tangentImpulse = restitution * tangentVelocity * share;\r\n\r\n\t\t\t\tconst curImpulse = normal.mult(normalImpulse).add2(tangent.mult(tangentImpulse * friction));\r\n\t\t\t\timpulse.add2(curImpulse);\r\n\t\t\t\tangImpulseA += offsetA.cross(curImpulse) * bodyA._inverseInertia;\r\n\t\t\t\tangImpulseB += offsetB.cross(curImpulse) * bodyB._inverseInertia;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif (!bodyA.isStatic) {\r\n\t\t\t\tbodyA.velocity.sub2(impulse.mult(1 / bodyA.mass));\r\n\t\t\t\tbodyA.angularVelocity -= angImpulseA / bodyA.mass;\r\n\t\t\t}\r\n\t\t\tif (!bodyB.isStatic) {\r\n\t\t\t\tbodyB.velocity.add2(impulse.mult(1 / bodyB.mass));\r\n\t\t\t\tbodyB.angularVelocity += angImpulseB / bodyB.mass;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t\r\n\t/**\r\n\t * Solves position intersections between bodies based on their collision pairs\r\n\t */\r\n\tsolvePositions = function() {\r\n\t\tconst { World } = this;\r\n\t\tlet { pairs } = World;\r\n\t\t\r\n\t\tfor (let i in pairs) {\r\n\t\t\tlet pair = pairs[i];\r\n\t\t\tif (!pair || this.cleansePair(pair)) continue;\r\n\t\t\tlet { depth, bodyA, bodyB, normal } = pair;\r\n\t\t\t// depth = Math.min(depth, 15);\r\n\t\t\t\r\n\t\t\twhile (bodyA.parent && bodyA.parent !== bodyA) {\r\n\t\t\t\tbodyA = bodyA.parent;\r\n\t\t\t}\r\n\t\t\twhile (bodyB.parent && bodyB.parent !== bodyB) {\r\n\t\t\t\tbodyB = bodyB.parent;\r\n\t\t\t}\r\n\t\t\tif (bodyA.isSensor || bodyB.isSensor) continue;\r\n\t\t\t\r\n\t\t\tif (depth < 1) continue;\r\n\r\n\t\t\tlet impulse = normal.mult(depth - 1);\r\n\t\t\tlet totalMass = bodyA.mass + bodyB.mass;\r\n\t\t\tlet shareA = (bodyB.mass / totalMass) || 0;\r\n\t\t\tlet shareB = (bodyA.mass / totalMass) || 0;\r\n\t\t\tlet maxShare = this.maxShare;\r\n\t\t\tshareA = Math.min(maxShare, shareA);\r\n\t\t\tshareB = Math.min(maxShare, shareB);\r\n\t\t\tif (bodyA.isStatic) shareB = 1;\r\n\t\t\tif (bodyB.isStatic) shareA = 1;\r\n\t\t\tif (bodyA.isStatic || bodyB.isStatic) impulse.mult(0);\r\n\r\n\t\t\tif (!bodyA.isStatic) {\r\n\t\t\t\tlet a = impulse.mult(shareA * 0.95 / bodyA.pairs.length);\r\n\t\t\t\tbodyA.translate(a);\r\n\t\t\t}\r\n\t\t\tif (!bodyB.isStatic) {\r\n\t\t\t\tlet a = impulse.mult(-shareB * 0.95 / bodyB.pairs.length);\r\n\t\t\t\tbodyB.translate(a);\r\n\t\t\t}\r\n\t\t\tpair.depth -= impulse.length;\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Solves physics constraints for their new position and velocity\r\n\t * @param {Number} delta - Engine tick duration, in seconds\r\n\t */\r\n\tsolveConstraints = function(delta) {\r\n\t\tdelta *= 1000;\r\n\t\tconst constraints = this.World.constraints;\r\n\t\tconst constraintIterations = this.constraintIterations;\r\n\t\tdelta /= constraintIterations;\r\n\r\n\t\tfor (let step = 0; step < constraintIterations; step++) {\r\n\t\t\tfor (let i = 0; i < constraints.length; i++) {\r\n\t\t\t\tlet constraint = constraints[i];\r\n\t\t\t\tlet { bodyA, bodyB, offsetA, offsetB, stiffness, angularStiffness, length, ignoreSlack } = constraint;\r\n\t\t\t\tlet pointA = bodyA.position.add(offsetA.rotate(bodyA.angle));\r\n\t\t\t\tlet pointB = bodyB.position.add(offsetB.rotate(bodyB.angle));\r\n\r\n\t\t\t\t// constraint velocity solver\r\n\t\t\t\tlet diff = pointA.sub(pointB);\r\n\t\t\t\tlet normal = diff.normalize();\r\n\t\t\t\tlet tangent = normal.normal();\r\n\r\n\t\t\t\tlet totalMass = bodyA.mass + bodyB.mass;\r\n\t\t\t\tlet shareA = (bodyB.mass / totalMass) || 0;\r\n\t\t\t\tlet shareB = (bodyA.mass / totalMass) || 0;\r\n\t\t\t\tlet maxShare = this.maxShare;\r\n\t\t\t\tshareA = Math.min(maxShare, shareA);\r\n\t\t\t\tshareB = Math.min(maxShare, shareB);\r\n\t\t\t\tif (bodyA.isStatic) shareB = 1;\r\n\t\t\t\tif (bodyB.isStatic) shareA = 1;\r\n\r\n\t\t\t\tfunction solveImpulse(vertice, point, body) { // vertice = where the constraint goes to, point = where the constraint is\r\n\t\t\t\t\tlet offset = point.sub(body.position);\r\n\t\t\t\t\tlet offsetLen = offset.length;\r\n\t\t\t\t\tif (offsetLen > length * 3) {\r\n\t\t\t\t\t\toffset.mult2(length / offsetLen);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconst vp1 = body.velocity.add(offset.normal().mult(-body.angularVelocity));\r\n\t\t\t\t\tconst vp2 = vertice.sub(point).mult(stiffness * 30);\r\n\t\t\t\t\tif (ignoreSlack && diff.length < length * (1 + stiffness)) { // idk how to get this to work\r\n\t\t\t\t\t\tvp1.mult2(0);\r\n\t\t\t\t\t\tvp2.mult2(0);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconst relativeVelocity = vp1.sub(vp2);\r\n\t\t\t\t\tconst normalVelocity = relativeVelocity.dot(normal);\r\n\t\t\t\t\tconst tangentVelocity = relativeVelocity.dot(tangent);\r\n\t\t\t\t\tlet tangentImpulse = tangentVelocity;\r\n\t\t\t\t\t\r\n\t\t\t\t\tlet normalImpulse = (stiffness) * normalVelocity; // min is to prevent breakage\r\n\t\t\t\t\tnormalImpulse = Math.min(Math.abs(normalImpulse), 300) * Math.sign(normalImpulse);\r\n\t\t\t\t\tlet curImpulse = normal.mult(normalImpulse).add2(tangent.mult(tangentImpulse * angularStiffness));\r\n\r\n\t\t\t\t\treturn {\r\n\t\t\t\t\t\tangularImpulse: offset.cross(curImpulse) * body._inverseInertia / 2,\r\n\t\t\t\t\t\tnormalImpulse: curImpulse.mult(0.5),\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tlet impulseDiff = pointA.sub(pointB).normalize().mult(length);\r\n\t\t\t\tlet impulsePtA = bodyA.isStatic ? pointA : pointB.add(impulseDiff);\r\n\t\t\t\tlet impulsePtB = bodyB.isStatic ? pointB : pointA.sub(impulseDiff);\r\n\r\n\t\t\t\tlet { angularImpulse: angImpulseA, normalImpulse: impulseA } = solveImpulse(impulsePtA, pointA, bodyA);\r\n\t\t\t\tlet { angularImpulse: angImpulseB, normalImpulse: impulseB } = solveImpulse(impulsePtB, pointB, bodyB);\r\n\t\t\t\t\r\n\t\t\t\tif (!bodyA.isStatic) {\r\n\t\t\t\t\tbodyA.velocity.sub2(impulseA.mult(shareA * delta));\r\n\t\t\t\t\tbodyA.angularVelocity -= angImpulseA * shareA * delta;\r\n\t\t\t\t}\r\n\t\t\t\tif (!bodyB.isStatic) {\r\n\t\t\t\t\tbodyB.velocity.sub2(impulseB.mult(shareB * delta));\r\n\t\t\t\t\tbodyB.angularVelocity -= angImpulseB * shareB * delta;\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// constraint position solver\r\n\t\t\t\t// let nextLength = pointA.sub(pointB).length + (length - pointA.sub(pointB).length) * stiffness;\r\n\t\t\t\t// let changeA = nextLength - impulsePtB.sub(bodyA.position).length;\r\n\t\t\t\t// changeA = Math.min(50, Math.abs(changeA)) * Math.sign(changeA);\r\n\t\t\t\t// let changeB = nextLength - impulsePtA.sub(bodyB.position).length;\r\n\t\t\t\t// changeB = Math.min(50, Math.abs(changeB)) * Math.sign(changeB);\r\n\r\n\t\t\t\t// bodyA.translate(normal.mult((changeA) * shareA * delta * 0.05));\r\n\t\t\t\t// bodyB.translate(normal.mult((changeB) * shareB * delta * 0.05));\r\n\r\n\t\t\t\tconstraint.updateBounds();\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t}\r\n};\r\n","const vec = require(\"../geometry/vec.js\");\r\nconst Node = require(\"../node/Node.js\");\r\nconst Common = require(\"../core/Common.js\");\r\nconst decomp = require(\"../lib/poly-decomp.js\");\r\nconst PolygonRender = require(\"../render/PolygonRender.js\");\r\nconst Sprite = require(\"../render/Sprite.js\");\r\nconst Bezier = require(\"../geometry/Bezier.js\");\r\nconst Bounds = require(\"../geometry/Bounds.js\");\r\n\r\nmodule.exports = class RigidBody extends Node {\r\n\tstatic defaultOptions = { // not used, but consistent with other classes for documentation\r\n\t\tmass: 1,\r\n\t\trestitution: 0.5,\r\n\t\tfrictionAir: 0.05,\r\n\t\tfrictionAngular: 0.01,\r\n\t\tfriction: 0.01,\r\n\t\tround: 0,\r\n\t\r\n\t\tisStatic: false,\r\n\t\tisSensor: false,\r\n\t\thasCollisions: true,\r\n\t\tcollisionFilter: {\r\n\t\t\tlayer: 0xFFFFFF,\r\n\t\t\tmask: 0xFFFFFF,\r\n\t\t},\r\n\t}\r\n\tstatic roundVertices(vertices, round, dx = 40) {\r\n\t\tlet newVertices = [];\r\n\t\tlet verticesLength = vertices.length;\r\n\t\tfor (let i = 0; i < verticesLength; i++) {\r\n\t\t\tlet prev = vertices[(i - 1 + verticesLength) % verticesLength];\t\r\n\t\t\tlet cur = vertices[i];\t\r\n\t\t\tlet next = vertices[(i + 1) % verticesLength];\t\r\n\r\n\t\t\t// get vectors\r\n\t\t\tlet prevToCur = cur.sub(prev);\r\n\t\t\tlet curToNext = next.sub(cur);\r\n\t\t\tlet prevCurNormalized = prevToCur.normalize();\r\n\t\t\tlet curNextNormalized = curToNext.normalize();\r\n\r\n\t\t\t// get round amount\r\n\t\t\tlet prevRound = Math.min(round, prevToCur.length / 2);\r\n\t\t\tlet nextRound = Math.min(round, curToNext.length / 2);\r\n\t\t\tlet curRound = Math.min(prevRound, nextRound);\r\n\r\n\t\t\tlet start = prevCurNormalized.mult(-curRound).add(cur);\r\n\t\t\tlet cp1 = prevCurNormalized.mult(-curRound * 0.45).add(cur);\r\n\t\t\tlet cp2 = curNextNormalized.mult(curRound *  0.45).add(cur);\r\n\t\t\tlet end = curNextNormalized.mult(curRound).add(cur);\r\n\t\t\tlet bezier = new Bezier(start, cp1, cp2, end);\r\n\t\t\tfor (let i = 0; i < bezier.length;) {\r\n\t\t\t\tnewVertices.push(bezier.get(i));\r\n\t\t\t\ti += dx;\r\n\t\t\t}\r\n\t\t\tnewVertices.push(end);\r\n\t\t}\r\n\t\treturn newVertices;\r\n\t}\r\n\r\n\t//\r\n\t// Public user options\r\n\t//\r\n\tvertices = [];\r\n\r\n\tmass = 1;\r\n\trestitution = 0.5;\r\n\tfrictionAir = 0.05;\r\n\tfrictionAngular = 0.01;\r\n\tfriction = 0.01;\r\n\tround = 0;\r\n\r\n\tisStatic = false;\r\n\tisSensor = false;\r\n\thasCollisions = true;\r\n\tcollisionFilter = {\r\n\t\tlayer: 0xFFFFFF,\r\n\t\tmask: 0xFFFFFF,\r\n\t}\r\n\r\n\t/**\r\n\t * @constructor\r\n\t * Creates a new RigidBody\r\n\t * @param {Array} vertices Array of `vec` representing the body's vertices\r\n\t * @param {vec} position - The position of the body\r\n\t * @param {Engine} Engine - The engine the body should be simulated in\r\n\t * @param {Object} options - RigidBody options, see documentation for options\r\n\t */\r\n\tconstructor(Engine, vertices, position, options = {}) {\r\n\t\tsuper();\r\n\t\tif (!this.Engine) this.Engine = Engine;\r\n\t\t\r\n\t\t// Shallow copy World\r\n\t\tthis.World = this.Engine.World;\r\n\t\tdelete options.World;\r\n\r\n\t\t// Shallow copy render\r\n\t\tif (options.render) {\r\n\t\t\tthis.addChild(options.render);\r\n\t\t\tdelete options.render;\r\n\t\t}\r\n\r\n\t\t// Merge collision filters\r\n\t\tif (typeof options.collisionFilter === \"object\") Common.merge(this.collisionFilter, options.collisionFilter, 1);\r\n\r\n\t\t// Merge options with body\r\n\t\tCommon.merge(this, options, 1);\r\n\t\t\r\n\t\t// Parse collision filter properties\r\n\t\tfor (let filterType in [\"layer\", \"mask\"]) {\r\n\t\t\tif (typeof this.collisionFilter[filterType] === \"string\") {\r\n\t\t\t\tthis.collisionFilter[filterType] = parseInt(this.collisionFilter[filterType], 2);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Convert vertices to vec\r\n\t\tthis.vertices = vertices.map(v => new vec(v));\r\n\t\t\r\n\t\t// round vertices\r\n\t\tif (options.round && options.round > 0) {\r\n\t\t\tthis.vertices = RigidBody.roundVertices(this.vertices, this.round, this.roundQuality);\r\n\t\t}\r\n\r\n\t\t// Create bounds\r\n\t\tthis.bounds = new Bounds(this.vertices);\r\n\r\n\t\t// Reset vertices so convex check works properly\r\n\t\tthis.#removeDuplicateVertices();\r\n\t\tthis._resetVertices(false);\r\n\r\n\t\t// Fully reset vertices\r\n\t\tthis._resetVertices();\r\n\t\tthis._updateInertia();\r\n\r\n\t\t// Set angle from options\r\n\t\tif (options.angle) {\r\n\t\t\tthis.angle = 0;\r\n\t\t\tthis.setAngle(-options.angle);\r\n\t\t}\r\n\t\tthis.setPosition(position);\r\n\t}\r\n\t\r\n\t//\r\n\t// Public user methods\r\n\t//\r\n\t/**\r\n\t * Adds the body to its world\r\n\t * @returns {RigidBody} `this`\r\n\t */\r\n\tadd() {\r\n\t\tlet World = this.Engine.World;\r\n\t\tif (!this.added) {\r\n\t\t\tsuper.add();\r\n\t\t\tWorld.addChild(this);\r\n\t\t}\r\n\t\treturn this;\r\n\t}\r\n\r\n\t/**\r\n\t * Removes the body from its world\r\n\t * @returns {RigidBody} `this`\r\n\t */\r\n\tdelete() {\r\n\t\tlet World = this.Engine.World;\r\n\t\tif (this.added) {\r\n\t\t\tsuper.delete();\r\n\t\t\tWorld.removeChild(this);\r\n\r\n\t\t\tfor (let i = 0; i < this.pairs.length; i++) {\r\n\t\t\t\tthis.Engine.cleansePair(this.pairs[i]);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn this;\r\n\t}\r\n\r\n\t/**\r\n\t * Adds a polygon render to body\r\n\t * @param {PIXI.Container} container - Container polygon render is added to\r\n\t * @param {Object} options - Options for polygon render, see documentation for possible options\r\n\t * @returns {RigidBody} `this`\r\n\t */\r\n\taddPolygonRender(container, options) {\r\n\t\tlet render = new PolygonRender({\r\n\t\t\tcontainer: container,\r\n\t\t\tposition: new vec(this.position),\r\n\t\t\tvertices: this.vertices,\r\n\t\t\t\r\n\t\t\t...options\r\n\t\t});\r\n\t\tif (this.added) render.add();\r\n\t\tthis.addChild(render);\r\n\t\t\r\n\t\treturn this;\r\n\t}\r\n\r\n\t/**\r\n\t * Adds a sprite to body\r\n\t * @param {PIXI.Container} container - Container polygon render is added to\r\n\t * @param {Object} options - Sprite options, see documentation for possible options\r\n\t * @returns {RigidBody} `this`\r\n\t */\r\n\taddSprite(container, options) {\r\n\t\tlet render = new Sprite({\r\n\t\t\tcontainer: container,\r\n\t\t\tposition: new vec(this.position),\r\n\t\t\t\r\n\t\t\t...options\r\n\t\t});\r\n\t\tif (this.added) render.add();\r\n\t\tthis.addChild(render);\r\n\t\t\r\n\t\treturn this;\r\n\t}\r\n\t\r\n\t/**\r\n\t * Changes if the body is static\r\n\t * @param {Boolean} isStatic - If the body should be static\r\n\t * @returns {void}\r\n\t */\r\n\tsetStatic(isStatic) {\r\n\t\tlet { dynamicGrid, staticGrid } = this.Engine.World;\r\n\t\tlet lastStatic = this.isStatic;\r\n\t\tif (isStatic === lastStatic) return;\r\n\t\t\r\n\t\tthis.isStatic = isStatic;\r\n\r\n\t\tif (this.hasCollisions && !this.removed) {\r\n\t\t\tif (lastStatic) {\r\n\t\t\t\tstaticGrid.removeBody(this);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tdynamicGrid.removeBody(this);\r\n\t\t\t}\r\n\r\n\t\t\tif (isStatic) {\r\n\t\t\t\tstaticGrid.addBody(this);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tdynamicGrid.addBody(this);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Changes if the body can collide with other bodies\r\n\t * @param {Number} hasCollisions - Whether the body can collide with other bodies\r\n\t * @returns {void}\r\n\t */\r\n\tsetCollisions(hasCollisions) {\r\n\t\tlet { dynamicGrid, staticGrid } = this.Engine.World;\r\n\t\tif (hasCollisions === this.hasCollisions) return;\r\n\r\n\t\tthis.hasCollisions = hasCollisions;\r\n\r\n\t\tif (this.hasCollisions) {\r\n\t\t\tif (this.isStatic) {\r\n\t\t\t\tstaticGrid.addBody(this);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tdynamicGrid.addBody(this);\r\n\t\t\t}\r\n\t\t}\r\n\t\telse {\r\n\t\t\tif (this.isStatic) {\r\n\t\t\t\tstaticGrid.removeBody(this);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tdynamicGrid.removeBody(this);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Finds if a point is inside the body\r\n\t * @param {vec} point The point to query\r\n\t * @returns {Boolean} If the point is inside the body's vertices\r\n\t */\r\n\tcontainsPoint(point) {\r\n\t\tlet vertices = this.vertices;\r\n\t\tfor (let i = 0; i < vertices.length; i++) {\r\n\t\t\tlet curVertice = vertices[i];\r\n\t\t\tlet nextVertice = vertices[(i + 1) % vertices.length];\r\n\t\t\t\r\n\t\t\tif ((point.x - curVertice.x) * (nextVertice.y - curVertice.y) + (point.y - curVertice.y) * (curVertice.x - nextVertice.x) >= 0) {\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn true;\r\n\t}\r\n\r\n\t/**\r\n\t * Instantly sets body's position to `position`\r\n\t * @param {vec} position - The position the body should be\r\n\t * @param {Boolean} _ignoreChildren - If the body's children should be affected\r\n\t * @example\r\n\t * body.setPosition(new vec(100, 100)); // Sets body's position to (100, 100) \r\n\t * @returns {void}\r\n\t */\r\n\tsetPosition(position, _ignoreChildren = false) {\r\n\t\tlet delta = position.sub(this.position);\r\n\t\tthis.translate(delta, true, _ignoreChildren);\r\n\t}\r\n\t\r\n\t/**\r\n\t * Shifts body's position by delta\r\n\t * @param {vec} delta - Distance the body should be shifted\r\n\t * @param {Boolean} affectPosition - If the body's position should be affected\r\n\t * @param {Boolean} ignoreChildren - If the body's children should be shifted as well\r\n\t * @returns {void}\r\n\t */\r\n\ttranslate(delta, affectPosition = true, ignoreChildren = false) {\r\n\t\tif (delta.isNaN()) return;\r\n\t\tlet vertices = this.vertices;\r\n\t\tfor (let i = 0; i < vertices.length; i++) {\r\n\t\t\tvertices[i].add2(delta);\r\n\t\t}\r\n\r\n\t\tif (affectPosition) {\r\n\t\t\tthis.position.add2(delta);\r\n\t\t}\r\n\t\tthis.bounds.update(this.vertices);\r\n\r\n\t\tlet tree = this.Engine.World.dynamicGrid;\r\n\t\tif (this._Grids && this._Grids[tree.id]) {\r\n\t\t\ttree.updateBody(this);\r\n\t\t}\r\n\r\n\t\tif (!ignoreChildren) {\r\n\t\t\tlet children = this.children;\r\n\t\t\tfor (let child of children) {\r\n\t\t\t\tchild.translate(delta, affectPosition);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Rotates the body to `angle` - Absolute\r\n\t * @param {Number} angle - Angle body should be in radians\r\n\t * @example\r\n\t * body.setAngle(Math.PI); // Sets body's angle to Pi radians, or 180 degrees \r\n\t * @returns {void}\r\n\t */\r\n\tsetAngle(angle) {\r\n\t\tif (isNaN(angle)) return;\r\n\t\tif (angle !== this.angle) {\r\n\t\t\tlet delta = Common.angleDiff(angle, this.angle);\r\n\t\t\tthis.translateAngle(delta);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Rotates the body by `angle`- Relative\r\n\t * @param {Number} angle - The amount the body should be rotated, in radians\r\n\t * @param {Boolean} silent - If the body's angle should be affected\r\n\t * @returns {void}\r\n\t */\r\n\ttranslateAngle(angle, silent = false) {\r\n\t\tif (isNaN(angle)) return;\r\n\t\tlet vertices = this.vertices;\r\n\t\tlet position = this.position;\r\n\t\tlet rotationPoint = this.rotationPoint.rotate(this.angle + angle);\r\n\t\tif (this.parent) {\r\n\t\t\trotationPoint.add2(this.position.sub(this.parent.position));\r\n\t\t}\r\n\t\tlet sin = Math.sin(angle);\r\n\t\tlet cos = Math.cos(angle);\r\n\r\n\t\tfor (let i = vertices.length; i-- > 0;) {\r\n\t\t\tlet vert = vertices[i];\r\n\t\t\tlet dist = vert.sub(position);\r\n\t\t\tvert.x = position.x + (dist.x * cos - dist.y * sin);\r\n\t\t\tvert.y = position.y + (dist.x * sin + dist.y * cos);\r\n\t\t}\r\n\r\n\t\tlet posOffset = rotationPoint.sub(rotationPoint.rotate(angle));\r\n\t\tthis.translate(posOffset);\r\n\t\tif (!silent) {\r\n\t\t\tthis.angle += angle;\r\n\t\t}\r\n\r\n\t\tthis.bounds.update(this.vertices);\r\n\t\tthis.#updateAxes();\r\n\r\n\t\tfor (let child of this.children) {\r\n\t\t\tchild.translateAngle?.(angle, silent);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Instantly changes the body's velocity to a specific value\r\n\t * @param {vec} velocity - The velocity the body should have\r\n\t * @returns {void}\r\n\t */\r\n\tsetVelocity(velocity) {\r\n\t\tif (velocity.isNaN()) {\r\n\t\t\tconsole.error(velocity);\r\n\t\t\tthrow new Error(\"Invalid velocity\");\r\n\t\t}\r\n\t\tif (this.isStatic) return;\r\n\t\tthis.velocity.set(velocity);\r\n\t}\r\n\r\n\t/**\r\n\t * Instantly changes the body's angular velocity to a specific value\r\n\t * @param {vec} velocity - The angular velocity the body should have\r\n\t * @returns {void}\r\n\t */\r\n\tsetAngularVelocity(velocity) {\r\n\t\tif (velocity.isNaN()) {\r\n\t\t\tconsole.error(velocity);\r\n\t\t\tthrow new Error(\"Invalid angular velocity\");\r\n\t\t}\r\n\t\tif (this.isStatic) return;\r\n\t\tthis.angularVelocity = velocity;\r\n\t}\r\n\r\n\t/**\r\n\t * Applies a force to the body, ignoring mass. The body's velocity changes by force * delta\r\n\t * @param {vec} force - The amount of force to be applied, in px / sec^2\r\n\t * @param {Number} delta - The amount of time that the force should be applied in seconds, set to 1 if only applying in one instant\r\n\t * @returns {void}\r\n\t */\r\n\tapplyForce(force, delta = Engine.delta) { // set delta to 1 if you want to apply a force for only 1 frame\r\n\t\tif (force.isNaN()) return;\r\n\t\tif (this.isStatic) return;\r\n\t\tthis.force.add2(force.mult(delta));\r\n\t}\r\n\t\r\n\t/**\r\n\t * Applies a rotational force (torque) to the body, ignoring mass. The body's angular velocity changes by force * delta\r\n\t * @param {Number} force - The amount of torque to be applied, in radians / sec^2\r\n\t * @param {Number} delta - The amount of time the force should be applied in seconds, set to 1 if only applying instantaneous force\r\n\t * @returns {void}\r\n\t */\r\n\tapplyTorque(force, delta = Engine.delta) { // set delta to 1 if you want to apply a force for only 1 frame\r\n\t\tif (isNaN(force)) return;\r\n\t\tthis.torque += force * delta;\r\n\t}\r\n\r\n\t// \r\n\t// Private engine variables\r\n\t// \r\n\tEngine = null;\r\n\tparent = null;\r\n\r\n\tposition = new vec(0, 0);\r\n\tvelocity = new vec(0, 0);\r\n\tangle = 0;\r\n\tangularVelocity = 0;\r\n\t_last = {\r\n\t\tvelocity: new vec(0, 0),\r\n\t\tangularVelocity: 0,\r\n\t};\r\n\t\r\n\tforce = new vec(0, 0);\r\n\timpulse = new vec(0, 0);\r\n\tcenter = new vec(0, 0);\r\n\ttorque = 0;\r\n\t\r\n\taxes = [];\r\n\trotationPoint = new vec(0, 0);\r\n\r\n\t_inverseMass = 1;\r\n\tinertia = 1;\r\n\t_inverseInertia = 0.000015;\t\r\n\r\n\tpairs = [];\r\n\t_lastSeparations = {};\r\n\t_slop = 0.001;\r\n\r\n\tbounds = null;\r\n\r\n\t#events = {\r\n\t\tcollisionStart: [],\r\n\t\tcollisionActive: [],\r\n\t\tcollisionEnd: [],\r\n\r\n\t\tbodyEnter: [],\r\n\t\tbodyInside: [],\r\n\t\tbodyExit: [],\r\n\t\t\r\n\t\tbeforeUpdate: [], // use to apply forces to current body\r\n\t\tduringUpdate: [], // use to clear forces from current body\r\n\t\tdelete: [],\r\n\t\tadd: [],\r\n\t}\r\n\r\n\t// \r\n\t// Private engine methods\r\n\t// \r\n\t/**\r\n\t * Prepares the body \r\n\t * @param {Number} delta - Engine tick duration, in seconds\r\n\t * @returns {void}\r\n\t */\r\n\t_preUpdate(delta) {\r\n\t\tthis.trigger(\"beforeUpdate\");\r\n\r\n\t\tif (this.isStatic) return;\r\n\r\n\t\t// apply forces\r\n\t\tthis.velocity.add2(this.force).add2(this.Engine.World.gravity.mult(delta));\r\n\t\tthis.angularVelocity += this.torque;\r\n\r\n\t\t// clear forces\r\n\t\tthis.force.x = 0;\r\n\t\tthis.force.y = 0;\r\n\t\tthis.torque = 0;\r\n\t}\r\n\t/**\r\n\t * Updates this body's velocity, position, and grid\r\n\t * @param {Number} delta - Engine tick duration, in seconds\r\n\t * @returns {void}\r\n\t */\r\n\t_update(delta) {\r\n\t\tthis.trigger(\"duringUpdate\");\r\n\r\n\t\tif (this.isStatic) return;\r\n\r\n\t\tconst timescale = delta;\r\n\t\tlet { velocity: lastVelocity, angularVelocity: lastAngularVelocity } = this._last;\r\n\r\n\t\tlet frictionAir = (1 - this.frictionAir) ** timescale;\r\n\t\tlet frictionAngular = (1 - this.frictionAngular) ** timescale;\r\n\r\n\t\tif (isNaN(timescale) || this.velocity.isNaN() || isNaN(frictionAir + frictionAngular)) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\tthis.velocity.mult2(frictionAir);\r\n\t\tif (this.velocity.x !== 0 || this.velocity.y !== 0){\r\n\t\t\tthis.translate(this.velocity.add(lastVelocity).mult(timescale / 2)); // trapezoidal rule to take into account acceleration\r\n\t\t\t// body.translate(body.velocity.mult(timescale)); // potentially more stable, but less accurate\r\n\t\t}\r\n\t\tthis._last.velocity.set(this.velocity);\r\n\r\n\t\tthis.angularVelocity *= frictionAngular;\r\n\t\tif (this.angularVelocity){\r\n\t\t\tthis.translateAngle((this.angularVelocity + lastAngularVelocity) * timescale / 2); // trapezoidal rule to take into account acceleration\r\n\t\t\t// body.translateAngle((body.angularVelocity) * timescale); // potentially more stable, but less accurate\r\n\t\t}\r\n\t\tthis._last.angularVelocity = this.angularVelocity;\r\n\t\t\r\n\t\tthis.bounds.update(this.vertices);\r\n\r\n\t\tif (this.hasCollisions) {\r\n\t\t\tthis.Engine.World.dynamicGrid.updateBody(this);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Calculates the area of the body if it is convex\r\n\t * @returns {Number} The area of the body\r\n\t */\r\n\t#getArea() {\r\n\t\tlet area = 0;\r\n\t\tlet vertices = this.vertices;\r\n\t\tlet len = vertices.length;\r\n\t\tfor (let i = 0; i < len; i++) {\r\n\t\t\tarea += vertices[i].cross(vertices[(i + 1) % len]);\r\n\t\t}\r\n\t\treturn area * 0.5;\r\n\t}\r\n\r\n\t/**\r\n\t * Calculates inertia from the body's vertices\r\n\t * @returns {Number} The body's inertia\r\n\t */\r\n\t#getInertia() {\r\n\t\tconst { vertices, mass } = this;\r\n\t\t\r\n\t\tlet numerator = 0;\r\n\t\tlet denominator = 0;\r\n\r\n\t\tfor (var i = 0; i < vertices.length; i++) {\r\n\t\t\tlet j = (i + 1) % vertices.length;\r\n\t\t\tlet cross = Math.abs(vertices[j].cross(vertices[i]));\r\n\t\t\tnumerator += cross * (vertices[j].dot(vertices[j]) + vertices[j].dot(vertices[i]) + vertices[i].dot(vertices[i]));\r\n\t\t\tdenominator += cross;\r\n\t\t}\r\n\r\n\t\treturn (mass / 6) * (numerator / denominator);\r\n\t}\r\n\t/**\r\n\t * Sets the inertia of the body to what's calculated in `#getInertia()` if the body is not static\r\n\t * @returns {void}\r\n\t */\r\n\t_updateInertia() {\r\n\t\tif (this.isStatic) {\r\n\t\t\tthis.mass = Infinity;\r\n\t\t\tthis._inverseMass = 0;\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis.inertia = this.#getInertia();\r\n\t\t\tthis._inverseInertia = 1 / this.inertia;\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Removes overlapping vertices\r\n\t * @param {Number} minDist - Minimum distance when points are considered the same\r\n\t * @returns {void}\r\n\t */\r\n\t#removeDuplicateVertices(minDist = 1) { // remove vertices that are the same\r\n\t\tlet vertices = this.vertices;\r\n\t\tfor (let i = 0; i < vertices.length; i++) {\r\n\t\t\tlet curVert = vertices[i];\r\n\t\t\t\r\n\t\t\tfor (let j = 0; j < vertices.length; j++) {\r\n\t\t\t\tif (j === i) continue;\r\n\t\t\t\tlet nextVert = vertices[j];\r\n\t\t\t\tlet dist = curVert.sub(nextVert);\r\n\r\n\t\t\t\tif (Math.abs(dist.x) + Math.abs(dist.y) < minDist) { // just use manhattan dist because it doesn't really matter\r\n\t\t\t\t\tvertices.splice(i, 1);\r\n\t\t\t\t\ti--;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Determines if the body is convex\r\n\t * @returns {Boolean} If the body is convex\r\n\t */\r\n\t#isConvex() {\r\n\t\tlet vertices = this.vertices;\r\n\t\tlet len = vertices.length;\r\n\r\n\t\tlet last = vertices[0].sub(vertices[1]);\r\n\t\tlet sign = 0;\r\n\t\tfor (let i = 1; i < len; i++) {\r\n\t\t\tlet cur = vertices[i].sub(vertices[(i + 1) % len]);\r\n\t\t\tlet curSign = Math.sign(cur.cross(last));\r\n\r\n\t\t\tif (sign === 0) {\r\n\t\t\t\tsign = curSign;\r\n\t\t\t}\r\n\t\t\telse if (curSign !== 0) {\r\n\t\t\t\tif (sign !== curSign) {\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tlast = cur;\r\n\t\t}\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\t/**\r\n\t * Decomposes a concave body into convex children\r\n\t * @returns {void}\r\n\t */\r\n\t#makeConvex() {\r\n\t\tif (!this.#isConvex()) {\r\n\t\t\tlet added = this.added;\r\n\t\t\tthis.delete();\r\n\t\t\t\r\n\t\t\tlet { vertices, position } = this;\r\n\t\t\tthis.children = [];\r\n\t\t\tlet verts = vertices.map(v => [v.x, v.y]);\r\n\t\t\tdecomp.removeCollinearPoints(verts, 0.4);\r\n\t\t\tlet concaveVertices = decomp.quickDecomp(verts);\r\n\t\t\tlet parentCenter = this.#getCenterOfMass();\r\n\r\n\t\t\tfor (let i = 0; i < concaveVertices.length; i++) {\r\n\t\t\t\tlet vertices = concaveVertices[i].map(v => new vec(v[0], v[1]));\r\n\t\t\t\tlet center = Common.getCenterOfMass(vertices);\r\n\t\t\t\tlet body = new FromVertices(vertices, position.add(center).sub(parentCenter));\r\n\t\t\t\tbody.delete();\r\n\t\t\t\tbody.parent = this;\r\n\t\t\t\tthis.addChild(body);\r\n\t\t\t}\r\n\r\n\t\t\tif (added) {\r\n\t\t\t\tthis.add();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t#getCenterOfMass() {\r\n\t\tlet center = Common.getCenterOfMass(this.vertices);\r\n\t\tthis.center.set(center);\r\n\t\treturn center;\r\n\t}\r\n\r\n\t/**\r\n\t * Calculates the body's axes from its vertices\r\n\t */\r\n\t#updateAxes() {\r\n\t\tlet verts = this.vertices;\r\n\t\tlet axes = [];\r\n\r\n\t\tfor (let i = 0; i < verts.length; i++) {\r\n\t\t\tlet curVert = verts[i];\r\n\t\t\tlet nextVert = verts[(i + 1) % verts.length];\r\n\r\n\t\t\taxes.push(nextVert.sub(curVert));\r\n\t\t}\r\n\t\tfor (let i = 0; i < axes.length; i++) {\r\n\t\t\taxes[i] = axes[i].normal().normalize2();\r\n\t\t}\r\n\r\n\t\tthis._axes = axes;\r\n\t}\r\n\r\n\t/**\r\n\t * Shifts vertices so their center is at the body's position \r\n\t */\r\n\t#recenterVertices() {\r\n\t\tlet center = this.#getCenterOfMass();\r\n\t\tlet position = this.position;\r\n\t\tcenter.sub2(position);\r\n\t\t\r\n\t\tfor (let i = 0; i < this.vertices.length; i++) {\r\n\t\t\tthis.vertices[i].sub2(center);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Ensures vertices are counterclockwise winding and centered, and updates the area, bounding box, and the axes\r\n\t * @param {Number} forceCCW - If vertices should be forced to be counterclockwise winding by sorting their angles from the center\r\n\t */\r\n\t_resetVertices(forceCCW = false) {\r\n\t\tthis.#makeCCW(forceCCW);\r\n\t\tthis.area = this.#getArea();\r\n\t\tthis.#recenterVertices();\r\n\t\tthis.bounds.update(this.vertices);\r\n\t\tthis.#updateAxes();\r\n\t}\r\n\r\n\t/**\r\n\t * Tries to ensure the body's vertices are counterclockwise winding, by default by comparing the angles of the first 2 vertices and reversing the vertice array if they're clockwise\r\n\t * @param {Boolean} force - If all vertices should be completely reordered using their angle from the center \r\n\t */\r\n\t#makeCCW(force = false) { // makes vertices go counterclockwise if they're clockwise\r\n\t\tif (force) { // reorders vertices by angle from center - can change order of vertices\r\n\t\t\tlet vertices = this.vertices;\r\n\t\t\tlet center = this.position;\r\n\t\t\tlet mapped = vertices.map(v => [v, v.sub(center).angle]);\r\n\t\t\tmapped.sort((a, b) => Common.angleDiff(a[1], b[1]));\r\n\t\t\tthis.vertices = mapped.map(v => v[0]);\r\n\t\t}\r\n\t\telse { // reverses vertices if the 1st and 2nd are going wrong direction - never changes order of vertices\r\n\t\t\tlet vertices = this.vertices;\r\n\t\t\tlet center = this.position;\r\n\t\r\n\t\t\tlet mapped = vertices.map(v => v.sub(center).angle);\r\n\t\t\tif (Common.angleDiff(mapped[0], mapped[1]) > 0) {\r\n\t\t\t\tthis.vertices.reverse();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Finds the vertice farthest in a direction\r\n\t * @param {vec} vector - Normalized direction to find the support point\r\n\t * @param {vec} position - Position to base support on\r\n\t * @returns {Array} \r\n\t */\r\n\t_getSupport(vector, position = this.position) {\r\n\t\tlet vertices = this.vertices;\r\n\t\tlet bestDist = 0;\r\n\t\tlet bestVert;\r\n\t\tfor (let i = 0; i < vertices.length; i++) {\r\n\t\t\tlet dist = vector.dot(vertices[i].sub(position));\r\n\r\n\t\t\tif (dist > bestDist) {\r\n\t\t\t\tbestDist = dist;\r\n\t\t\t\tbestVert = i;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn [ bestVert, bestDist ];\r\n\t}\r\n}\r\n","const vec = require(\"../geometry/vec.js\");\r\n\r\nmodule.exports = class Camera {\r\n\tposition = new vec(0, 0);\r\n\tfov = 2000;\r\n\ttranslation = new vec(0, 0);\r\n\tscale = 1;\r\n\tboundSize = 1000;\r\n\r\n\tconstructor(fov = 2000, boundSize = 1000) {\r\n\t\tthis.fov = fov;\r\n\t\tthis.boundSize = boundSize;\r\n\t}\r\n};\r\n","module.exports = class DebugRender {\r\n\t// - Debug rendering\r\n\tcanvas = null;\r\n\tctx = null;\r\n\tenabled = {\r\n\t\tcollisions: false,\r\n\t\tboundingBox: false,\r\n\t\tvertices: false,\r\n\t\tcenters: false,\r\n\t\tbroadphase: false,\r\n\t}\r\n\r\n\tconstructor(Game) {\r\n\t\tthis.Game = Game;\r\n\r\n\t\tlet scale = devicePixelRatio ?? 1;\r\n\t\tlet canvas = this.canvas = document.createElement(\"canvas\");\r\n\t\tthis.ctx = canvas.getContext(\"2d\");\r\n\t\tcanvas.style.position = \"absolute\";\r\n\t\tcanvas.style.zIndex = 1;\r\n\t\tcanvas.style.top =  \"0px\";\r\n\t\tcanvas.style.left = \"0px\";\r\n\t\tcanvas.width  = scale * window.innerWidth;\r\n\t\tcanvas.height = scale * window.innerHeight;\r\n\t\tcanvas.style.background = \"transparent\";\r\n\t\tcanvas.style.pointerEvents = \"none\";\r\n\t\tcanvas.style.transformOrigin = \"top left\";\r\n\t\tcanvas.style.transform = `scale(${1 / scale}, ${1 / scale})`;\r\n\t\tdocument.body.appendChild(canvas);\r\n\r\n\t\tGame.Render.app.renderer.on(\"resize\", (width, height) => {\r\n\t\t\tlet scale = devicePixelRatio ?? 1;\r\n\t\t\tcanvas.width  = width  * scale;\r\n\t\t\tcanvas.height = height * scale;\r\n\t\t\tcanvas.style.transform = `scale(${1 / scale}, ${1 / scale})`;\r\n\t\t});\r\n\r\n\t\tthis.update = this.update.bind(this);\r\n\t\tGame.Render.app.ticker.add(this.update);\r\n\t}\r\n\tupdate() {\r\n\t\tlet { ctx, canvas, enabled, Game } = this;\r\n\t\tconst { Render } = Game;\r\n\t\tconst { camera, pixelRatio } = Render;\r\n\t\tlet canvWidth = canvas.width;\r\n\t\tlet canvHeight = canvas.height;\r\n\t\t\r\n\t\tconst { position:cameraPosition } = camera;\r\n\t\tconst scale = camera.scale * pixelRatio;\r\n\t\tlet translation = new vec({ x: -cameraPosition.x * scale + canvWidth/2, y: -cameraPosition.y * scale + canvHeight/2 });\r\n\r\n\t\tctx.clearRect(0, 0, canvWidth, canvHeight);\r\n\t\tctx.save();\r\n\t\tctx.translate(translation.x, translation.y);\r\n\t\tctx.scale(scale, scale);\r\n\r\n\t\tfor (let debugType in enabled) {\r\n\t\t\tif (enabled[debugType] && typeof this[debugType] === \"function\") {\r\n\t\t\t\tthis[debugType]();\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tctx.restore();\r\n\t}\r\n\r\n\t\r\n\tvertices() {\r\n\t\tconst { Game, ctx } = this;\r\n\t\tconst { camera, pixelRatio } = Game.Render;\r\n\t\tconst scale = camera.scale * pixelRatio;\r\n\r\n\t\tfunction renderVertices(vertices) {\r\n\t\t\tctx.moveTo(vertices[0].x, vertices[0].y);\r\n\r\n\t\t\tfor (let j = 0; j < vertices.length; j++) {\r\n\t\t\t\tif (j > 0) {\r\n\t\t\t\t\tlet vertice = vertices[j];\r\n\t\t\t\t\tctx.lineTo(vertice.x, vertice.y);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tctx.closePath();\r\n\t\t}\r\n\r\n\t\tctx.beginPath();\r\n\t\tlet allBodies = Game.World.bodies;\r\n\t\tfor (let body of allBodies) {\r\n\t\t\trenderVertices(body.vertices);\r\n\t\t}\r\n\t\tctx.lineWidth = 2 / scale;\r\n\t\tctx.strokeStyle = \"#FF832A\";\r\n\t\tctx.stroke();\r\n\t}\r\n\tcollisions() {\r\n\t\tconst { ctx, Game } = this;\r\n\t\tconst { globalPoints, globalVectors } = Game.World;\r\n\t\t\r\n\t\tif (globalPoints.length > 0) { // Render globalPoints\r\n\t\t\tctx.beginPath();\r\n\t\t\tfor (let i = 0; i < globalPoints.length; i++) {\r\n\t\t\t\tlet point = globalPoints[i];\r\n\t\t\t\tctx.moveTo(point.x, point.y);\r\n\t\t\t\tctx.arc(point.x, point.y, 2 / camera.scale, 0, Math.PI*2);\r\n\t\t\t\tctx.fillStyle = \"#e8e8e8\";\r\n\t\t\t}\r\n\t\t\tctx.fill();\r\n\t\t}\r\n\t\tif (globalVectors.length > 0) { // Render globalVectors\r\n\t\t\tctx.beginPath();\r\n\t\t\tfor (let i = 0; i < globalVectors.length; i++) {\r\n\t\t\t\tlet point = globalVectors[i].position;\r\n\t\t\t\tlet vector = globalVectors[i].vector;\r\n\t\t\t\tctx.moveTo(point.x, point.y);\r\n\t\t\t\tctx.lineTo(point.x + vector.x * 10 / camera.scale, point.y + vector.y * 10 / camera.scale);\r\n\t\t\t\tctx.strokeStyle = \"#FFAB2E\";\r\n\t\t\t\tctx.lineWidth = 3 / camera.scale;\r\n\t\t\t}\r\n\t\t\tctx.stroke();\r\n\t\t}\r\n\t}\r\n\tcenters() {\r\n\t\tconst { ctx, Game } = this;\r\n\t\tconst { camera } = Game.Render;\r\n\t\tctx.fillStyle = \"#FF832A\";\r\n\t\tlet allBodies = Game.World.bodies;\r\n\t\tctx.beginPath();\r\n\t\tfor (let body of allBodies) {\r\n\t\t\tif (body.children.size === 0 || true) {\r\n\t\t\t\tctx.moveTo(body.position.x, body.position.y);\r\n\t\t\t\tctx.arc(body.position.x, body.position.y, 2 / camera.scale, 0, Math.PI*2);\r\n\t\t\t}\r\n\t\t}\r\n\t\tctx.fill();\r\n\t}\r\n\tboundingBox() {\r\n\t\tconst { ctx, Game } = this;\r\n\t\tconst { World, Render } = Game;\r\n\t\tconst { camera } = Render;\r\n\t\tlet allBodies = World.bodies;\r\n\t\tlet allConstraints = World.constraints;\r\n\r\n\t\tctx.strokeStyle = \"#66666680\";\r\n\t\tctx.lineWidth = 1 / camera.scale;\r\n\r\n\t\tfor (let body of allBodies) {\r\n\t\t\tif (!body.children || body.children.size === 0) {\r\n\t\t\t\tlet bounds = body.bounds;\r\n\t\t\t\tlet width  = bounds.max.x - bounds.min.x;\r\n\t\t\t\tlet height = bounds.max.y - bounds.min.y;\r\n\r\n\t\t\t\tctx.beginPath();\r\n\t\t\t\tctx.strokeRect(bounds.min.x, bounds.min.y, width, height);\r\n\t\t\t}\r\n\t\t}\r\n\t\tctx.strokeStyle = \"#66666630\";\r\n\t\tfor (let constraint of allConstraints) {\r\n\t\t\tlet bounds = constraint.bounds;\r\n\t\t\tlet width  = bounds.max.x - bounds.min.x;\r\n\t\t\tlet height = bounds.max.y - bounds.min.y;\r\n\r\n\t\t\tctx.beginPath();\r\n\t\t\tctx.strokeRect(bounds.min.x, bounds.min.y, width, height);\r\n\t\t}\r\n\t}\r\n\tbroadphase(tree = this.Game.World.dynamicGrid) {\r\n\t\tconst { ctx, Game } = this;\r\n\t\tconst { camera } = Game.Render;\r\n\t\tlet size = tree.gridSize;\r\n\r\n\t\tctx.lineWidth = 0.4 / camera.scale;\r\n\t\tctx.strokeStyle = \"#D0A356\";\r\n\t\tctx.fillStyle = \"#947849\";\r\n\t\t\r\n\t\tObject.keys(tree.grid).forEach(n => {\r\n\t\t\tlet node = tree.grid[n];\r\n\t\t\tlet pos = tree.unpair(n).mult(size);\r\n\t\t\tctx.strokeRect(pos.x, pos.y, size, size);\r\n\t\t\tctx.globalAlpha = 0.003 * node.length;\r\n\t\t\tctx.fillRect(pos.x, pos.y, size, size);\r\n\t\t\tctx.globalAlpha = 1;\r\n\t\t});\r\n\t}\r\n}\r\n","const RenderMethods = require(\"../render/RenderMethods\");\r\n\r\nmodule.exports = class PerformanceRender {\r\n\tenabled = false;\r\n\tcanvas = null;\r\n\tctx = null;\r\n\tposition = new vec(20, 20);\r\n\tconstructor(Performance, Render) {\r\n\t\tthis.Performance = Performance;\r\n\r\n\t\t// Create canvas\r\n\t\tconst width  = this.width  = 100;\r\n\t\tconst height = this.height = 50;\r\n\t\tlet scale = this.scale = devicePixelRatio ?? 1;\r\n\t\tlet canvas = this.canvas = document.createElement(\"canvas\");\r\n\t\tthis.ctx = canvas.getContext(\"2d\");\r\n\t\tcanvas.style.position = \"absolute\";\r\n\t\tcanvas.style.zIndex = 2;\r\n\t\tcanvas.style.top =  \"20px\";\r\n\t\tcanvas.style.right = \"0px\";\r\n\t\tcanvas.style.left = \"unset\";\r\n\t\tcanvas.width =  scale * width;\r\n\t\tcanvas.height = scale * height;\r\n\t\tcanvas.style.background = \"transparent\";\r\n\t\tcanvas.style.pointerEvents = \"none\";\r\n\t\tcanvas.style.transformOrigin = \"top left\";\r\n\t\tcanvas.style.transform = `scale(${1 / scale}, ${1 / scale})`;\r\n\t\tdocument.body.appendChild(canvas);\r\n\r\n\t\t// Set up rendering\r\n\t\tthis.update = this.update.bind(this);\r\n\t\tRender.app.ticker.add(this.update);\r\n\t}\r\n\tupdate() {\r\n\t\tlet { canvas, ctx, enabled, Performance, scale, width, height } = this;\r\n\t\tlet { history } = Performance;\r\n\r\n\t\tctx.clearRect(0, 0, canvas.width, canvas.height);\r\n\t\tif (enabled) {\r\n\t\t\tctx.save();\r\n\t\t\tctx.scale(scale, scale);\r\n\r\n\t\t\t// background\r\n\t\t\tctx.beginPath();\r\n\t\t\tRenderMethods.roundedRect(width, height, new vec(width/2, height/2), 5, ctx);\r\n\t\t\tctx.fillStyle = \"#0D0D0De6\";\r\n\t\t\tctx.fill();\r\n\r\n\r\n\t\t\t// get fps stats\r\n\t\t\tlet maxFps = 0;\r\n\t\t\tlet minFps = Infinity;\r\n\t\t\tlet avgFps = (() => {\r\n\t\t\t\tlet v = 0;\r\n\t\t\t\tfor (let i = 0; i < history.fps.length; i++) {\r\n\t\t\t\t\tlet cur = history.fps[i];\r\n\t\t\t\t\tv += cur;\r\n\t\t\t\t\tmaxFps = Math.max(maxFps, cur);\r\n\t\t\t\t\tminFps = Math.min(minFps, cur);\r\n\t\t\t\t}\r\n\t\t\t\treturn v / history.fps.length;\r\n\t\t\t})();\r\n\t\t\tlet nearAvgFps = (() => {\r\n\t\t\t\tlet v = 0;\r\n\t\t\t\tlet n = Math.min(history.fps.length, 20);\r\n\t\t\t\tfor (let i = 0; i < n; i++) {\r\n\t\t\t\t\tlet cur = history.fps[i];\r\n\t\t\t\t\tv += cur;\r\n\t\t\t\t}\r\n\t\t\t\treturn v / n;\r\n\t\t\t})();\r\n\r\n\t\t\t// fps text\r\n\t\t\tctx.beginPath();\r\n\t\t\tctx.fillStyle = \"white\";\r\n\t\t\tctx.textAlign = \"right\";\r\n\t\t\tctx.font = `400 ${12}px Arial`;\r\n\t\t\tctx.fillText(`${Math.round(nearAvgFps)} fps`, width - 12, 5 + 12);\r\n\r\n\t\t\t\r\n\t\t\tif (history.fps.length > 10) { // fps graph\r\n\t\t\t\tlet range = 100;\r\n\t\t\t\tlet fpsRanges = {\r\n\t\t\t\t\tmin: Math.max(0, Math.min(minFps, avgFps - range)),\r\n\t\t\t\t\tmax: Math.max(maxFps, avgFps + range, 60),\r\n\t\t\t\t}\r\n\t\t\t\tconst fpsRange = fpsRanges.max - fpsRanges.min;\r\n\t\t\t\tlet bounds = {\r\n\t\t\t\t\tmin: new vec(10, 18),\r\n\t\t\t\t\tmax: new vec(width - 10, height - 4),\r\n\t\t\t\t};\r\n\r\n\t\t\t\tctx.beginPath();\r\n\t\t\t\tfunction getPosition(point, i) {\r\n\t\t\t\t\tlet x = bounds.max.x - (i / history.fps.length) * (bounds.max.x - bounds.min.x);\r\n\t\t\t\t\tlet y = bounds.max.y - ((point - fpsRanges.min) / fpsRange) * (bounds.max.y - bounds.min.y);\r\n\t\t\t\t\treturn [x, y];\r\n\t\t\t\t}\r\n\t\t\t\tctx.moveTo(...getPosition(history.fps[0], 0))\r\n\t\t\t\tfor (let i = 1; i < history.fps.length; i++) {\r\n\t\t\t\t\tctx.lineTo(...getPosition(history.fps[i], i));\r\n\t\t\t\t}\r\n\t\t\t\tctx.lineWidth = 1;\r\n\t\t\t\tctx.lineJoin = \"bevel\";\r\n\t\t\t\tctx.strokeStyle = \"#9C9C9C\";\r\n\t\t\t\tctx.stroke();\r\n\t\t\t}\r\n\r\n\t\t\t// colored rect\r\n\t\t\tctx.beginPath();\r\n\t\t\tlet colors = [[0.75, \"#3FF151\"], [0.5, \"#F5ED32\"], [0.25, \"#F89A2C\"], [0, \"#F74D4D\"]];\r\n\t\t\tlet boundMax = 60;\r\n\t\t\tctx.fillStyle = \"#808080\";\r\n\t\t\tfor (let color of colors) {\r\n\t\t\t\tif (avgFps >= color[0] * boundMax) {\r\n\t\t\t\t\tctx.fillStyle = color[1];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tRenderMethods.roundedRect(6, 6, new vec(15, 13), 2, ctx);\r\n\t\t\tctx.fill();\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tctx.restore();\r\n\t\t}\r\n\t}\r\n}\r\n","const Node = require(\"../node/Node.js\");\r\nconst vec = require(\"../geometry/vec.js\");\r\nconst Common = require(\"../core/Common.js\");\r\n\r\nmodule.exports = class PolygonRender extends Node {\r\n\tstatic defaultOptions = {\r\n\t\tcontainer: null, // {PIXI Container}\r\n\t\tlayer: 0, // {Number}\r\n\t\tposition: new vec(0, 0), // {vec}\r\n\t\tangle: 0, // {Number} [0, 2PI]\r\n\t\ttype: \"polygon\", // \"polygon\" | \"rectangle\" | \"circle\"\r\n\t\tvertices: [],\r\n\r\n\t\tvisible: true,\r\n\t\talpha: 1,\r\n\t\tbackground: \"transparent\",\r\n\t\tborder: \"transparent\",\r\n\t\tborderWidth: 3,\r\n\t\tborderOffset: 0.5,\r\n\t\tlineCap: \"butt\",\r\n\t\tlineJoin: \"miter\",\r\n\t\t\r\n\t\t// type: \"rectangle\" only options\r\n\t\twidth: 100,\r\n\t\theigth: 100,\r\n\t\tround: 0,\r\n\r\n\t\t// type: \"circle\" only options\r\n\t\tradius: 50,\r\n\t}\r\n\tstatic all = new Set();\r\n\r\n\tconstructor(options = {}) {\r\n\t\tsuper();\r\n\t\tlet defaults = { ...PolygonRender.defaultOptions };\r\n\t\tCommon.merge(defaults, options, 1);\r\n\t\toptions = defaults;\r\n\t\tCommon.merge(this, options, 1);\r\n\r\n\t\tthis.create();\r\n\t}\r\n\tcreate() {\r\n\t\tlet graphic = this.graphic = new PIXI.Graphics();\r\n\t\tlet { position, angle, type, vertices } = this;\r\n\t\tlet { layer, alpha, background, border, borderWidth, lineCap, lineJoin, borderOffset, round } = this;\r\n\t\tlet { parseColor } = Common;\r\n\t\t\r\n\t\tbackground = parseColor(background);\r\n\t\tif (background[1] > 0) graphic.beginFill(...background);\r\n\r\n\t\tborder = parseColor(border);\r\n\t\tif (border[1] > 0) {\r\n\t\t\tgraphic.lineStyle({\r\n\t\t\t\twidth: borderWidth,\r\n\t\t\t\tcolor: border[0],\r\n\t\t\t\talpha: border[1],\r\n\t\t\t\tcap: lineCap,\r\n\t\t\t\tjoin: lineJoin,\r\n\t\t\t\talignment: borderOffset,\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tif (type === \"rectangle\") {\r\n\t\t\tlet { width, height } = this;\r\n\t\t\t\r\n\t\t\tif (round > 0) {\r\n\t\t\t\tgraphic.drawRoundedRect(-width/2, -height/2, width, height, round);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tgraphic.drawRect(-width/2, -height/2, width, height);\r\n\t\t\t}\r\n\t\t}\r\n\t\telse if (type === \"circle\") {\r\n\t\t\tlet { radius } = this;\r\n\t\t\tgraphic.drawCircle(0, 0, radius);\r\n\t\t}\r\n\t\telse { // manually draw vertices\r\n\t\t\tlet center = Common.getCenterOfMass(vertices);\r\n\t\t\tgraphic.drawPolygon(vertices.map(vertice => vertice.sub(center)));\r\n\t\t\t// graphic.drawPolygon(vertices);\r\n\t\t}\r\n\t\tif (border[1] > 0) graphic.closePath();\r\n\t\tif (background[1] > 0) graphic.endFill();\r\n\t\tgraphic.zIndex = layer;\r\n\r\n\t\t// Translate to position\r\n\t\tlet translateDelta = new vec(position);\r\n\t\tthis.position = new vec(0, 0);\r\n\t\tthis.translate(translateDelta);\r\n\r\n\t\t// Rotate to angle\r\n\t\tthis.angle = 0;\r\n\t\tthis.translateAngle(angle);\r\n\r\n\t\t// Set alpha\r\n\t\tthis.setAlpha(alpha);\r\n\r\n\t\t// Trigger events\r\n\t\tthis.trigger(\"load\");\r\n\t}\r\n\r\n\t/**\r\n\t * Sets the render layer (z index)\r\n\t * @param {Number} layer - The render layer (z index) for the render\r\n\t */\r\n\tsetLayer(layer) {\r\n\t\tthis.layer = layer;\r\n\t\tthis.graphic.zIndex = layer;\r\n\t}\r\n\r\n\t/**\r\n\t * Sets the render's alpha\r\n\t * @param {Number} alpha - The opacity, between 0 and 1 inclusive\r\n\t */\r\n\tsetAlpha(alpha) {\r\n\t\tthis.alpha = alpha;\r\n\t\tthis.graphic.alpha = alpha;\r\n\t}\r\n\r\n\t/**\r\n\t * Changes if the render is visible\r\n\t * @param {Boolean} visible - If the render is visible\r\n\t */\r\n\tsetVisible(visible) {\r\n\t\tthis.visible = visible;\r\n\t\tthis.graphic.visible = visible;\r\n\t}\r\n\r\n\t/**\r\n\t * Shifts the render's position by `delta`\r\n\t * @param {vec} delta - Position render is shifted\r\n\t */\r\n\ttranslate(delta) {\r\n\t\tsuper.translate(delta);\r\n\r\n\t\tlet { graphic } = this;\r\n\t\tgraphic.position.x += delta.x;\r\n\t\tgraphic.position.y += delta.y;\r\n\t}\r\n\r\n\t/**\r\n\t * Rotates the render relative to current angle\r\n\t * @param {Number} angle - Amount to rotate render, in radians\r\n\t */\r\n\ttranslateAngle(angle) {\r\n\t\tlet { graphic } = this;\r\n\t\tthis.angle += angle;\r\n\t\tgraphic.rotation += angle;\r\n\t}\r\n\r\n\t/**\r\n\t * Adds the render object to the world\r\n\t */\r\n\tadd() {\r\n\t\tsuper.add();\r\n\t\tPolygonRender.all.add(this);\r\n\t\tthis.container.addChild(this.graphic);\r\n\t}\r\n\t/**\r\n\t * Removes the render object from the world\r\n\t */\r\n\tdelete() {\r\n\t\tsuper.delete();\r\n\t\tPolygonRender.all.delete(this);\r\n\t\tthis.container.removeChild(this.graphic);\r\n\t}\r\n\t\r\n\t/**\r\n\t * Destroys the render object. Use when you know the render will no longer be used\r\n\t */\r\n\tdestroy() {\r\n\t\tthis.graphic.destroy();\r\n\t}\r\n\r\n\t#events = {\r\n\t\tdelete: [],\r\n\t\tadd: [],\r\n\t\tload: [],\r\n\t}\r\n}\r\n","const Camera = require(\"../render/Camera.js\");\r\nconst Common = require(\"../core/Common.js\");\r\nconst vec = require(\"../geometry/vec.js\");\r\n\r\nmodule.exports = class Render {\r\n\tstatic defaultOptions = {\r\n\t\tbackground: false,\r\n\t\tpixelRatio: window.devicePixelRatio ?? 1,\r\n\t\tySort: false,\r\n\t\tresizeTo: window,\r\n\t\tantialias: true,\r\n\t\tgetBoundSize: function(width, height) {\r\n\t\t\treturn Math.sqrt(width ** 2 + height ** 2) || 1;\r\n\t\t}\r\n\t}\r\n\tapp = null;\r\n\tcamera = null;\r\n\tpixelRatio = 1;\r\n\tnodes = new Set();\r\n\tconstructor(options = {}) {\r\n\t\t// Test if PIXI is loaded\r\n\t\ttry { PIXI.settings; }\r\n\t\tcatch(err) {\r\n\t\t\tthrow new Error(\"PIXI is not defined\\nHelp: try loading pixi.js before creating a ter app\");\r\n\t\t}\r\n\r\n\t\t// Load options\r\n\t\tlet defaults = { ...Render.defaultOptions };\r\n\t\tlet resizeTo = options.resizeTo ?? defaults.resizeTo;\r\n\t\tdelete options.resizeTo;\r\n\t\tCommon.merge(defaults, options, 1);\r\n\t\toptions = defaults;\r\n\t\tlet { background, ySort, pixelRatio, antialias, getBoundSize } = options;\r\n\r\n\t\t// Create camera\r\n\t\tthis.camera = new Camera();\r\n\r\n\t\t// Setup bound size\r\n\t\tthis.getBoundSize = getBoundSize;\r\n\r\n\t\t// Set basic settings\r\n\t\tlet scale = PIXI.settings.RESOLUTION = PIXI.settings.FILTER_RESOLUTION = this.pixelRatio = pixelRatio;\r\n\t\tPIXI.Container.defaultSortableChildren = true\r\n\t\t\r\n\t\t// Create PIXI app\r\n\t\tlet app = this.app = new PIXI.Application({\r\n\t\t\tbackground: background ?? 0x0,\r\n\t\t\tbackgroundAlpha: (background && background != \"transparent\") ? 1 : 0,\r\n\t\t\tresizeTo: resizeTo ?? window,\r\n\t\t\tantialias: antialias ?? true,\r\n\t\t});\r\n\t\tdocument.body.appendChild(app.view);\r\n\t\tapp.ticker.add(this.update.bind(this)); // Start render\r\n\t\tapp.stage.filters = []; // Makes working with pixi filters easier\r\n\t\tapp.stage.sortableChildren = true; // Important so render layers work\r\n\r\n\t\t// Set up pixel ratio scaling\r\n\t\tlet view = app.view;\r\n\t\tview.style.transformOrigin = \"top left\";\r\n\t\tview.style.transform = `scale(${1 / scale}, ${1 / scale})`;\r\n\r\n\t\t// Make sure canvas stays correct size\r\n\t\tthis.setSize(app.screen.width, app.screen.height);\r\n\t\tapp.renderer.on(\"resize\", this.setSize.bind(this));\r\n\r\n\t\t// Set up y sorting if enabled\r\n\t\tif (ySort) {\r\n\t\t\tapp.stage.on(\"sort\", function beforeSort(sprite) {\r\n\t\t\t\tsprite.zOrder = sprite.y;\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\tsetSize(width, height) {\r\n\t\tlet pixelRatio = this.pixelRatio;\r\n\t\tthis.camera.boundSize = this.getBoundSize(width, height) * pixelRatio;\r\n\t}\r\n\tsetPixelRatio(pixelRatio) {\r\n\t\tthis.pixelRatio = pixelRatio;\r\n\t\tthis.setSize(this.app.screen.width, this.app.screen.height); // update bounds with new pixel ratio\r\n\t}\r\n\r\n\t/**\r\n\t * Adds all `children` to this Render\r\n\t * @param {...Renderable} children - The children to be added\r\n\t */\r\n\taddChild(...children) {\r\n\t\tfor (let child of children) {\r\n\t\t\tthis.nodes.add(child);\r\n\t\t}\r\n\t}\r\n\t/**\r\n\t * Removes all `children` from this Render\r\n\t * @param {...Renderable} children - The children to be removed\r\n\t */\r\n\tremoveChild(...children) {\r\n\t\tfor (let child of children) {\r\n\t\t\tthis.nodes.delete(child);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Updates renderer, its camera, and all render nodes attached to it. Triggers `beforeUpdate` and `afterUpdate` events on this Render. Also triggers `render` on nodes\r\n\t */\r\n\tupdate() {\r\n\t\tthis.trigger(\"beforeUpdate\");\r\n\r\n\t\tlet { app, camera } = this;\r\n\t\tlet { stage } = app;\r\n\t\tlet { position: cameraPosition, translation, fov, boundSize } = camera;\r\n\t\t\r\n\t\tlet screenSize = new vec(app.screen.width, app.screen.height);\r\n\t\ttranslation.set({ x: -cameraPosition.x * boundSize/fov + screenSize.x/2, y: -cameraPosition.y * boundSize/fov + screenSize.y/2 });\r\n\t\tcamera.scale = boundSize / fov;\r\n\r\n\t\tfor (let node of this.nodes) {\r\n\t\t\tif (node.render.graphic) {\r\n\t\t\t\tnode.render.graphic.update();\r\n\t\t\t\tnode.trigger(\"render\");\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\t// update camera position\r\n\t\tstage.x = translation.x;\r\n\t\tstage.y = translation.y;\r\n\t\tstage.scale.x = camera.scale;\r\n\t\tstage.scale.y = camera.scale;\r\n\r\n\t\tthis.trigger(\"afterUpdate\");\r\n\t}\r\n\r\n\t// - Events\r\n\t#events = {\r\n\t\tbeforeUpdate: [],\r\n\t\tafterUpdate: [],\r\n\t}\r\n\ton(event, callback) {\r\n\t\tif (this.#events[event]) {\r\n\t\t\tthis.#events[event].push(callback);\r\n\t\t}\r\n\t\telse {\r\n\t\t\tconsole.warn(event + \" is not a valid event\");\r\n\t\t}\r\n\t}\r\n\toff(event, callback) {\r\n\t\tevent = this.#events[event];\r\n\t\tif (event.includes(callback)) {\r\n\t\t\tevent.splice(event.indexOf(callback), 1);\r\n\t\t}\r\n\t}\r\n\ttrigger(event) {\r\n\t\t// Trigger each event\r\n\t\tif (this.#events[event]) {\r\n\t\t\tthis.#events[event].forEach(callback => {\r\n\t\t\t\tcallback();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n}\r\n","let RenderMethods = module.exports = {\r\n\t// ~ Point transformations\r\n\tscreenPtToGame: function(point, Render) {\r\n\t\tconst { camera, pixelRatio } = Render;\r\n\t\tconst { scale, translation } = camera;\r\n\t\treturn new vec((point.x * pixelRatio - translation.x) / scale, (point.y * pixelRatio - translation.y) / scale);\r\n\t},\r\n\tgamePtToScreen: function(point, Render) {\r\n\t\tconst { camera, pixelRatio } = Render;\r\n\t\tconst { scale, translation } = camera;\r\n\t\treturn new vec((point.x * scale + translation.x) / pixelRatio, (point.y * scale + translation.y) / pixelRatio);\r\n\t},\r\n\troundedPolygon: function(vertices, round, graphic) {\r\n\t\tif (vertices.length < 3) {\r\n\t\t\tconsole.warn(\"RenderMethods.roundedPolygon needs at least 3 vertices\", vertices);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tfunction getPoints(i) {\r\n\t\t\tlet curPt = vertices[i];\r\n\t\t\tlet lastPt = vertices[(vertices.length + i - 1) % vertices.length];\r\n\t\t\tlet nextPt = vertices[(i + 1) % vertices.length];\r\n\r\n\t\t\tlet lastDiff = lastPt.sub(curPt);\r\n\t\t\tlet nextDiff = curPt.sub(nextPt);\r\n\t\t\tlet lastLen = lastDiff.length;\r\n\t\t\tlet nextLen = nextDiff.length;\r\n\r\n\t\t\tlet curRound = Math.min(lastLen / 2, nextLen / 2, round);\r\n\t\t\tlet cp = curPt;\r\n\t\t\tlet pt1 = cp.add(lastDiff.normalize().mult(curRound));\r\n\t\t\tlet pt2 = cp.sub(nextDiff.normalize().mult(curRound));\r\n\r\n\t\t\treturn [pt1, cp, pt2];\r\n\t\t}\r\n\r\n\t\tlet start = getPoints(0);\r\n\t\tgraphic.moveTo(start[0].x, start[0].y);\r\n\t\tgraphic.quadraticCurveTo(start[1].x, start[1].y, start[2].x, start[2].y);\r\n\r\n\t\tfor (let i = 1; i < vertices.length; i++) {\r\n\t\t\tlet cur = getPoints(i);\r\n\t\t\tgraphic.lineTo(cur[0].x, cur[0].y);\r\n\t\t\tgraphic.quadraticCurveTo(cur[1].x, cur[1].y, cur[2].x, cur[2].y);\r\n\t\t}\r\n\r\n\t\tgraphic.lineTo(start[0].x, start[0].y);\r\n\t},\r\n\troundedPolygonCtx: function(vertices, round, ctx) {\r\n\t\tif (vertices.length < 3) {\r\n\t\t\tconsole.warn(\"RenderMethods.roundedPolygon needs at least 3 vertices\", vertices);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tfunction getPoints(i) {\r\n\t\t\tlet curPt = vertices[i];\r\n\t\t\tlet lastPt = vertices[(vertices.length + i - 1) % vertices.length];\r\n\t\t\tlet nextPt = vertices[(i + 1) % vertices.length];\r\n\r\n\t\t\tlet lastDiff = lastPt.sub(curPt);\r\n\t\t\tlet nextDiff = curPt.sub(nextPt);\r\n\t\t\tlet lastLen = lastDiff.length;\r\n\t\t\tlet nextLen = nextDiff.length;\r\n\r\n\t\t\tlet curRound = Math.min(lastLen / 2, nextLen / 2, round);\r\n\t\t\tlet cp = curPt;\r\n\t\t\tlet pt1 = cp.add(lastDiff.normalize().mult(curRound));\r\n\t\t\tlet pt2 = cp.sub(nextDiff.normalize().mult(curRound));\r\n\r\n\t\t\treturn [pt1, cp, pt2];\r\n\t\t}\r\n\r\n\t\tlet start = getPoints(0)\r\n\t\tctx.moveTo(start[0].x, start[0].y);\r\n\t\tctx.quadraticCurveTo(start[1].x, start[1].y, start[2].x, start[2].y);\r\n\r\n\t\tfor (let i = 1; i < vertices.length; i++) {\r\n\t\t\tlet cur = getPoints(i);\r\n\t\t\tctx.lineTo(cur[0].x, cur[0].y);\r\n\t\t\tctx.quadraticCurveTo(cur[1].x, cur[1].y, cur[2].x, cur[2].y);\r\n\t\t}\r\n\r\n\t\tctx.closePath();\r\n\t},\r\n\troundedRect: function(width, height, position, round, ctx) {\r\n\t\tRenderMethods.roundedPolygonCtx([\r\n\t\t\tnew vec(-width/2, -height/2).add2(position),\r\n\t\t\tnew vec( width/2, -height/2).add2(position),\r\n\t\t\tnew vec( width/2,  height/2).add2(position),\r\n\t\t\tnew vec(-width/2,  height/2).add2(position),\r\n\t\t], round, ctx);\r\n\t},\r\n\tarrow: function(position, direction, size = 10, ctx) {\r\n\t\tlet endPos = new vec(position.x + direction.x, position.y + direction.y);\r\n\t\tlet sideA = direction.rotate(Math.PI * 3/4).normalize2().mult(size);\r\n\t\tlet sideB = sideA.reflect(direction.normalize());\r\n\r\n\t\tctx.moveTo(position.x, position.y);\r\n\t\tctx.lineTo(endPos.x, endPos.y);\r\n\t\tctx.lineTo(endPos.x + sideA.x, endPos.y + sideA.y);\r\n\t\tctx.moveTo(endPos.x, endPos.y);\r\n\t\tctx.lineTo(endPos.x + sideB.x, endPos.y + sideB.y);\r\n\t},\r\n}\r\n","let Render = module.exports;\r\n\r\nRender.Polygon = require(\"../render/PolygonRender\");\r\nRender.Sprite = require(\"../render/Sprite\");\r\n","const Common = require(\"../core/Common.js\");\r\nconst Node = require(\"../node/Node.js\");\r\nconst vec = require(\"../geometry/vec.js\");\r\n\r\n// todo: load all sprites when game is loaded\r\n// todo: properly delete sprites when bodies no longer used\r\n\r\nmodule.exports = class Sprite extends Node {\r\n\tstatic imageDir = \"./img/\";\r\n\tstatic defaultOptions = {\r\n\t\tcontainer: null, // {PIXI Container}\r\n\t\tlayer: 0, // {Number}\r\n\t\tposition: new vec(0, 0), // {vec}\r\n\t\tangle: 0, // {Number} [0, 2PI]\r\n\r\n\t\tvisible: true,\r\n\t\talpha: 1,\r\n\t\tsrc: \"\",\r\n\t\t\r\n\t\tscale: new vec(1, 1),\r\n\t\twidth:  undefined,\r\n\t\theigth: undefined,\r\n\t}\r\n\tstatic all = new Set();\r\n\r\n\tloaded = false;\r\n\r\n\tconstructor(options) {\r\n\t\tsuper();\r\n\t\tlet defaults = { ...Sprite.defaultOptions };\r\n\t\tCommon.merge(defaults, options, 1);\r\n\t\toptions = defaults;\r\n\t\tCommon.merge(this, options, 1);\r\n\r\n\t\tthis.src = Sprite.imageDir + this.src;\r\n\t\tthis.position = new vec(this.position ?? { x: 0, y: 0 });\r\n\t\tthis.add = this.add.bind(this);\r\n\r\n\t\tthis.create();\r\n\t}\r\n\tcreate() {\r\n\t\tlet { width, height, layer, position, angle, src } = this;\r\n\t\tlet sprite = this.sprite = PIXI.Sprite.from(src);\r\n\t\tthis.loaded = true;\r\n\t\tsprite.anchor.set(0.5);\r\n\r\n\t\tif (width != undefined && height != undefined) {\r\n\t\t\tthis.setSize(width, height);\r\n\t\t}\r\n\r\n\t\t// Update alpha\r\n\t\tthis.setAlpha(this.alpha);\r\n\r\n\t\t// Update layer\r\n\t\tthis.setLayer(layer);\r\n\r\n\t\t// Translate to position\r\n\t\tlet translateDelta = new vec(position);\r\n\t\tthis.position.set(new vec(0, 0));\r\n\t\tthis.translate(translateDelta);\r\n\t\t\r\n\t\t// Rotate to angle\r\n\t\tthis.angle = 0;\r\n\t\tthis.translateAngle(angle);\r\n\r\n\t\t\r\n\t\tthis.trigger(\"load\");\r\n\t}\r\n\t\r\n\t/**\r\n\t * Sets the render layer (z index)\r\n\t * @param {Number} layer - The render layer (z index) for the render\r\n\t */\r\n\tsetLayer(layer) {\r\n\t\tthis.layer = layer;\r\n\t\tif (!this.loaded) return;\r\n\t\tthis.sprite.zIndex = layer;\r\n\t}\r\n\r\n\t/**\r\n\t * Sets the sprite's scale\r\n\t * @param {vec} scale - The new scale\r\n\t */\r\n\tsetScale(scale) {\r\n\t\tthis.scale.set(scale);\r\n\r\n\t\tif (!this.loaded) return;\r\n\t\tlet { sprite } = this;\r\n\t\tsprite.scale.x = this.scale.x;\r\n\t\tsprite.scale.y = this.scale.y;\r\n\t}\r\n\r\n\t/**\r\n\t * Sets the sprite's width and height\r\n\t * @param {Number} width - The new width\r\n\t * @param {Number} height - The new height\r\n\t */\r\n\tsetSize(width, height) {\r\n\t\tif (width != undefined) this.width = width;\r\n\t\tif (height != undefined) this.height = height;\r\n\r\n\t\tif (!this.loaded) return;\r\n\t\tlet { sprite } = this;\r\n\t\tsprite.width =  this.width;\r\n\t\tsprite.height = this.height;\r\n\t}\r\n\r\n\t/**\r\n\t * Sets the sprite's alpha\r\n\t * @param {Number} alpha - The opacity, between 0 and 1 inclusive\r\n\t */\r\n\tsetAlpha(alpha) {\r\n\t\tthis.alpha = alpha;\r\n\t\tif (!this.loaded) return;\r\n\t\tthis.sprite.alpha = alpha;\r\n\t}\r\n\r\n\t/**\r\n\t * Changes if the sprite is visible\r\n\t * @param {Boolean} visible - If the sprite is visible\r\n\t */\r\n\tsetVisible(visible) {\r\n\t\tthis.visible = visible;\r\n\t\tif (!this.loaded) return;\r\n\t\tthis.sprite.visible = visible;\r\n\t}\r\n\r\n\t/**\r\n\t * Shifts the sprite's position by `delta`\r\n\t * @param {vec} delta - Amount sprite is shifted by\r\n\t */\r\n\ttranslate(delta) {\r\n\t\tsuper.translate(delta);\r\n\r\n\t\tif (!this.loaded) return;\r\n\t\tlet { sprite } = this;\r\n\t\tsprite.position.x += delta.x;\r\n\t\tsprite.position.y += delta.y;\r\n\t}\r\n\t\r\n\t/**\r\n\t * Rotates the sprite relative to current angle\r\n\t * @param {Number} angle - Amount to rotate sprite, in radians\r\n\t */\r\n\ttranslateAngle(angle) {\r\n\t\tsuper.translateAngle(angle);\r\n\r\n\t\tif (!this.loaded) return;\r\n\t\tlet { sprite } = this;\r\n\t\tsprite.rotation += angle;\r\n\t}\r\n\r\n\t/**\r\n\t * Adds the sprite to the world\r\n\t */\r\n\tadd() {\r\n\t\tif (!this.sprite && this.added) {\r\n\t\t\tthis.on(\"load\", this.add);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tsuper.add();\r\n\t\tSprite.all.add(this);\r\n\t\tthis.container.addChild(this.sprite);\r\n\t}\r\n\t\r\n\t/**\r\n\t * Removes the sprite from the world\r\n\t */\r\n\tdelete() {\r\n\t\tsuper.delete();\r\n\t\tSprite.all.delete(this);\r\n\t\tthis.container.removeChild(this.sprite);\r\n\t\t\r\n\t\tthis.off(\"load\", this.add);\r\n\t}\r\n\t\r\n\t/**\r\n\t * Destroys the sprite. Use when you know the sprite will no longer be used\r\n\t */\r\n\tdestroy() {\r\n\t\tthis.sprite.destroy();\r\n\t}\r\n\r\n\r\n\t#events = {\r\n\t\tload: [],\r\n\t\tadd: [],\r\n\t\tdelete: [],\r\n\t}\r\n}\r\n","let ter = module.exports;\r\n\r\nter.Performance = require(\"./core/Performance\");\r\nter.Game = require(\"./core/Game\");\r\nter.Common = require(\"./core/Common\");\r\nter.Ticker = require(\"./core/Ticker\");\r\n\r\n\r\nter.Node = require(\"./node/Node\");\r\nter.World = require(\"./node/World\");\r\n\r\nter.Engine = require(\"./physics/Engine\");\r\nter.Bodies = require(\"./bodies/Bodies\");\r\n\r\nter.Render = require(\"./render/RenderTypes\");\r\n\r\nvec = require(\"./geometry/vec\");\r\nter.Grid = require(\"./geometry/Grid\");\r\nter.Bezier = require(\"./geometry/Bezier\");\r\nter.Bounds = require(\"./geometry/Bounds\");\r\n\r\nter.simplexNoise = require(\"./lib/simplexNoise\");\r\nter.polyDecomp = require(\"./lib/poly-decomp\");\r\n\r\nter.BehaviorTree = require(\"./extra/BehaviorTree\");\r\nter.Functions = require(\"./extra/GameFunctions\");\r\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// startup\n// Load entry module and return exports\n// This entry module is referenced by other modules so it can't be inlined\nvar __webpack_exports__ = __webpack_require__(\"./src/ter.js\");\n"],"names":["root","factory","exports","module","define","amd","self","Bodies","isClass","RigidBody","Rectangle","createBodyFactory","Engine","type","args","vec","PolygonRender","Sprite","createVertices","width","height","constructor","position","options","super","this","addPolygonRender","container","render","vertices","added","add","addChild","addSprite","Common","clamp","x","min","max","Math","angleDiff","angle1","angle2","a","PI","b","floor","modDiff","y","m","pair","unpair","n","z","sqrt","l","pairCommon","getCenterOfMass","centroid","det","tempDet","numVertices","length","i","curVert","nextVert","add2","div2","parseColor","originalColor","color","alpha","slice","parseInt","indexOf","split","map","value","toString","padStart","join","pop","merge","objA","objB","maxDepth","Infinity","hash","WeakSet","Object","keys","forEach","option","Array","isArray","has","obj","isCtorClass","substring","undefined","prototype","isPrototypeCtorClass","lineIntersects","a1","a2","b1","b2","d","nx","ny","pt","withinX","withinY","lineIntersectsBody","body","children","child","rayNormalized","sub","normalize","rayAxes","normal","rayVertices","SAT","verticesA","verticesB","axes","axis","boundsA","boundsB","vertice","projected","dot","minVertice","getRayNearbyStaticBodies","start","end","World","grid","staticGrid","size","gridSize","bounds","floor2","bodies","Set","node","getRayNearbyDynamicBodies","dynamicGrid","raycast","minDist","minPt","minBody","minVert","len","intersection","dist","collision","distance","point","verticeIndex","raycastSimple","boundCollision","pointInBounds","arrayDelete","array","index","splice","Render","DebugRender","PerformanceRender","Ticker","Game","static","defaultOptions","defaults","createDebugRender","Performance","enabled","getAvgs","lastUpdate","fps","delta","frame","history","avgFps","avgDelta","engine","performance","now","update","curTime","push","shift","v","pauseOnFreeze","freezeThreshold","tick","bind","window","addEventListener","trigger","requestAnimationFrame","beforeTick","afterTick","on","event","callback","console","warn","off","includes","BehaviorTree","call","name","resolve","blackboard","tree","globalTrees","Error","then","result","parse","nodeType","tmp","nodes","registerType","_class","registerTree","head","id","interrupt","FAILURE","Composite","hasInterrupt","Sequence","Promise","next","SUCCESS","Selector","reject","Decorator","Inverter","Number","Succeeder","Repeat","count","curCount","maxCount","RepeatUntilFail","Leaf","getVoronoiRegion","vertToNext","vertToPoint","outside","vpDotAxis","within","lastAxis","closestPointBetweenBodies","bodyA","bodyB","minDistance","verticeA","region","pointBA","mult","closestEdgeBetweenBodies","curNormal","prev","axisA","axisB","createGradient","startPosition","endPosition","colorStops","gradient","ctx","createLinearGradient","colorStop","addColorStop","createRadialGradient","radius","createElement","properties","elem","document","addProperties","property","Element","classes","className","classList","appendChild","gaussianRandom","mean","stdev","random","u","log","cos","createSeededRandom","seed","mask","m_w","m_z","setCSSVariable","varName","style","setProperty","boundedRandom","boundedRandomPoint","getMovementDirections","direction","threshold","directionNames","right","left","down","up","setMovementDirections","controls","directions","controlName","createTilingArea","areaBody","sprite","texture","PIXI","Texture","from","angle","setAngle","tiling","TilingSprite","zIndex","mainWorld","spritePos","curPosition","rotate","rotation","set","delete","removeChild","destroy","pt1","cp1","cp2","pt2","c","getLength","getAtT","t","dt","lastPt","get","getDxAtT","getDx","getDx2AtT","getDx2","beginPath","moveTo","lineTo","strokeStyle","lineWidth","camera","scale","stroke","renderDx","toObject","minX","minY","maxX","maxY","randomPoint","Grid","gridIds","pos","sqrtz","sqz","result1","getBounds","div","getBucketIds","ids","addBody","_Grids","removeBody","addPoint","bucketPos","removePoint","updateBody","curNodes","oldNodes","sin","vec2","sub2","mult2","pow","pow2","sign","sign2","mod","mod2","cross","avg","weight","weight2","atan2","area","manhattan","abs","abs2","reflect","v2","reflect2","rotate2","project","bound","d1","d2","project2","normalize2","normal2","ceil","ceil2","round","round2","min2","max2","clamp2","equals","toStringInt","toArray","isNaN","lineInt","l1","l2","precision","c1","c2","scalar_eq","lineSegmentsIntersect","p1","p2","q1","q2","dx","dy","da","db","s","triangleArea","isLeft","isLeftOn","isRight","isRightOn","decomp","polygon","edges","polygonGetCutEdges","polygonSlice","quickDecomp","polygonQuickDecomp","reflexVertices","steinerPoints","maxlevel","level","upperInt","lowerInt","p","upperDist","lowerDist","closestDist","upperIndex","lowerIndex","closestIndex","lowerPoly","upperPoly","poly","polygonIsReflex","MAX_VALUE","j","polygonAt","getIntersectionPoint","sqdist","polygonAppend","polygonCanSee2","isSimple","path","removeCollinearPoints","num","collinear","removeDuplicatePoints","pi","points_eq","makeCCW","br","N","polygonReverse","tmpPoint1","tmpPoint2","thresholdAngle","ab","bc","magA","magB","acos","to","tmpLine1","tmpLine2","polygonCanSee","polygonCopy","targetPoly","polygonClear","k","tmp1","tmp2","tmpPoly","nDiags","cutEdges","polys","cutEdge","global","noise","Grad","dot2","dot3","grad3","perm","gradP","F2","G2","G3","fade","lerp","simplex2","xin","yin","i1","j1","x0","y0","x1","y1","x2","y2","gi0","gi1","gi2","t0","t1","t2","simplex3","zin","k1","i2","j2","k2","z0","z1","z2","x3","y3","z3","gi3","t3","perlin2","X","Y","n00","n01","n10","n11","perlin3","Z","n000","n001","n010","n011","n100","n101","n110","n111","w","Node","getUniqueId","setPosition","translate","positionDelta","translateAngle","gravity","timescale","time","constraints","pairs","globalPoints","globalVectors","canCollide","filterA","filterB","layer","layerA","maskA","layerB","maskB","hasCollisions","isStatic","parent","collisionFilter","collisionPairs","pairIds","dynamicBuckets","staticBuckets","bucketIds","curDynamicBucket","curStaticBucket","curPairs","curPair","substeps","velocityIterations","positionIterations","constraintIterations","maxShare","mutableProperties","propertyName","step","_update","collides","createPair","_preUpdate","solveVelocity","solvePositions","solveConstraints","getAllSupports","maxDist","_lastSeparations","supportsA","supportsB","_axes","normalPoint","contactBody","normalBody","minDepth","contacts","numContacts","findNormal","curVertice","nextVertice","support","_getSupport","containsPoint","vector","pairId","depth","penetration","totalContacts","tangent","cleansePair","isSensor","restitution","relVel","velocity","friction","slop","_slop","impulse","angImpulseA","angImpulseB","totalMass","mass","shareA","shareB","offsetA","offsetB","vpA","angularVelocity","vpB","relativeVelocity","normalVelocity","tangentVelocity","oAcN","oBcN","share","_inverseMass","_inverseInertia","normalImpulse","tangentImpulse","curImpulse","constraint","stiffness","angularStiffness","ignoreSlack","pointA","pointB","diff","solveImpulse","offset","offsetLen","vp1","vp2","angularImpulse","impulseDiff","impulsePtA","impulsePtB","impulseA","impulseB","updateBounds","Bezier","Bounds","frictionAir","frictionAngular","roundVertices","newVertices","verticesLength","cur","prevToCur","curToNext","prevCurNormalized","curNextNormalized","prevRound","nextRound","curRound","bezier","filterType","roundQuality","_resetVertices","_updateInertia","setStatic","lastStatic","removed","setCollisions","_ignoreChildren","affectPosition","ignoreChildren","silent","rotationPoint","vert","posOffset","setVelocity","error","setAngularVelocity","applyForce","force","applyTorque","torque","_last","center","inertia","collisionStart","collisionActive","collisionEnd","bodyEnter","bodyInside","bodyExit","beforeUpdate","duringUpdate","lastVelocity","lastAngularVelocity","numerator","denominator","last","curSign","verts","concaveVertices","parentCenter","FromVertices","forceCCW","mapped","sort","reverse","bestVert","bestDist","fov","translation","boundSize","canvas","collisions","boundingBox","centers","broadphase","devicePixelRatio","getContext","top","innerWidth","innerHeight","background","pointerEvents","transformOrigin","transform","app","renderer","ticker","pixelRatio","canvWidth","canvHeight","cameraPosition","clearRect","save","debugType","restore","renderVertices","closePath","allBodies","arc","fillStyle","fill","allConstraints","strokeRect","globalAlpha","fillRect","RenderMethods","roundedRect","maxFps","minFps","nearAvgFps","textAlign","font","fillText","range","fpsRanges","fpsRange","getPosition","lineJoin","colors","boundMax","visible","border","borderWidth","borderOffset","lineCap","heigth","create","graphic","Graphics","beginFill","lineStyle","cap","alignment","drawRoundedRect","drawRect","drawCircle","drawPolygon","endFill","translateDelta","setAlpha","setLayer","setVisible","all","load","Camera","ySort","resizeTo","antialias","getBoundSize","settings","err","RESOLUTION","FILTER_RESOLUTION","Container","defaultSortableChildren","Application","backgroundAlpha","view","stage","filters","sortableChildren","setSize","screen","zOrder","setPixelRatio","screenSize","afterUpdate","screenPtToGame","gamePtToScreen","roundedPolygon","getPoints","curPt","nextPt","lastDiff","nextDiff","lastLen","nextLen","cp","quadraticCurveTo","roundedPolygonCtx","arrow","endPos","sideA","sideB","Polygon","src","loaded","imageDir","anchor","setScale","ter","simplexNoise","polyDecomp","Functions","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","__webpack_modules__"],"sourceRoot":""}